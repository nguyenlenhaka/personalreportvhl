<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>Dá»° TÃNH THU NHáº¬P â€“ VÃ¹ng Háº±ng LÃ¢m</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit-cover" />
  
  <!-- Logo vÃ  Favicon -->
  <link rel="icon" type="image/webp" href="../logo.webp" />
  <link rel="apple-touch-icon" href="../logo.webp" />
  <meta name="msapplication-TileImage" content="../logo.webp" />
  <meta property="og:image" content="../logo.webp" />
  <meta name="twitter:image" content="../logo.webp" />

  <!-- Font cá»§a dá»± Ã¡n -->
  <link rel="stylesheet" href="fonts/fonts.css" />
  <!-- Tailwind (chá»‰ dÃ¹ng utility nhá») -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    :root{
      --sidebar-width: 360px;
      --header-h: 64px;
      --footer-h: 66px;
      --toc-h: 0px;          /* chiá»u cao dropdown mobile (tá»± tÃ­nh báº±ng JS) */
      --brand:#059669; 
      --accent:#00a758;
      
      /* TÃ¹y biáº¿n responsive cho táº¥t cáº£ thiáº¿t bá»‹ */
      --mobile-breakpoint: 1023px;
      --tablet-breakpoint: 768px;
      --small-mobile: 480px;
      --large-desktop: 1440px;
      
      /* TÃ¹y biáº¿n spacing */
      --safe-area-top: env(safe-area-inset-top, 0px);
      --safe-area-bottom: env(safe-area-inset-bottom, 0px);
      --safe-area-left: env(safe-area-inset-left, 0px);
      --safe-area-right: env(safe-area-inset-right, 0px);
      
      /* TÃ¹y biáº¿n z-index */
      --z-header: 1000;
      --z-banner: 999;
      --z-toc: 996;
      --z-content: 1;
      --z-footer: 950;
      --z-support: 940;
      --z-loading: 10000;
    }
    /* Ä‘áº£m báº£o khÃ´ng trÃ n ngang trÃªn má»i thiáº¿t bá»‹ */
    html,body{height:100%;margin:0;background:#f3f4f6;overflow-x:hidden}
    *{box-sizing:border-box;min-width:0}

    /* ===== HEADER (FIXED) ===== */
    .app-header{
      position:fixed; top:0; left:0; right:0; z-index:var(--z-header);
      background:#e8fff3; border-bottom:1px solid #d9f7e6;
      padding-top:var(--safe-area-top);
    }
    /* header chia 2 khu: brand (logo+tÃªn) vÃ  login */
    .header-grid{
      display:grid; grid-template-columns: 1fr auto;
      align-items:center; gap:12px; padding:10px 12px;
    }
    .brand-row{
      display:flex; align-items:center; gap:10px; min-width:0;
    }
    .logo-d{ height:70px; width:auto; display:block; flex:0 0 auto; }

    /* TiÃªu Ä‘á»: cho phÃ©p xuá»‘ng dÃ²ng, khÃ´ng cáº¯t dáº¥u */
    .title-wrap{ display:flex; flex-direction:column; gap:2px; min-width:0; }
    .title-top,.title-main{
      font-family:'Manulife JH Sans','ManulifeJHSans',system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif;
      color:var(--brand); font-weight:800;
      white-space:normal; overflow:visible; text-overflow:clip;
      word-break:keep-all; line-height:1.25; padding-block:2px;
    }
    .title-top{  font-size:clamp(14px, 1vw + 10px, 22px); text-transform:uppercase; }
    .title-main{ font-size:clamp(18px, 1.8vw + 12px, 34px); }

    /* ===== LOGIN / LOGOUT ===== */
    .login-cluster{ 
      display: flex; 
      gap: 16px; 
      align-items: flex-end;
      justify-self: end;
    }
    
    .input-group {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    
    .password-input-wrapper {
      position: relative;
      display: inline-block;
    }
    
    .login-cluster input{ 
      height: 44px; 
      padding: 0 12px; 
      font-size: 16px; 
      border: 1.3px solid #b7e7ce; 
      border-radius: 10px; 
      background: #effaf3; 
      font-weight: 600; 
      color: #0d7233; 
      outline: none; 
      width: 180px;
    }
    
    .login-btn{ 
      height: 44px; 
      padding: 0 18px; 
      background: #008a53; 
      color: #fff; 
      border: none; 
      border-radius: 10px; 
      font-weight: 800; 
      cursor: pointer; 
      touch-action: manipulation;
      min-width: 140px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }
    
    .login-btn:hover{ background: #066a42; }
    
    .toggle-password {
      position: absolute;
      right: 8px;
      top: 50%;
      transform: translateY(-50%);
      background: none;
      border: none;
      cursor: pointer;
      padding: 4px;
      border-radius: 4px;
      font-size: 16px;
      color: #666;
      transition: background-color 0.2s;
    }
    
    .toggle-password:hover {
      background-color: rgba(0, 0, 0, 0.1);
    }
    
    .password-input-wrapper input[type="password"] {
      padding-right: 40px;
    }
    
    /* áº¨n nÃºt toggle khi Ä‘Ã£ Ä‘Äƒng nháº­p */
    body.logged-in .toggle-password {
      display: none !important;
    }
    
    /* áº¨n nÃºt toggle khi Ä‘Ã£ Ä‘Äƒng nháº­p */
    body.logged-in .password-input-wrapper input {
      padding-right: 12px;
    }
    
    .logout-only{ display:none !important; }
    body.logged-in .login-only{ display:none !important; }
    body.logged-in .logout-only{ display:block !important; }

    /* ===== SIDEBAR (DESKTOP) ===== */
    #sidebar{
      position:fixed; left:0; top:var(--header-h); bottom:var(--footer-h);
      width:var(--sidebar-width); background:#fff; border-right:1px solid #e5e7eb; z-index:900;
      overflow-y:auto; overflow-x:hidden; display:none;
    }
    .sidebar-inner{ padding:12px; }
    .menu-title{ font-weight:900; color:#065f46; margin:6px 8px 8px; white-space:normal; line-height:1.25; }
    .menu-group{ margin:12px 0 6px 8px; font-weight:900; color:#0b3d2c; white-space:normal; line-height:1.25; }
    .menu-item{
      display:block; padding:.55rem .75rem; border-radius:.55rem; font-weight:800; color:#0b3d2c;
      white-space:normal; overflow-wrap:anywhere; word-break:break-word; line-height:1.25; font-size:0.96rem;
    }
    .menu-item:hover{ background:#e5f7ee; }
    .menu-item.active{ background:#0ea35b; color:#fff; }
    .submenu{ margin:.25rem 0 .5rem .75rem; }
    .submenu .menu-item{ padding:.45rem .6rem; }

    /* ===== SIDEBAR UPDATE INFO ===== */
    .sidebar-update-info {
      background: #f0f9ff;
      color: #0b3d2c;
      padding: 8px 12px;
      margin: 0 0 12px 0;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 600;
      border-left: 4px solid #0ea35b;
      line-height: 1.3;
    }

    /* ===== DESKTOP UPDATE DATE ===== */
    .desktop-update-date {
      background: #fef3c7;
      color: #92400e;
      padding: 6px 12px;
      margin: 0 0 12px 0;
      border-radius: 6px;
      font-size: 13px;
      font-weight: 600;
      border-left: 4px solid #f59e0b;
      line-height: 1.3;
      text-align: center;
    }

    /* ===== WELCOME BANNER ===== */
    .welcome-banner {
      position: fixed;
      top: var(--header-h);
      left: var(--sidebar-width);
      right: 0;
      z-index: var(--z-banner);
      margin-bottom: 0px;
      background: linear-gradient(135deg, #059669 0%, #00a758 100%);
      color: white;
      padding: 8px 20px;
      text-align: center;
      font-weight: 700;
      font-size: 16px;
      display: none;
      box-shadow: 0 1px 4px rgba(5, 150, 105, 0.2);
      line-height: 1.2;
      pointer-events: none; /* KhÃ´ng cháº·n click events */
    }

    /* ===== MOBILE UPDATE DATE ===== */
    .mobile-update-date {
      position: fixed;
      top: calc(var(--header-h) + 40px);
      left: 0;
      right: 0;
      z-index: var(--z-toc);
      background: #fff;
      color: #0b3d2c;
      padding: 8px 20px;
      text-align: center;
      font-weight: 700;
      font-size: 14px;
      border-bottom: 1px solid #e5e7eb;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      display: none;
    }

    /* ===== LOADING SCREEN ===== */
    .loading-screen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255, 255, 255, 0.95);
      z-index: var(--z-loading); /* Cao hÆ¡n header vÃ  banner */
      display: flex;
      align-items: center;
      justify-content: center;
      backdrop-filter: blur(5px);
    }

    .loading-content {
      text-align: center;
      background: white;
      padding: 40px;
      border-radius: 16px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.1);
    }

    .loading-spinner {
      width: 48px;
      height: 48px;
      border: 4px solid #e5e7eb;
      border-top: 4px solid var(--brand);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }

    .loading-text {
      font-size: 18px;
      font-weight: 600;
      color: #374151;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* ===== MOBILE TOC (DANH Má»¤C DROPDOWN) =====
       LuÃ´n treo dÆ°á»›i header -> fixed + top = --header-h */
    #tocMobile{
      position:fixed; top:calc(var(--header-h) + 40px + 40px); left:0; right:0; z-index:var(--z-toc);
      background:#fff; padding:10px 10px 6px;
      border-bottom:1px solid #e5e7eb; display:none;
      will-change:top;
    }
    #tocMobile .row{ display:flex; gap:8px; }
    
    /* NÃºt danh má»¥c mobile */
    .mobile-menu-btn {
      flex: 1;
      height: 44px;
      border: 1px solid #c7d5e6;
      border-radius: 10px;
      padding: 0 15px;
      font-weight: 800;
      color: #00519c;
      background: #eff5ff;
      font-size: 16px;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .mobile-menu-btn:hover {
      background: #e0f2fe;
      border-color: #0ea5e9;
    }
    
    /* NÃºt Ä‘Äƒng xuáº¥t mobile */
    .mobile-logout-btn {
      height: 44px;
      border: 1px solid #dc2626;
      border-radius: 10px;
      padding: 0 15px;
      font-weight: 800;
      color: #fff;
      background: #dc2626;
      font-size: 16px;
      cursor: pointer;
      transition: all 0.3s ease;
      white-space: nowrap;
    }
    
    .mobile-logout-btn:hover {
      background: #b91c1c;
      border-color: #b91c1c;
    }
    
    /* Mobile menu dropdown */
    .mobile-menu-dropdown {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: #fff;
      border: 1px solid #e5e7eb;
      border-radius: 10px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      z-index: 1000;
      margin-top: 5px;
    }
    
    .mobile-menu-content {
      padding: 8px 0;
    }
    
    .mobile-menu-item {
      display: block;
      padding: 12px 16px;
      color: #0b3d2c;
      text-decoration: none;
      font-weight: 600;
      font-size: 14px;
      border-bottom: 1px solid #f3f4f6;
      transition: background-color 0.2s;
    }
    
    .mobile-menu-item:last-child {
      border-bottom: none;
    }
    
    .mobile-menu-item:hover {
      background-color: #f9fafb;
    }

    /* ===== CONTENT ===== */
    /* chá»«a chá»— dÆ°á»›i header + dropdown mobile (náº¿u cÃ³) */
    body{ padding-top: calc(var(--header-h) + var(--toc-h) + 8px); }
    
    /* Chá»«a chá»— cho banner khi Ä‘Ã£ Ä‘Äƒng nháº­p */
    body.logged-in{ padding-top: calc(var(--header-h) + 40px + var(--toc-h) + 8px); }
    
    /* Chá»«a chá»— cho update date trÃªn mobile */
    body.logged-in.mobile{ padding-top: calc(var(--header-h) + 40px + 40px + var(--toc-h) + 8px); }
    
    /* Chá»«a chá»— cho TOC mobile khi Ä‘Ã£ Ä‘Äƒng nháº­p */
    body.logged-in{ padding-top: calc(var(--header-h) + 40px + 40px + var(--toc-h) + 8px); }
    /* chá»«a chá»— cho footer */
    body{ padding-bottom: calc(2.25 * var(--footer-h) + var(--safe-area-bottom)); }

    #contentWrap{ margin-left:0; }
    body.sidebar-open #contentWrap{ margin-left:var(--sidebar-width); }
    main{ max-width:1200px; margin:0 auto; padding:14px; }

    /* áº¨n toÃ n bá»™ pháº§n ngoÃ i header khi chÆ°a login */
    body.logged-out #sidebar,
    body.logged-out #tocMobile,
    body.logged-out #contentWrap,
    body.logged-out #supportDesk { display:none !important; }
    
    /* áº¨n TOC khi chÆ°a Ä‘Äƒng nháº­p trÃªn cáº£ desktop vÃ  mobile */
    body.logged-out #tocMobile { display:none !important; }
    
    /* Hiá»ƒn thá»‹ nÃºt há»— trá»£ mobile khi chÆ°a Ä‘Äƒng nháº­p - náº±m trÃªn footer */
    body.logged-out #tocMobile::after {
      content: "Há»— trá»£";
      display: inline-flex;
      align-items: center;
      justify-content: center;
      height: 44px;
      padding: 0 14px;
      background: #00a758;
      color: #fff;
      border-radius: 10px;
      text-decoration: none;
      font-weight: 900;
      white-space: nowrap;
      position: fixed;
      right: 10px;
      bottom: calc(var(--footer-h) + 14px);
      z-index: var(--z-support);
    }
    
    /* áº¨n nÃºt há»— trá»£ cÅ© khi Ä‘Ã£ Ä‘Äƒng nháº­p */
    body.logged-in #tocMobile::after {
      display: none !important;
    }

    .section-title{
      background:#fff; padding:12px 16px; border-left:6px solid #0ea35b; border-radius:8px;
      font-weight:900; color:#0b3d2c; margin:6px 0 14px;
    }

    :root{ --pad:18px; }
    .top-fields,.top-fields-2{display:grid;grid-template-columns:repeat(12,1fr);gap:16px;align-items:end;margin:10px var(--pad)}
    .top-fields-2{margin-bottom:8px}
    .field{grid-column:span 4;display:flex;flex-direction:column;min-width:0}
    .field label{font-size:1.05rem;font-weight:800;color:#0b3d2c;margin:0 0 6px 2px;line-height:1.2;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .field input,.field select{
      height:46px;padding:0 12px;font-size:16px;border:1.3px solid #b7e7ce;border-radius:8px;background-color:#effaf3;
      font-weight:800;color:#0d7233;text-align:center
    }
    .field input[readonly]{background:#f8f9fa;color:#0ea35b;border-color:#dee2e6}
    .gd-stage>b{display:block;margin:6px var(--pad);font-weight:900;color:#0b3d2c;}
    .summary-row{display:grid;grid-template-columns:repeat(12,1fr);gap:18px;align-items:end;margin:16px var(--pad) 8px}
    .summary-block{grid-column:span 6;text-align:center;min-width:0}
    .summary-block label{color:#0b3d2c;font-weight:900;letter-spacing:.02em;display:block;margin-bottom:6px;text-transform:uppercase;font-size:.95rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .summary-block input{background:#f5fffb;color:#00a758;border:2px solid #00a758;border-radius:10px;font-size:16px;font-weight:900;height:56px;text-align:center;width:100%}
    .calc-wrap{display:flex;align-items:center;gap:10px}
    #calc-btn{background:#059669;color:#fff;border:none;border-radius:12px;padding:14px 24px;font-size:18px;font-weight:800;box-shadow:0 6px 18px rgba(0,81,193,.25);white-space:nowrap;cursor:pointer;touch-action:manipulation}
#calc-btn:hover{background:#00a758}

    /* ===== SMALL MOBILE ===== */
    @media (max-width: 480px){
      .header-grid{ padding: 8px 8px; }
      .logo-d{ height: 40px; }
      .title-top{ font-size: 12px; }
      .title-main{ font-size: 16px; }
      .login-cluster input{ width: 100%; }
      .login-btn{ min-width: 120px; font-size: 14px; }
      .top-fields,.top-fields-2{grid-template-columns:1fr;gap:8px}
      .field{grid-column:1/-1}
      .summary-row{grid-template-columns:1fr}
      .summary-block{grid-column:1/-1}
      
      /* Banner trÃªn small mobile - chiáº¿m toÃ n bá»™ chiá»u rá»™ng */
      body.logged-in .welcome-banner {
        left: 0;
        right: 0;
      }
      
      /* áº¨n TOC khi chÆ°a Ä‘Äƒng nháº­p trÃªn small mobile */
      body.logged-out #tocMobile {
        display: none !important;
      }
      
      /* Sau khi Ä‘Äƒng nháº­p trÃªn small mobile */
      body.logged-in .header-grid {
        grid-template-columns: 1fr;
        justify-items: center;
      }
      
      /* Logo vÃ  tiÃªu Ä‘á» cÄƒn giá»¯a header theo chiá»u ngang vÃ  dá»c */
      body.logged-in .brand-row {
        justify-content: center;
        align-items: center;
        margin-top: 8px;
      }
      
      /* áº¨n cá»™t form Ä‘Äƒng nháº­p sau khi Ä‘Äƒng nháº­p */
      body.logged-in .login-cluster {
        display: none !important;
      }
      
      /* Footer trÃªn small mobile */
      #pageFooter {
        padding: 5px 12px 6px;
      }
      
      .footer-left {
        gap: 4px;
      }
    }

    /* ===== MOBILE: Má»–I DÃ’NG 1 TRÆ¯á»œNG ===== */
    @media (max-width: 1023px){
      /* BRAND & LOGIN: brand (logo + tÃªn) cÃ¹ng 1 dÃ²ng; login má»—i thÃ nh pháº§n 1 dÃ²ng */
      .header-grid{ grid-template-columns:1fr; }
      .brand-row{ justify-content:flex-start; }
      .login-cluster{ 
        width:100%; 
        justify-self:stretch; 
        flex-direction: column;
        align-items: stretch;
      }
      .input-group {
        width: 100%;
      }
      .login-cluster input {
        width: 100%;
      }
      .logo-d{ height:44px; }
      .title-top{ font-size:clamp(13px, 1.6vw + 10px, 18px); }
      .title-main{ font-size:clamp(16px, 3vw + 10px, 24px); }

      .top-fields,.top-fields-2{grid-template-columns:1fr;gap:10px}
      .field{grid-column:1/-1}

      /* Táº¤T Cáº¢ CÃC KHá»I TÃ“M Táº®T cÅ©ng 1 cá»™t */
      .summary-row{grid-template-columns:1fr}
      .summary-block{grid-column:1/-1}

      body.sidebar-open #contentWrap{ margin-left:0 } /* mobile khÃ´ng chá»«a chá»— sidebar */
      body.logged-in #tocMobile{ display:block; }     /* dropdown luÃ´n hiá»‡n khi Ä‘Ã£ Ä‘Äƒng nháº­p */
      
      /* Hiá»ƒn thá»‹ banner vÃ  update date trÃªn mobile */
      body.logged-in #welcomeBanner{ display:block; }
      body.logged-in #mobileUpdateDate{ display:block; }
      
      /* áº¨n desktop update date trÃªn mobile */
      .desktop-update-date {
        display: none !important;
      }
      
      .sidebar-update-info {
        display: none !important;
      }
      
      /* Äiá»u chá»‰nh vá»‹ trÃ­ update date mobile */
      body.logged-in #mobileUpdateDate {
        top: calc(var(--header-h) + 40px);
      }
      
      /* Banner trÃªn mobile - chiáº¿m toÃ n bá»™ chiá»u rá»™ng */
      body.logged-in .welcome-banner {
        left: 0;
        right: 0;
      }
      
      /* Dá»i TOC mobile lÃªn sÃ¡t update date */
      body.logged-in #tocMobile {
        top: calc(var(--header-h) + 40px + 40px);
      }
      
      /* áº¨n TOC khi chÆ°a Ä‘Äƒng nháº­p trÃªn mobile */
      body.logged-out #tocMobile {
        display: none !important;
      }
      
      /* áº¨n nÃºt há»— trá»£ cÅ© khi Ä‘Ã£ Ä‘Äƒng nháº­p */
      body.logged-in #tocMobile::after {
        display: none !important;
      }
      
      /* Sau khi Ä‘Äƒng nháº­p trÃªn mobile */
      body.logged-in .header-grid {
        grid-template-columns: 1fr;
        justify-items: center;
      }
      
      /* Logo vÃ  tiÃªu Ä‘á» cÄƒn giá»¯a header theo chiá»u ngang vÃ  dá»c */
      body.logged-in .brand-row {
        justify-content: center;
        align-items: center;
        margin-top: 10px;
      }
      
      /* áº¨n cá»™t form Ä‘Äƒng nháº­p sau khi Ä‘Äƒng nháº­p */
      body.logged-in .login-cluster {
        display: none !important;
      }
      
      /* áº¨n nÃºt Ä‘Äƒng xuáº¥t mÃ u xanh lÃ¡ trÃªn mobile */
      body.logged-in .logout-only {
        display: none !important;
      }
      
      /* áº¨n nÃºt há»— trá»£ desktop trÃªn mobile sau khi Ä‘Äƒng nháº­p */
      body.logged-in #supportDesk {
        display: none !important;
      }
      
      /* Footer trÃªn mobile */
      #pageFooter {
        flex-direction: column;
        gap: 6px;
        padding: 6px 15px 8px;
      }
      
      .footer-left {
        align-items: center;
        text-align: center;
        gap: 6px;
      }
      
      .footer-right {
        justify-content: center;
      }
    }
    /* ===== TABLET ===== */
    @media (min-width: 768px) and (max-width: 1023px){
      .header-grid{ padding: 12px 16px; }
      .logo-d{ height: 50px; }
      .title-top{ font-size: 16px; }
      .title-main{ font-size: 20px; }
      .top-fields,.top-fields-2{grid-template-columns:repeat(6,1fr);gap:14px}
      .field{grid-column:span 3}
      .summary-row{grid-template-columns:repeat(2,1fr);gap:16px}
      .summary-block{grid-column:span 1}
      
      /* Banner trÃªn tablet - chiáº¿m toÃ n bá»™ chiá»u rá»™ng */
      body.logged-in .welcome-banner {
        left: 0;
        right: 0;
      }
      
      /* áº¨n TOC khi chÆ°a Ä‘Äƒng nháº­p trÃªn tablet */
      body.logged-out #tocMobile {
        display: none !important;
      }
      
      /* Sau khi Ä‘Äƒng nháº­p trÃªn tablet */
      body.logged-in .header-grid {
        grid-template-columns: 1fr;
        justify-items: center;
      }
      
      /* Logo vÃ  tiÃªu Ä‘á» cÄƒn giá»¯a header theo chiá»u ngang vÃ  dá»c */
      body.logged-in .brand-row {
        justify-content: center;
        align-items: center;
        margin-top: 12px;
      }
      
      /* áº¨n cá»™t form Ä‘Äƒng nháº­p sau khi Ä‘Äƒng nháº­p */
      body.logged-in .login-cluster {
        display: none !important;
      }
      
      /* Footer trÃªn tablet */
      #pageFooter {
        padding: 6px 18px 8px;
      }
      
      #supportFooter {
        padding: 8px 16px;
        font-size: 14px;
      }
      
      /* Footer trÃªn tablet */
      .footer-left {
        gap: 5px;
      }
      
      /* áº¨n nÃºt há»— trá»£ desktop trÃªn tablet sau khi Ä‘Äƒng nháº­p */
      body.logged-in #supportDesk {
        display: none !important;
      }
    }

    @media (min-width: 1024px){
      body.logged-in #sidebar{ display:block; }
      body.logged-in.sidebar-open #supportDesk{ display:inline-flex; }
      
      /* Hiá»ƒn thá»‹ banner trÃªn desktop */
      body.logged-in #welcomeBanner{ display:block; }
      
      /* Banner trÃªn desktop - cÄƒn theo sidebar */
      body.logged-in .welcome-banner {
        left: var(--sidebar-width);
        right: 0;
      }
      
      /* Banner khi sidebar Ä‘Ã³ng */
      body.logged-in:not(.sidebar-open) .welcome-banner {
        left: 0;
        right: 0;
      }
      
      /* áº¨n mobile update date trÃªn desktop */
      .mobile-update-date {
        display: none !important;
      }
      
      /* áº¨n TOC khi chÆ°a Ä‘Äƒng nháº­p trÃªn desktop */
      body.logged-out #tocMobile {
        display: none !important;
      }
      
      /* áº¨n nÃºt Ä‘Äƒng xuáº¥t mÃ u xanh lÃ¡ trÃªn desktop */
      body.logged-in .logout-only {
        display: none !important;
      }
      
      /* áº¨n nÃºt há»— trá»£ desktop sau khi Ä‘Äƒng nháº­p */
      body.logged-in #supportDesk {
        display: none !important;
      }
      
      /* Footer trÃªn desktop */
      #pageFooter {
        padding: 6px 20px 8px;
      }
      
      #supportFooter {
        padding: 8px 16px;
        font-size: 14px;
      }
    }

    /* ===== LARGE DESKTOP ===== */
    @media (min-width: 1440px){
      .header-grid{ padding: 16px 24px; }
      .logo-d{ height: 80px; }
      .title-top{ font-size: 22px; }
      .title-main{ font-size: 30px; }
      .top-fields,.top-fields-2{grid-template-columns:repeat(12,1fr);gap:20px}
      .field{grid-column:span 4}
      .summary-row{grid-template-columns:repeat(2,1fr);gap:20px}
      .summary-block{grid-column:span 1}
      main{ max-width: 1400px; }
    }

    /* ===== FOOTER ===== */
    #pageFooter{
      position:fixed; left:0; right:0; bottom:0;
      min-height:var(--footer-h);
      display:flex; flex-direction:row; align-items:center; justify-content:space-between;
      background:#f4f6f8; color:#0b3a2a; border-top:1px solid #e3e7eb; z-index:var(--z-footer);
      padding:6px 20px 8px; font-weight:800;
    }
    
    .footer-left {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      text-align: center;
    }
    
    .footer-right {
      display: flex;
      align-items: center;
    }
    
    #supportFooter {
      background: #00a758;
      color: #fff;
      padding: 8px 16px;
      border-radius: 20px;
      text-decoration: none;
      font-weight: 700;
      font-size: 14px;
      transition: all 0.2s ease;
      white-space: nowrap;
    }
    
    #supportFooter:hover {
      background: #059669;
      transform: translateY(-1px);
      box-shadow: 0 2px 8px rgba(0, 167, 88, 0.3);
    }
    #pageFooter img{ height:22px; width:auto; display:block; }
    #contentWrap::after{ content:""; display:block; height: calc(0.75 * var(--footer-h) + 24px); }

    /* Há»— trá»£ desktop - luÃ´n náº±m gÃ³c dÆ°á»›i phÃ­a trÃªn footer */
    #supportDesk{
      position:fixed; right:18px; bottom:calc(var(--footer-h) + 14px);
      background:#00a758;color:#fff;padding:12px 16px;border-radius:28px;font-weight:900;text-decoration:none;box-shadow:0 4px 12px rgba(0,0,0,.18); z-index:var(--z-support); display:inline-flex !important;
    }
  </style>
</head>
<body class="logged-out">
  <!-- ===== HEADER ===== -->
  <header id="pageHeader" class="app-header">
    <div class="header-grid">
      <div class="brand-row">
         &#160;&#160;<img src="../logo.webp" alt="logo" class="logo-d" />
        <div class="title-wrap">
          <div class="title-top">Cá»”NG THÃ”NG TIN VÃ™NG Háº°NG LÃ‚M</div>
          <div class="title-main">Dá»° TÃNH THU NHáº¬P</div>
        </div>
      </div>

      <!-- Cá»¥m Ä‘Äƒng nháº­p / Ä‘Äƒng xuáº¥t -->
      <form id="loginForm" class="login-cluster">
        <div class="input-group">
          <input class="login-only" type="text" id="agent-id" placeholder="Nháº­p MSDL" required />
          <div class="password-input-wrapper">
            <input class="login-only" type="password" id="ngay-gia-nhap" placeholder="NgÃ y gia nháº­p" required />
            <button type="button" class="toggle-password" onclick="togglePassword()">
              <span class="eye-icon">ğŸ‘ï¸</span>
            </button>
          </div>
        </div>
        <button id="loginBtn" class="login-btn login-only" type="submit">ÄÄƒng nháº­p</button>
        <button id="logoutBtn" class="login-btn logout-only" type="button" onclick="location.reload()">ÄÄƒng xuáº¥t</button>
      </form>
    </div>
    <div id="errorTop"></div>
  </header>

  <!-- ===== WELCOME BANNER ===== -->
  <div id="welcomeBanner" class="welcome-banner">
    Xin chÃ o <span id="welcomeName"></span>
  </div>

  <!-- ===== UPDATE DATE MOBILE ===== -->
  <div id="mobileUpdateDate" class="mobile-update-date" style="display: none;">
    Dá»¯ liá»‡u Ä‘Æ°á»£c chá»‘t Ä‘áº¿n: <span id="mobileUpdateDateText"></span>
  </div>

  <!-- ===== LOADING SCREEN ===== -->
  <div id="loadingScreen" class="loading-screen" style="display: none;">
    <div class="loading-content">
      <div class="loading-spinner"></div>
      <div class="loading-text">Äang táº£i dá»¯ liá»‡u...</div>
    </div>
  </div>

  <!-- ===== MOBILE TOC (treo dÆ°á»›i header) ===== -->
  <div id="tocMobile">
    <div class="row">
      <button id="mobileMenuBtn" class="mobile-menu-btn">Danh má»¥c</button>
      <button id="mobileLogoutBtn" class="mobile-logout-btn">ÄÄƒng xuáº¥t</button>
    </div>
    <!-- Mobile menu dropdown -->
    <div id="mobileMenuDropdown" class="mobile-menu-dropdown" style="display: none;">
      <div class="mobile-menu-content">
        <a href="#" class="mobile-menu-item" data-target="sec-daily">ThÃ´ng tin Ä‘áº¡i lÃ½</a>
        <a href="#" class="mobile-menu-item" data-target="sec-muctieu">A.1 Má»¥c tiÃªu thÃ¡ng</a>
        <a href="#" class="mobile-menu-item" data-target="sec-khoanthu">A.2 CÃ¡c khoáº£n thu nháº­p</a>
        <a href="#" class="mobile-menu-item" data-target="sec-ban-hang">A.3 Thu nháº­p bÃ¡n hÃ ng</a>
        <a href="#" class="mobile-menu-item" data-target="sec-tuyendung">B. Thu nháº­p tuyá»ƒn dá»¥ng</a>
        <a href="#" class="mobile-menu-item" data-target="sec-quan-ly">C. Thu nháº­p quáº£n lÃ½</a>
        <a href="#" class="mobile-menu-item" data-target="sec-tong">D. Tá»•ng thu nháº­p</a>
      </div>
    </div>
  </div>

  <!-- ===== SIDEBAR (desktop) ===== -->
  <aside id="sidebar">
    <div class="sidebar-inner">
      <div class="sidebar-update-info" id="sidebarUpdateInfo" style="display: none;">
        Dá»¯ liá»‡u Ä‘Æ°á»£c chá»‘t Ä‘áº¿n ngÃ y: <span id="sidebarUpdateDateText"></span>
      </div>
      <div class="menu-title">Danh má»¥c</div>
      <div class="desktop-update-date" id="sidebarUpdateDate" style="display: none;"></div>

      <a href="#" class="menu-item active" data-target="sec-daily">THÃ”NG TIN Äáº I LÃ</a>

      <div class="menu-group">A. THU NHáº¬P Tá»ª BÃN HÃ€NG CÃ NHÃ‚N</div>
      <div class="submenu">
        <a href="#" class="menu-item" data-target="sec-muctieu">1. Má»¥c tiÃªu thÃ¡ng</a>
        <a href="#" class="menu-item" data-target="sec-khoanthu">2. CÃ¡c khoáº£n thu nháº­p</a>
        <a href="#" class="menu-item" data-target="sec-ban-hang">3. Thu nháº­p</a>
      </div>

      <div class="menu-group">B. THU NHáº¬P Tá»ª HOáº T Äá»˜NG TUYá»‚N Dá»¤NG</div>
      <a href="#" class="menu-item" data-target="sec-tuyendung">Coming Soon</a>

      <div class="menu-group">C. THU NHáº¬P Tá»ª HOáº T Äá»˜NG QUáº¢N LÃ</div>
      <a href="#" class="menu-item" data-target="sec-quan-ly">Coming Soon</a>

      <a href="#" class="menu-item" data-target="sec-tong">D. Tá»”NG THU NHáº¬P</a>
    </div>
  </aside>

  <!-- ===== CONTENT ===== -->
  <a id="supportDesk" href="http://zalo.me/0376763390" target="_blank" rel="noopener">Há»— trá»£</a>

  <div id="contentWrap">
    <main>
      <!-- 1) THÃ”NG TIN Äáº I LÃ -->
      <section id="sec-daily" class="app-section">
        <div class="top-fields">
          <div class="field" style="flex:6">
            <label for="ho-ten"><b>Há» vÃ  tÃªn</b></label>
            <input type="text" id="ho-ten" readonly />
          </div>
          <div class="field" style="flex:2">
            <label for="khu-vuc"><b>Khu vá»±c</b></label>
            <input type="text" id="khu-vuc" readonly />
          </div>
        </div>
        <div class="top-fields">
          <div class="field" style="flex:1.5">
            <label for="thang-lam-viec"><b>ThÃ¢m niÃªn (thÃ¡ng)</b></label>
            <input type="text" id="thang-lam-viec" readonly />
          </div>
          <div class="field" style="flex:4">
            <label for="nhom-dai-ly"><b>PhÃ¢n nhÃ³m Ä‘áº¡i lÃ½</b></label>
            <input type="text" id="nhom-dai-ly" readonly />
          </div>
        </div>
        <div class="top-fields">
          <div class="field" style="flex:1">
            <label for="p13-ca-nhan"><b>P13 cÃ¡ nhÃ¢n</b></label>
            <input type="text" id="p13-ca-nhan" readonly />
          </div>
          <div class="field" style="flex:1">
            <label for="he-so-thuong"><b>Há»‡ sá»‘ tÃ­nh thÆ°á»Ÿng</b></label>
            <input type="text" id="he-so-thuong" readonly />
          </div>
        </div>
        <div class="top-fields">
          <div class="field" style="flex:1">
            <label for="mdrt-fyp"><b>âˆ‘ FYP DH MDRT</b></label>
            <input type="text" id="mdrt-fyp" readonly />
          </div>
          <div class="field" style="flex:1">
            <label for="tong-fyc"><b>âˆ‘ FYC T-1 vÃ  T-2</b></label>
            <input type="text" id="tong-fyc" readonly />
          </div>
          <div class="field" style="flex:1">
            <label for="tong-fyc-quy"><b>âˆ‘ FYC QuÃ½ hiá»‡n táº¡i</b></label>
            <input type="text" id="tong-fyc-quy" readonly />
          </div>
        </div>
        <div class="top-fields">
          <div class="field" style="flex:1">
            <label for="active-months"><b>Sá»‘ thÃ¡ng cÃ³ hoáº¡t Ä‘á»™ng trong QuÃ½</b></label>
            <input type="text" id="active-months" readonly />
          </div>
        </div>
      </section>

      <!-- 2) A.1 Má»¤C TIÃŠU THÃNG -->
      <section id="sec-muctieu" class="app-section" style="display:none">
        <div class="top-fields" style="margin-bottom:10px">
          <div class="field">
            <label for="month-select"><b>ThÃ¡ng dá»± tÃ­nh</b></label>
            <select id="month-select"></select>
          </div>
        </div>

        <div id="memo-giai-doan">
          <div class="gd-stage">
            <b>Giai Ä‘oáº¡n 1 (1-11/8)</b>
            <div class="top-fields-2">
              <div class="field"><label for="fypchinh-gd1"><b>FYP SP chÃ­nh</b></label><input type="text" id="fypchinh-gd1"/></div>
              <div class="field"><label for="fypkem-gd1"><b>FYP SP gáº¯n kÃ¨m</b></label><input type="text" id="fypkem-gd1"/></div>
            </div>
            <div class="top-fields-2">
              <div class="field"><label for="sohd-gd1"><b>Sá»‘ HÄ</b></label><input type="text" id="sohd-gd1"/></div>
              <div class="field"><label for="fyp-gd1"><b>âˆ‘ FYP</b></label><input type="text" id="fyp-gd1" readonly/></div>
            </div>
            <div class="top-fields-2">
              <div class="field"><label for="thuongmemo-gd1"><b>ThÆ°á»Ÿng Memo Giai Ä‘oáº¡n 1</b></label><input type="text" id="thuongmemo-gd1" readonly/></div>
            </div>
            <div class="top-fields-2">
              <div class="field"><span id="alert-gd1" style="color:red;font-weight:bold;font-size:14px;text-align:left;display:block;width:100%""></span></div>
            </div>
          </div>

          <div class="gd-stage">
            <b>Giai Ä‘oáº¡n 2 (12-25/8)</b>
            <div class="top-fields-2">
              <div class="field"><label for="fypchinh-gd2"><b>FYP SP chÃ­nh</b></label><input type="text" id="fypchinh-gd2"/></div>
              <div class="field"><label for="fypkem-gd2"><b>FYP SP gáº¯n kÃ¨m</b></label><input type="text" id="fypkem-gd2"/></div>
            </div>
            <div class="top-fields-2">
              <div class="field"><label for="sohd-gd2"><b>Sá»‘ HÄ</b></label><input type="text" id="sohd-gd2"/></div>
              <div class="field"><label for="fyp-gd2"><b>âˆ‘ FYP</b></label><input type="text" id="fyp-gd2" readonly/></div>
            </div>
            <div class="top-fields-2">
              <div class="field"><label for="thuongmemo-gd2"><b>ThÆ°á»Ÿng Memo Giai Ä‘oáº¡n 2</b></label><input type="text" id="thuongmemo-gd2" readonly/></div>
            </div>
            <div class="top-fields-2">
              <div class="field"><span id="alert-gd2" style="color:red;font-weight:bold;font-size:14px;text-align:left;display:block;width:100%""></span></div>
            </div>
          </div>

          <div class="gd-stage">
            <b>Giai Ä‘oáº¡n 3 (26-31/8)</b>
            <div class="top-fields-2">
              <div class="field"><label for="fypchinh-gd3"><b>FYP SP chÃ­nh</b></label><input type="text" id="fypchinh-gd3"/></div>
              <div class="field"><label for="fypkem-gd3"><b>FYP SP gáº¯n kÃ¨m</b></label><input type="text" id="fypkem-gd3"/></div>
            </div>
            <div class="top-fields-2">
              <div class="field"><label for="sohd-gd3"><b>Sá»‘ HÄ</b></label><input type="text" id="sohd-gd3"/></div>
              <div class="field"><label for="fyp-gd3"><b>âˆ‘ FYP</b></label><input type="text" id="fyp-gd3" readonly/></div>
            </div>
            <div class="top-fields-2">
              <div class="field"><label for="thuongmemo-gd3"><b>ThÆ°á»Ÿng Memo Giai Ä‘oáº¡n 3</b></label><input type="text" id="thuongmemo-gd3" readonly/></div>
            </div>
            <div class="top-fields-2">
              <div class="field"><span id="alert-gd3" style="color:red;font-weight:bold;font-size:14px;text-align:left;display:block;width:100%""></span></div>
            </div>
          </div>

          <br/>
          <div>
            <b style="margin-left:var(--pad)">Tá»”NG Há»¢P</b>
            <div class="top-fields">
              <div class="field"><label for="tong-cc"><b>âˆ‘ Sá»‘ lÆ°á»£ng Há»£p Ä‘á»“ng</b></label><input type="text" id="tong-cc" readonly/></div>
              <div class="field"><label for="fyp-chinh"><b>âˆ‘ FYP SP chÃ­nh</b></label><input type="text" id="fyp-chinh" readonly/></div>
              <div class="field"><label for="fyp-kem"><b>âˆ‘ FYP SP gáº¯n kÃ¨m</b></label><input type="text" id="fyp-kem" readonly/></div>
            </div>
                    <div class="top-fields" style="align-items:center">
          <div class="field" style="flex:3"><label for="tong-fyp"><b>âˆ‘ FYP Tá»« cÃ¡c HÄ</b></label><input type="text" id="tong-fyp" readonly/></div>
          <div class="field" style="flex:3;display:flex;align-items:flex-end">
            <div class="calc-wrap">
              <button id="calc-btn" onclick="calculateIncome(); showSection('sec-khoanthu')">TÃ­nh thu nháº­p</button>

            </div>
          </div>
        </div>
          </div>
        </div>
      </section>

      <!-- 3) A.2 CÃC KHOáº¢N THU NHáº¬P -->
      <section id="sec-khoanthu" class="app-section" style="display:none">
        <div class="top-fields">
          <div class="field"><label><b>FYC SP chÃ­nh (30%)</b></label><input type="text" id="fyc-chinh" readonly/></div>
          <div class="field"><label><b>FYC SP gáº¯n kÃ¨m (20%)</b></label><input type="text" id="fyc-kem" readonly/></div>
        </div>
        <div class="top-fields">
          <div class="field"><label><b>ThÆ°á»Ÿng thÃªm SP gáº¯n kÃ¨m (20%)</b></label><input type="text" id="thuong-kem" readonly/></div>
          <div class="field"><label><b>FYC TÃ­nh chÃ­nh sÃ¡ch</b></label><input type="text" id="fyc-thuong" readonly/></div>
        </div>
        <div class="top-fields">
          <div class="field"><label><b>ThÆ°á»Ÿng NSXS Manulife Pro</b></label><input type="text" id="thuong-nspro" readonly/></div>
          <div class="field"><label><b>ThÆ°á»Ÿng NÄƒng suáº¥t hÃ ng thÃ¡ng</b></label><input type="text" id="thuong-nst" readonly/></div>
        </div>
        <div class="top-fields">
          <div class="field"><label><b>ThÆ°á»Ÿng NÄƒng suáº¥t hÃ ng QuÃ½</b></label><input type="text" id="thuong-nsq" readonly/></div>
          <div class="field">
            <label><b>ThÆ°á»Ÿng Tiáº¿n Ä‘á»™ MDRT</b></label>
            <input type="text" id="thuong-mdrt" readonly/>
            <span id="alert-mdrt" style="color:#d62929;display:none"></span>
          </div>
        </div>
        <div class="top-fields">
          <div class="field"><label for="thuong-memo" class="income-note"><b>0001M08/2025/ASBD</b></label><input type="text" id="thuong-memo" readonly/></div>
        </div>
        <div class="top-fields">
          <div class="field"><span id="alert-gd1-summary" style="color:red;font-weight:bold;font-size:14px;text-align:left;display:block;width:100%"></span></div>
        </div>
        <div class="top-fields">
          <div class="field"><span id="alert-gd2-summary" style="color:red;font-weight:bold;font-size:14px;text-align:left;display:block;width:100%"></span></div>
        </div>
        <div class="top-fields">
          <div class="field"><span id="alert-gd3-summary" style="color:red;font-weight:bold;font-size:14px;text-align:left;display:block;width:100%"></span></div>
        </div>
      </section>

      <!-- 4) A.3 THU NHáº¬P BÃN HÃ€NG -->
      <section id="sec-ban-hang" class="app-section" style="display:none">
        <div class="summary-row">
          <div class="summary-block"><label for="tong-thu-nhap">Tá»•ng thu nháº­p bÃ¡n hÃ ng (A)</label><input type="text" id="tong-thu-nhap" readonly/></div>
          <div class="summary-block"><label for="ty-le-thu-nhap">Tá»· lá»‡ thu nháº­p/doanh thu</label><input type="text" id="ty-le-thu-nhap" readonly/></div>
        </div>
        <hr><div style="text-align:center;font-weight:900;color:#0d72b5;font-size:18px;padding:20px 0;border-left:6px solid #0d72b5;background:#f0f9ff;margin:20px 0;border-radius:8px">CHÃšC Báº N Sá» Há»®U Tá»I ÄA THU NHáº¬P</div>
      </section>

      <!-- 5) B. TUYá»‚N Dá»¤NG -->
      <section id="sec-tuyendung" class="app-section" style="display:none">
        <div class="top-fields">
          <div class="field">
            <label><b>Thu nháº­p tuyá»ƒn dá»¥ng (B)</b></label>
            <input type="text" id="thu-nhap-tuyen-dung" value="0" readonly />
          </div>
        </div>
        <div class="top-fields"><div class="field"><div style="color:#0ea35b;font-weight:900">Coming soon</div></div></div>
      </section>

      <!-- 6) C. QUáº¢N LÃ -->
      <section id="sec-quan-ly" class="app-section" style="display:none">
        <div class="top-fields">
          <div class="field">
            <label><b>Thu nháº­p quáº£n lÃ½ (C)</b></label>
            <input type="text" id="thu-nhap-quan-ly" value="0" readonly />
          </div>
        </div>
        <div class="top-fields"><div class="field"><div style="color:#0ea35b;font-weight:900">Coming soon</div></div></div>
      </section>

      <!-- 7) D. Tá»”NG THU NHáº¬P -->
      <section id="sec-tong" class="app-section" style="display:none">
        <div class="summary-row">
          <div class="summary-block"><label for="tong-A">A â€” Thu nháº­p bÃ¡n hÃ ng</label><input type="text" id="tong-A" readonly/></div>
          <div class="summary-block"><label for="tong-B">B â€” Thu nháº­p tuyá»ƒn dá»¥ng</label><input type="text" id="tong-B" readonly/></div>
        </div>
        <div class="summary-row">
          <div class="summary-block"><label for="tong-C">C â€” Thu nháº­p quáº£n lÃ½</label><input type="text" id="tong-C" readonly/></div>
          <div class="summary-block"><label for="tong-ABC">D â€” Tá»”NG THU NHáº¬P (A + B + C)</label><input type="text" id="tong-ABC" readonly/></div>
        </div>
      </section>
    </main>
  </div>

  <!-- ===== FOOTER ===== -->
  <footer id="pageFooter">
    <div class="footer-left">
      <div>Báº£n quyá»n trang web thuá»™c vá»</div>
      <img src="../logo_textr.webp" alt="Logo" />
    </div>
    <div class="footer-right">
      <a id="supportFooter" href="http://zalo.me/0376763390" target="_blank" rel="noopener">Há»— trá»£</a>
    </div>
  </footer>

  <!-- ===== LOGIC (GIá»® NGUYÃŠN, CHá»ˆ CHá»ˆNH HÃ€NH VI CUá»˜N TRÃŠN MOBILE) ===== -->
  <script>
/* ===== GLOBAL VARS ===== */
let data=[],nspro=[],nst6=[],nst7=[],nsq6=[],nsq7=[],hsdt=[],trackingMDRT=[];
let isDataReady=false, isLoggedIn=false;

/* ===== PASSWORD TOGGLE ===== */
function togglePassword() {
  const dateInput = document.getElementById('ngay-gia-nhap');
  const eyeIcon = document.querySelector('.eye-icon');
  
  if (dateInput.type === 'password') {
    dateInput.type = 'text';
    eyeIcon.textContent = 'ğŸ™ˆ';
  } else {
    dateInput.type = 'password';
    eyeIcon.textContent = 'ğŸ‘ï¸';
  }
}

/* ===== MONEY HELPERS ===== */
const NF3=new Intl.NumberFormat('vi-VN',{minimumFractionDigits:3,maximumFractionDigits:3});
const formatMoney3=v=>Number.isFinite(+v)?NF3.format(+v):'';
function parseMoney3(s){ if(typeof s==='number')return s; if(!s)return 0; const n=parseFloat(String(s).replace(/\./g,'').replace(',','.')); return Number.isFinite(n)?n:0; }

/* ===== NUMERIC VALUE PARSER ===== */
// HÃ m chung Ä‘á»ƒ chuyá»ƒn Ä‘á»•i dá»¯ liá»‡u tá»« text sang sá»‘
// Xá»­ lÃ½ Ä‘á»‹nh dáº¡ng sá»‘ vá»›i dáº¥u . cho tháº­p phÃ¢n (vÃ­ dá»¥: 1.5, 2.75)
// Ãp dá»¥ng cho Táº¤T Cáº¢ cÃ¡c trÆ°á»ng sá»‘: Active, FYC, FYP, MDRT-FYP, Sá»‘ thÃ¡ng lÃ m viá»‡c, v.v.
function parseActiveValue(value) {
  if (value === null || value === undefined || value === "") return 0;
  if (typeof value === "number") return value;
  if (typeof value === "string") {
    const trimmed = value.trim();
    if (trimmed === "" || trimmed === "0" || trimmed === "0.0" || trimmed === "0.00" || trimmed === "null" || trimmed === "undefined") return 0;
    
    // Xá»­ lÃ½ cÃ¡c trÆ°á»ng há»£p Ä‘áº·c biá»‡t
    if (trimmed === "0.0" || trimmed === "0.00") return 0;
    
    // Chuyá»ƒn Ä‘á»•i sang sá»‘, dáº¥u . lÃ  dáº¥u tháº­p phÃ¢n
    const num = parseFloat(trimmed);
    return isNaN(num) ? 0 : num;
  }
  return 0;
}

/* ===== ID LISTS ===== */
const MONEY_INPUT_IDS_EDITABLE=['fypchinh-gd1','fypkem-gd1','fypchinh-gd2','fypkem-gd2','fypchinh-gd3','fypkem-gd3'];
const COUNT_INPUT_IDS_EDITABLE=['sohd-gd1','sohd-gd2','sohd-gd3'];
const MONEY_OUTPUT_IDS=['fyp-gd1','fyp-gd2','fyp-gd3','fyp-chinh','fyp-kem','tong-fyp','fyc-chinh','fyc-kem','thuong-kem','fyc-thuong','thuong-nspro','thuong-nst','thuong-nsq','thuong-mdrt','thuongmemo-gd1','thuongmemo-gd2','thuongmemo-gd3','thuong-memo','mdrt-fyp','tong-fyc','tong-fyc-quy','tong-thu-nhap'];
const ALL_MONEY_IDS=[...new Set([...MONEY_INPUT_IDS_EDITABLE,...MONEY_OUTPUT_IDS])];

/* ===== DATE/LOOKUP HELPERS ===== */
const rmAccent=s=>s.normalize('NFKD').replace(/[\u0300-\u036f]/g,'');
function normKeyMap(o){const m={};for(const k of Object.keys(o))m[rmAccent(k).replace(/\s+/g,'').toUpperCase()]=k;return m;}
function getByKeyLoose(row,target){const map=normKeyMap(row);const w=rmAccent(target).replace(/\s+/g,'').toUpperCase();return map[w]?row[map[w]]:undefined;}
function eqAgent(a,b){const n=x=>(x??'').toString().normalize('NFKD').replace(/[\u0300-\u036f]/g,'').trim().toLowerCase();return n(a)===n(b);}
function standardizeDate(input){let s=input.trim().replace(/[^0-9]/g,'');if(s.length!==8)return input;return [s.slice(0,2),s.slice(2,4),s.slice(4,8)].join('/');}
function normalizeDateForCompare(v){if(!v)return'';const s=String(v).trim();const d=s.replace(/[^0-9]/g,'');if(d.length===8){const dd=d.slice(0,2),mm=d.slice(2,4),yy=d.slice(4,8);return yy+mm+dd;}const p=s.split(/[^0-9]+/).filter(Boolean);if(p.length===3){let[dd,mm,yy]=p.map(String);if(yy.length===2)yy=(+yy>=70?'19':'20')+yy;if(dd.length===1)dd='0'+dd;if(mm.length===1)mm='0'+mm;return yy+mm+dd;}return'';}
const datesEqual=(a,b)=>normalizeDateForCompare(a)===normalizeDateForCompare(b);

/* ===== LOAD DATA ===== */
async function fetchFirstJson(list){for(const url of list){try{const r=await fetch(url,{cache:'no-store'});if(r.ok)return await r.json();}catch{}}return null;}
async function loadData(){
  const btn=document.querySelector('button[onclick="searchAgent()"]'); if(btn){btn.disabled=true;btn.textContent="Äang táº£i dá»¯ liá»‡u...";}
  
  try{
    const r=await fetch('../income.json',{cache:'no-store'}); 
    if(!r.ok)throw new Error('HTTP '+r.status); 
    data=await r.json();
  }catch(e){
    console.error('Error loading income.json:', e);
    alert("KhÃ´ng táº£i Ä‘Æ°á»£c income.json."); 
    data=[];
  }
  
  isDataReady=Array.isArray(data)&&data.length>0;
  console.log('loadData - income.json loaded:', isDataReady, 'records:', data.length);
  
  // Load cÃ¡c file JSON khÃ¡c - sá»­a Ä‘Æ°á»ng dáº«n Ä‘á»ƒ trá» vá» thÆ° má»¥c gá»‘c
  try {
    nspro=await fetchFirstJson(['../nspro.json','../NSPRO.json','../Nspro.json'])||[];
    nst6 =await fetchFirstJson(['../6nst.json','../6NST.json'])||[];
    nst7 =await fetchFirstJson(['../7nst.json','../7NST.json'])||[];
    nsq6 =await fetchFirstJson(['../6NSQ.json','../6nsq.json'])||[];
    nsq7 =await fetchFirstJson(['../7NSQ.json','../7nsq.json'])||[];
    hsdt =await fetchFirstJson(['../hsdt.json','../HSDT.json'])||[];
    trackingMDRT=await fetchFirstJson(['../trackingmdrt.json','../TRACKING MDRT.json','../TRACKING%20MDRT.json'])||[];
    
    console.log('loadData - nspro loaded:', nspro.length, 'records');
    console.log('loadData - nst6 loaded:', nst6.length, 'records');
    console.log('loadData - nst7 loaded:', nst7.length, 'records');
    console.log('loadData - nsq6 loaded:', nsq6.length, 'records');
    console.log('loadData - nsq7 loaded:', nsq7.length, 'records');
    console.log('loadData - hsdt loaded:', hsdt.length, 'records');
    console.log('loadData - trackingMDRT loaded:', trackingMDRT.length, 'records');
    
    // Kiá»ƒm tra dá»¯ liá»‡u cÃ³ Ä‘Ãºng Ä‘á»‹nh dáº¡ng khÃ´ng
    if(nst6.length > 0) {
      console.log('loadData - nst6 sample data:', nst6[0]);
    }
    if(nsq6.length > 0) {
      console.log('loadData - nsq6 sample data:', nsq6[0]);
    }
    if(trackingMDRT.length > 0) {
      console.log('loadData - trackingMDRT sample data:', trackingMDRT[0]);
    }
    
  } catch(e) {
    console.error('Error loading other JSON files:', e);
  }
  
  if(btn){btn.disabled=false;btn.textContent="ÄÄƒng nháº­p";}
}

/* ===== MONTH SELECT ===== */
function getCurrentMonth(){return new Date().getMonth()+1;}
function populateMonthSelect(){const sel=document.getElementById('month-select'); if(!sel)return; sel.innerHTML=''; const cur=getCurrentMonth(); for(let m=cur;m<=12;m++){const op=document.createElement('option');op.value=m;op.textContent=`ThÃ¡ng ${m}`;sel.appendChild(op);}}

/* ===== THÆ¯á»NG/MEMO/Tá»”NG Há»¢P ===== */
function getHeSoThuong(p13){const n=Number(p13);if(!isFinite(n))return 1;let best=1;for(const row of hsdt){const moc=row["P13 cÃ¡ nhÃ¢n"];const tl=row["Tá»¶ Lá»†"];if(moc===null){best=tl||best;continue}if(n>=Number(moc))best=Number(tl)||best}return best}
function optimizeMemo(fyp,ccLimit,m1,t1,m2,t2){const F=Math.max(0,+fyp||0);const limit=(ccLimit==null||ccLimit<=0)?Infinity:Math.max(0,Math.floor(ccLimit));let best=0,used=0;const max25=Math.floor(F/m1);const maxLoop=Math.min(max25,limit);for(let i=0;i<=maxLoop;i++){const rem=F-i*m1;const cap=(limit===Infinity)?Infinity:(limit-i);const j=Math.min(Math.floor(rem/m2),cap);const u=i+j;const r=i*t1+j*t2;if(r>best || (r===best && u<used)){best=r;used=u}}return{reward:best,used}}
function calcMemoStage(gd,sohd,tongFYP){let m1,t1,m2,t2;if(gd==='gd1'){m1=25000;t1=2500;m2=16000;t2=1500}else if(gd==='gd2'){m1=25000;t1=2000;m2=16000;t2=1000}else{m1=25000;t1=1500;m2=16000;t2=750}
  const optU=optimizeMemo(+tongFYP||0,Infinity,m1,t1,m2,t2);let res=optU,txt='';const cc=Math.max(0,+sohd||0);
  if(cc>0){if(cc<optU.used){res=optimizeMemo(+tongFYP||0,cc,m1,t1,m2,t2);txt=`ThÆ°á»Ÿng tá»‘i Æ°u tá»« ${optU.used} HÄ; báº¡n nháº­p ${cc} nÃªn chá»‰ tÃ­nh tá»‘i Ä‘a ${cc} HÄ.`}else if(cc>optU.used){txt=`Chá»‰ thÆ°á»Ÿng tá»‘i Ä‘a ${optU.used} há»£p Ä‘á»“ng!`}}
  document.getElementById('thuongmemo-'+gd).value=formatMoney3(res.reward);
  
  // Hiá»ƒn thá»‹ cáº£nh bÃ¡o vá»›i tÃªn giai Ä‘oáº¡n vÃ  dáº¥u cáº£nh bÃ¡o
  const gdNames = {gd1: 'Giai Ä‘oáº¡n 1', gd2: 'Giai Ä‘oáº¡n 2', gd3: 'Giai Ä‘oáº¡n 3'};
  const alertText = txt ? `â„¹ï¸ ${gdNames[gd]}: ${txt}` : '';
  
  // Cáº­p nháº­t cáº£nh bÃ¡o trong tá»«ng giai Ä‘oáº¡n
  const el = document.getElementById('alert-'+gd); 
  if(el){
    el.textContent = alertText; 
    el.style.display = txt ? 'block' : 'none';
  }
  
  // Cáº­p nháº­t cáº£nh bÃ¡o trong pháº§n tá»•ng há»£p
  const elSummary = document.getElementById('alert-'+gd+'-summary');
  if(elSummary){
    elSummary.textContent = alertText;
    elSummary.style.display = txt ? 'block' : 'none';
  }
}
function updateTongHop(){
  const geti=id=>parseInt((document.getElementById(id).value||'').replace(/[^\d]/g,''),10)||0;
  const getn=id=>parseMoney3(document.getElementById(id).value);
  const cc1=geti('sohd-gd1'),cc2=geti('sohd-gd2'),cc3=geti('sohd-gd3');
  document.getElementById('tong-cc').value=cc1+cc2+cc3;
  const f1=getn('fypchinh-gd1'),f2=getn('fypchinh-gd2'),f3=getn('fypchinh-gd3');
  const k1=getn('fypkem-gd1'),k2=getn('fypkem-gd2'),k3=getn('fypkem-gd3');
  const sumC=f1+f2+f3, sumK=k1+k2+k3;
  document.getElementById('fyp-chinh').value=formatMoney3(sumC);
  document.getElementById('fyp-kem').value=formatMoney3(sumK);
  document.getElementById('fyp-gd1').value=formatMoney3(f1+k1);
  document.getElementById('fyp-gd2').value=formatMoney3(f2+k2);
  document.getElementById('fyp-gd3').value=formatMoney3(f3+k3);
  document.getElementById('tong-fyp').value=formatMoney3(sumC+sumK);
  calcMemoStage('gd1',cc1,f1+k1); calcMemoStage('gd2',cc2,f2+k2); calcMemoStage('gd3',cc3,f3+k3);
  const m1=parseMoney3(document.getElementById('thuongmemo-gd1').value);
  const m2=parseMoney3(document.getElementById('thuongmemo-gd2').value);
  const m3=parseMoney3(document.getElementById('thuongmemo-gd3').value);
  document.getElementById('thuong-memo').value=formatMoney3(m1+m2+m3);
}

/* ===== NS PRO / NST / NSQ / MDRT ===== */
function isProGroup(txt){return /manulife\s*pro/i.test(txt)||/\bpro\b/i.test(txt)}
function calculateNSPro(){
  // 1. CHUYá»‚N Äá»”I Dá»® LIá»†U Vá»€ Sá» TRÆ¯á»šC KHI TÃNH
  const cc = parseInt(document.getElementById("tong-cc").value, 10) || 0;
  const tongFYP = parseMoney3(document.getElementById("tong-fyp").value) || 0;
  const nhom = (document.getElementById("nhom-dai-ly").value || '').trim();
  const heSo = parseFloat(document.getElementById("he-so-thuong").value) || 1;
  
  console.log('calculateNSPro - INPUT VALUES:', {
    tongCC: cc,
    tongFYP: tongFYP,
    nhomDaiLy: nhom,
    heSo: heSo
  });
  
  // 2. KIá»‚M TRA ÄIá»€U KIá»†N
  const nA = rmAccent(nhom);
  if(!cc || !nspro.length || !tongFYP || !isProGroup(nA)){
    console.log('calculateNSPro - conditions not met:', {
      hasCC: !!cc,
      hasNSProData: !!nspro.length,
      hasFYP: !!tongFYP,
      isProGroup: isProGroup(nA)
    });
    document.getElementById("thuong-nspro").value = formatMoney3(0);
    return;
  }
  
  // 3. THá»°C HIá»†N LOGIC TÃNH TOÃN Vá»šI Sá»
  let base = 0;
  for(const row of nspro){
    const need = parseMoney3(getByKeyLoose(row, "FYP cá»§a thÃ¡ng xÃ©t thÆ°á»Ÿng")) || 0;
    
    console.log('calculateNSPro - checking row:', {
      need: need,
      currentFYP: tongFYP,
      condition: tongFYP >= need
    });
    
    if(tongFYP < need) continue;
    
    const keys = normKeyMap(row);
    let col = keys['MANULIFEPROBAC'] || keys['MANULIFEPROVANG'] || keys['MANULIFEPROBACHKIM'];
    
    if(/bach\s*kim/i.test(nA)) col = keys['MANULIFEPROBACHKIM'];
    else if(/vang/i.test(nA)) col = keys['MANULIFEPROVANG'];
    
    const rowValue = parseMoney3(col ? row[col] : 0) || 0;
    base = Math.max(base, rowValue);
    
    console.log('calculateNSPro - row calculation:', {
      availableKeys: Object.keys(keys),
      selectedCol: col,
      rowValue: rowValue,
      currentBest: base
    });
  }
  
  // 4. TÃNH Káº¾T QUáº¢ CUá»I CÃ™NG
  const result = base * heSo;
  
  console.log('calculateNSPro - FINAL CALCULATION:', {
    base: base,
    heSo: heSo,
    result: result
  });
  
  // 5. HIá»‚N THá»Š THEO Äá»ŠNH Dáº NG YÃŠU Cáº¦U
  document.getElementById("thuong-nspro").value = formatMoney3(result);
}
function calculateNST(){
  // 1. CHUYá»‚N Äá»”I Dá»® LIá»†U Vá»€ Sá» TRÆ¯á»šC KHI TÃNH
  const th = parseInt(document.getElementById("thang-lam-viec").value, 10) || 0;
  const tongFYC = parseMoney3(document.getElementById("tong-fyc").value) || 0;
  const fycT = parseMoney3(document.getElementById("fyc-thuong").value) || 0;
  const heSo = parseFloat(document.getElementById("he-so-thuong").value) || 1;
  
  // 2. THá»°C HIá»†N LOGIC TÃNH TOÃN Vá»šI Sá»
  const sum = tongFYC + fycT;
  const table = th <= 6 ? nst6 : nst7;
  
  console.log('calculateNST - INPUT VALUES:', {
    thangLamViec: th,
    tongFYC: tongFYC,
    fycThuong: fycT,
    heSo: heSo,
    sum: sum,
    table: th <= 6 ? 'nst6' : 'nst7',
    tableData: table
  });
  
  let rate = 0;
  for(const row of table){
    const need = parseMoney3(getByKeyLoose(row, "FYC trong 3 thÃ¡ng gáº§n nháº¥t")) || 0;
    const rowRate = parseFloat(getByKeyLoose(row, "% Tá»· lá»‡ thÆ°á»Ÿng nÄƒng suáº¥t thÃ¡ng")) || 0;
    
    console.log('calculateNST - checking row:', {
      need: need,
      rowRate: rowRate,
      currentBest: rate,
      sum: sum,
      condition: sum >= need
    });
    
    if(sum >= need && rowRate >= rate) {
      rate = rowRate;
    }
  }
  
  // 3. TÃNH Káº¾T QUáº¢ CUá»I CÃ™NG
  const result = fycT * rate * heSo;
  
  console.log('calculateNST - CALCULATION:', {
    fycT: fycT,
    rate: rate,
    heSo: heSo,
    result: result
  });
  
  // 4. HIá»‚N THá»Š THEO Äá»ŠNH Dáº NG YÃŠU Cáº¦U
  document.getElementById("thuong-nst").value = formatMoney3(result);
}
function calculateNSQ(){
  // 1. CHUYá»‚N Äá»”I Dá»® LIá»†U Vá»€ Sá» TRÆ¯á»šC KHI TÃNH
  const m = parseInt(document.getElementById("month-select").value, 10) || 0;
  const th = parseInt(document.getElementById("thang-lam-viec").value, 10) || 0;
  const cur = parseMoney3(document.getElementById("tong-fyc-quy").value) || 0;
  const fycT = parseMoney3(document.getElementById("fyc-thuong").value) || 0;
  const heSo = parseFloat(document.getElementById("he-so-thuong").value) || 1;
  const nh = (document.getElementById("nhom-dai-ly").value || "").trim();
  
  console.log('calculateNSQ - INPUT VALUES:', {
    month: m,
    thangLamViec: th,
    tongFYCQuy: cur,
    fycThuong: fycT,
    heSo: heSo,
    nhomDaiLy: nh
  });
  
  // 2. KIá»‚M TRA ÄIá»€U KIá»†N THÃNG QUÃ
  if(![3,6,9,12].includes(m)){
    console.log('calculateNSQ - not a quarter month, setting to 0');
    document.getElementById("thuong-nsq").value = formatMoney3(0);
    return;
  }
  
  // 3. THá»°C HIá»†N LOGIC TÃNH TOÃN Vá»šI Sá»
  const sum = fycT + cur;
  const table = th <= 6 ? nsq6 : nsq7;
  const nA = rmAccent(nh);
  
  console.log('calculateNSQ - CALCULATION SETUP:', {
    sum: sum,
    table: th <= 6 ? 'nsq6' : 'nsq7',
    tableData: table,
    nhomNormalized: nA
  });
  
  let tl = 0;
  for(const row of table){
    const need = parseMoney3(getByKeyLoose(row, "FYC cá»§a quÃ½ xÃ©t thÆ°á»Ÿng")) || 0;
    
    console.log('calculateNSQ - checking row:', {
      need: need,
      currentSum: sum,
      currentBest: tl,
      condition: sum >= need
    });
    
    if(sum >= need){
      const keys = normKeyMap(row);
      let val = (/manulife\s*pro/i.test(nA) || /manulife$/i.test(nA)) ? 
                 row[keys['MANULIFE']] : 
                 (row[keys['DLTHUONG']] || row[keys['DAILY']]);
      
      if(typeof val === 'string') val = val.replace('%', '');
      const r = (parseFloat(val) || 0) / 100;
      
      console.log('calculateNSQ - found rate:', {
        originalValue: val,
        rate: r,
        availableKeys: Object.keys(keys)
      });
      
      if(r >= tl) tl = r;
    }
  }
  
  // 4. TÃNH Káº¾T QUáº¢ CUá»I CÃ™NG
  const result = sum * tl * heSo;
  
  console.log('calculateNSQ - FINAL CALCULATION:', {
    sum: sum,
    tyLe: tl,
    heSo: heSo,
    result: result
  });
  
  // 5. HIá»‚N THá»Š THEO Äá»ŠNH Dáº NG YÃŠU Cáº¦U
  document.getElementById("thuong-nsq").value = formatMoney3(result);
}
function calculateThuongMDRT(){
  const alertEl = document.getElementById('alert-mdrt');
  const setAlert = msg => { 
    if(alertEl){ 
      alertEl.textContent = msg || ''; 
      alertEl.style.display = msg ? 'block' : 'none'; 
    } 
  };

  // 1. CHUYá»‚N Äá»”I Dá»® LIá»†U Vá»€ Sá» TRÆ¯á»šC KHI TÃNH
  const m = parseInt(document.getElementById("month-select").value, 10) || 0; // ThÃ¡ng ngÆ°á»i dÃ¹ng chá»n
  const currentMonth = new Date().getMonth() + 1; // ThÃ¡ng thá»±c táº¿ hiá»‡n táº¡i
  const activeMonths = parseInt((document.getElementById("active-months").value || '').replace(/[^\d]/g, ''), 10) || 0;
  const currentCC = parseInt((document.getElementById("tong-cc").value || '').replace(/[^\d]/g, ''), 10) || 0;
  const toDate = parseMoney3(document.getElementById("mdrt-fyp").value) || 0;
  const thisM = parseMoney3(document.getElementById("tong-fyp").value) || 0;
  
  console.log('calculateThuongMDRT - INPUT VALUES:', {
    selectedMonth: m,
    currentMonth: currentMonth,
    activeMonths: activeMonths,
    currentCC: currentCC,
    toDateFYP: toDate,
    thisMonthFYP: thisM
  });
  
  // 2. KIá»‚M TRA ÄIá»€U KIá»†N THÃNG QUÃ
  if(![3,6,9,12].includes(m)){ 
    console.log('calculateThuongMDRT - not a quarter month, setting to 0');
    document.getElementById("thuong-mdrt").value = formatMoney3(0); 
    setAlert(''); 
    return; 
  }

  // 3. LOGIC Cáº¢NH BÃO THÃ”NG MINH Dá»°A TRÃŠN THÃNG THá»°C Táº¾
  let alertMessage = '';
  
  // XÃ¡c Ä‘á»‹nh quÃ½ vÃ  vá»‹ trÃ­ thÃ¡ng trong quÃ½
  let quarter, monthPosition;
  if (currentMonth >= 1 && currentMonth <= 3) {
    quarter = 1; monthPosition = currentMonth;
  } else if (currentMonth >= 4 && currentMonth <= 6) {
    quarter = 2; monthPosition = currentMonth - 3;
  } else if (currentMonth >= 7 && currentMonth <= 9) {
    quarter = 3; monthPosition = currentMonth - 6;
  } else {
    quarter = 4; monthPosition = currentMonth - 9;
  }
  
  console.log('calculateThuongMDRT - QUARTER ANALYSIS:', {
    quarter: quarter,
    monthPosition: monthPosition,
    isQuarterEnd: monthPosition === 3,
    isQuarterStart: monthPosition === 1,
    isQuarterMiddle: monthPosition === 2
  });
  
  // TrÆ°á»ng há»£p 1: ThÃ¡ng thá»±c táº¿ lÃ  thÃ¡ng cuá»‘i quÃ½, trÃ¹ng vá»›i thÃ¡ng chá»n
  if (monthPosition === 3 && m === currentMonth) {
    if (activeMonths >= 2) {
      // TÃ­nh thÆ°á»Ÿng bÃ¬nh thÆ°á»ng
      alertMessage = '';
    } else {
      alertMessage = 'KhÃ´ng Ä‘á»§ tiÃªu chuáº©n nháº­n thÆ°á»Ÿng tiáº¿n Ä‘á»™';
    }
  }
  // TrÆ°á»ng há»£p 2: ThÃ¡ng thá»±c táº¿ lÃ  thÃ¡ng Ä‘áº§u quÃ½, khÃ´ng trÃ¹ng vá»›i thÃ¡ng chá»n
  else if (monthPosition === 1 && m !== currentMonth) {
    const monthsNeeded = 3 - activeMonths;
    alertMessage = `Báº¡n cáº§n thÃªm ${monthsNeeded} thÃ¡ng cÃ³ hoáº¡t Ä‘á»™ng Ä‘á»ƒ nháº­n thÆ°á»Ÿng (bao gá»“m thÃ¡ng hiá»‡n táº¡i)`;
  }
  // TrÆ°á»ng há»£p 3: ThÃ¡ng thá»±c táº¿ lÃ  thÃ¡ng thá»© 2 cá»§a quÃ½
  else if (monthPosition === 2) {
    // Cáº§n kiá»ƒm tra thÃ¡ng thá»© 1 cÃ³ hoáº¡t Ä‘á»™ng khÃ´ng
    // Láº¥y dá»¯ liá»‡u tá»« income.json Ä‘á»ƒ kiá»ƒm tra
    const found = data.find(r => eqAgent(getByKeyLoose(r,"MÃ£ Äáº¡i lÃ½"), document.getElementById("agent-id").value));
    if (found) {
      const currentMonthReal = new Date().getMonth() + 1;
      let month1, month2, month3;
      
      if (currentMonthReal >= 1 && currentMonthReal <= 3) {
        month1 = 1; month2 = 2; month3 = 3;
      } else if (currentMonthReal >= 4 && currentMonthReal <= 6) {
        month1 = 4; month2 = 5; month3 = 6;
      } else if (currentMonthReal >= 7 && currentMonthReal <= 9) {
        month1 = 7; month2 = 8; month3 = 9;
      } else {
        month1 = 10; month2 = 11; month3 = 12;
      }
      
      const activeMonth1 = parseActiveValue(getByKeyLoose(found, "Active T-1"));
      
      if (activeMonth1 > 0) {
        const monthsNeeded = 3 - activeMonths;
        alertMessage = `Báº¡n cáº§n thÃªm ${monthsNeeded} thÃ¡ng cÃ³ hoáº¡t Ä‘á»™ng Ä‘á»ƒ nháº­n thÆ°á»Ÿng`;
      } else {
        alertMessage = 'KhÃ´ng Ä‘áº¡t chuáº©n';
      }
    }
  }
  
    // 4. LOGIC TÃNH THÆ¯á»NG Dá»°A TRÃŠN ÄIá»€U KIá»†N THÃ”NG MINH
  let canCalculateReward = false;
  let finalAlertMessage = '';
  
  // TrÆ°á»ng há»£p 1: ThÃ¡ng thá»±c táº¿ lÃ  thÃ¡ng cuá»‘i quÃ½, trÃ¹ng vá»›i thÃ¡ng chá»n
  if (monthPosition === 3 && m === currentMonth) {
    if (activeMonths >= 2) {
      canCalculateReward = true;
      finalAlertMessage = '';
    } else {
      canCalculateReward = false;
      finalAlertMessage = 'KhÃ´ng Ä‘á»§ tiÃªu chuáº©n nháº­n thÆ°á»Ÿng tiáº¿n Ä‘á»™';
    }
  }
  // TrÆ°á»ng há»£p 2: ThÃ¡ng thá»±c táº¿ lÃ  thÃ¡ng Ä‘áº§u quÃ½, khÃ´ng trÃ¹ng vá»›i thÃ¡ng chá»n
  else if (monthPosition === 1 && m !== currentMonth) {
    canCalculateReward = false;
    const monthsNeeded = 3 - activeMonths;
    finalAlertMessage = `Báº¡n cáº§n thÃªm ${monthsNeeded} thÃ¡ng cÃ³ hoáº¡t Ä‘á»™ng Ä‘á»ƒ nháº­n thÆ°á»Ÿng (bao gá»“m thÃ¡ng hiá»‡n táº¡i)`;
  }
  // TrÆ°á»ng há»£p 3: ThÃ¡ng thá»±c táº¿ lÃ  thÃ¡ng thá»© 2 cá»§a quÃ½
  else if (monthPosition === 2) {
    // Cáº§n kiá»ƒm tra thÃ¡ng thá»© 1 cÃ³ hoáº¡t Ä‘á»™ng khÃ´ng
    const found = data.find(r => eqAgent(getByKeyLoose(r,"MÃ£ Äáº¡i lÃ½"), document.getElementById("agent-id").value));
    if (found) {
      const currentMonthReal = new Date().getMonth() + 1;
      let month1, month2, month3;
      
      if (currentMonthReal >= 1 && currentMonthReal <= 3) {
        month1 = 1; month2 = 2; month3 = 3;
      } else if (currentMonthReal >= 4 && currentMonthReal <= 6) {
        month1 = 4; month2 = 5; month3 = 6;
      } else if (currentMonthReal >= 7 && currentMonthReal <= 9) {
        month1 = 7; month2 = 8; month3 = 9;
      } else {
        month1 = 10; month2 = 11; month3 = 12;
      }
      
      const activeMonth1 = parseActiveValue(getByKeyLoose(found, "Active T-1"));
      
      if (activeMonth1 > 0) {
        canCalculateReward = false;
        const monthsNeeded = 3 - activeMonths;
        finalAlertMessage = `Báº¡n cáº§n thÃªm ${monthsNeeded} thÃ¡ng cÃ³ hoáº¡t Ä‘á»™ng Ä‘á»ƒ nháº­n thÆ°á»Ÿng`;
      } else {
        canCalculateReward = false;
        finalAlertMessage = 'KhÃ´ng Ä‘áº¡t chuáº©n';
      }
    }
  }
  
  // Kiá»ƒm tra Ä‘iá»u kiá»‡n cÆ¡ báº£n
  if(currentCC < 1){ 
    console.log('calculateThuongMDRT - no contracts this month');
    document.getElementById("thuong-mdrt").value = formatMoney3(0); 
    setAlert('ChÆ°a cÃ³ há»£p Ä‘á»“ng trong thÃ¡ng xÃ©t'); 
    return; 
  }
  
  // Náº¿u khÃ´ng thá»ƒ tÃ­nh thÆ°á»Ÿng theo logic thÃ´ng minh
  if (!canCalculateReward) {
    console.log('calculateThuongMDRT - cannot calculate reward based on smart logic');
    document.getElementById("thuong-mdrt").value = formatMoney3(0); 
    setAlert(finalAlertMessage); 
    return; 
  }
  
  // Náº¿u cÃ³ thá»ƒ tÃ­nh thÆ°á»Ÿng, tiáº¿p tá»¥c logic cÅ©
  setAlert(finalAlertMessage || '');
  
  // 5. THá»°C HIá»†N LOGIC TÃNH TOÃN Vá»šI Sá»
  const progress = toDate + thisM;
  
  console.log('calculateThuongMDRT - CALCULATION SETUP:', {
    toDate: toDate,
    thisMonth: thisM,
    totalProgress: progress
  });
  
  const row = trackingMDRT.find(r => parseInt(getByKeyLoose(r, 'ThÃ¡ng xÃ©t'), 10) === m);
  console.log('calculateThuongMDRT - found tracking row:', row);
  
  if(!row){ 
    console.log('calculateThuongMDRT - no tracking data for month', m);
    document.getElementById("thuong-mdrt").value = formatMoney3(0); 
    return; 
  }
  
  const need = parseMoney3(getByKeyLoose(row, 'FYP YÃŠU Cáº¦U')) || 0;
  const muc1 = parseMoney3(getByKeyLoose(row, 'Má»¨C 1 THáº¤P')) || 
                parseMoney3(getByKeyLoose(row, 'MÃšC 1 THáº¤P')) || 
                parseMoney3(getByKeyLoose(row, 'MUC 1 THAP')) || 0;
  const muc2 = parseMoney3(getByKeyLoose(row, 'Má»¨C 2 CAO')) || 
                parseMoney3(getByKeyLoose(row, 'MUC 2 CAO')) || 0;
  
  console.log('calculateThuongMDRT - TRACKING DATA:', {
    requiredFYP: need,
    level1Reward: muc1,
    level2Reward: muc2
  });
  
  // 6. TÃNH Káº¾T QUáº¢ CUá»I CÃ™NG
  let thuong = 0; 
  if(need > 0 && progress > 0){
    const tl = progress / need; 
    console.log('calculateThuongMDRT - progress ratio:', tl);
    
    if(tl >= 1) thuong = muc2; 
    else if(tl >= 0.9) thuong = muc1;
  }
  
  console.log('calculateThuongMDRT - FINAL RESULT:', {
    progressRatio: progress / need,
    finalReward: thuong
  });
  
  // 7. HIá»‚N THá»Š THEO Äá»ŠNH Dáº NG YÃŠU Cáº¦U
  document.getElementById("thuong-mdrt").value = formatMoney3(thuong);
}

/* ===== TOTAL (A) & D (A+B+C) ===== */
function calculateTongThuNhap(){
  const v=id=>parseMoney3(document.getElementById(id).value);
  const sum=v("fyc-chinh")+v("fyc-kem")+v("thuong-kem")+v("fyc-thuong")+v("thuong-nspro")+v("thuong-nst")+v("thuong-nsq")+v("thuong-memo")+v("thuong-mdrt");
  document.getElementById("tong-thu-nhap").value=formatMoney3(sum);
  const tongFYP=parseMoney3(document.getElementById("tong-fyp").value);
  document.getElementById("ty-le-thu-nhap").value=tongFYP>0?((sum/tongFYP)*100).toFixed(2)+" %":"";
  updateCombinedTotals(); reformatMoneyOutputs(); syncReadonlyTitles();
}
function updateCombinedTotals(){
  const A = parseMoney3(document.getElementById("tong-thu-nhap").value);
  const B = parseMoney3(document.getElementById("thu-nhap-tuyen-dung")?document.getElementById("thu-nhap-tuyen-dung").value:0);
  const C = parseMoney3(document.getElementById("thu-nhap-quan-ly")?document.getElementById("thu-nhap-quan-ly").value:0);
  const elA=document.getElementById("tong-A"); if(elA) elA.value=formatMoney3(A);
  const elB=document.getElementById("tong-B"); if(elB) elB.value=formatMoney3(B);
  const elC=document.getElementById("tong-C"); if(elC) elC.value=formatMoney3(C);
  const elABC=document.getElementById("tong-ABC"); if(elABC) elABC.value=formatMoney3(A+B+C);
}

/* ===== INPUT MODES ===== */
function autoFormatInputs(){
  MONEY_INPUT_IDS_EDITABLE.forEach(id=>{const el=document.getElementById(id); if(!el)return;
    el.addEventListener('input',()=>{el.value=el.value.replace(/[^\d\.,]/g,'')});
    el.addEventListener('blur',()=>{const n=parseMoney3(el.value); el.value=n?formatMoney3(n):''; updateTongHop(); calculateIncome();});
  });
  COUNT_INPUT_IDS_EDITABLE.forEach(id=>{const el=document.getElementById(id); if(!el)return;
    el.addEventListener('input',()=>{el.value=el.value.replace(/[^\d]/g,'')});
    el.addEventListener('blur',()=>{el.value=el.value?String(parseInt(el.value,10)):''; updateTongHop(); calculateIncome();});
  });
}
function sanitizeAllNumericInputs(){ALL_MONEY_IDS.forEach(id=>{const el=document.getElementById(id); if(el)el.setAttribute('type','text')});}
function reformatMoneyOutputs(){for(const id of MONEY_OUTPUT_IDS){const el=document.getElementById(id); if(!el)continue; const n=parseMoney3(el.value); el.value=formatMoney3(n||0)}}
function syncReadonlyTitles(){document.querySelectorAll('input[readonly]').forEach(el=>el.title=el.value||'');}

/* ===== NAV + SECTION HIá»‚N THá»Š ===== */
function getOffsets(){
  const head=document.getElementById('pageHeader');
  const toc=document.getElementById('tocMobile');
  const h = head ? Math.ceil(head.getBoundingClientRect().height) : 64;
  let t = 0;
  if(toc && getComputedStyle(toc).display!=='none'){
    t = Math.ceil(toc.getBoundingClientRect().height);
  }
  return {h,t};
}
function showSection(id){
  // 1) áº¨n/hiá»‡n section
  document.querySelectorAll('.app-section').forEach(s=>s.style.display='none');
  const target=document.getElementById(id);
  if(target) target.style.display='block';

  // 2) Active trÃªn sidebar (desktop)
  document.querySelectorAll('#sidebar .menu-item').forEach(a=>a.classList.remove('active'));
  const a=document.querySelector(`#sidebar .menu-item[data-target="${id}"]`); if(a) a.classList.add('active');

  // 3) Äá»“ng bá»™ dropdown mobile
  const sel=document.getElementById('tocSelect');
  if(sel){ for(const o of sel.options){ if(o.value===id){ sel.value=id; break; } } }

  // 4) Cáº­p nháº­t chiá»u cao header/toc Ä‘á»ƒ tÃ­nh offset
  setLayoutVars();

  // 5) CUá»˜N: luÃ´n Ä‘Æ°a Ä‘áº§u má»¥c lÃªn ngay dÆ°á»›i header + dropdown (trÃªn Ä‘iá»‡n thoáº¡i)
  if(target){
    const {h,t}=getOffsets();
    const offset=h + t + 6; // 6px Ä‘á»‡m
    const y = target.getBoundingClientRect().top + window.scrollY - offset;
    window.scrollTo({ top: Math.max(0,y), behavior:'smooth' });
  }
}
function bindSidebar(){
  document.querySelectorAll('#sidebar .menu-item[data-target]').forEach(a=>{
    a.addEventListener('click',e=>{e.preventDefault(); const id=a.getAttribute('data-target'); if(id) showSection(id);});
  });
}
function buildMobileTOC(){
  const sel=document.getElementById('tocSelect'); if(!sel) return;
  sel.innerHTML='';
  document.querySelectorAll('#sidebar .menu-item[data-target]').forEach(a=>{
    const id=a.getAttribute('data-target'), text=a.textContent.trim();
    const op=document.createElement('option'); op.value=id; op.textContent=text; sel.appendChild(op);
  });
  sel.addEventListener('change',()=>{ showSection(sel.value); });
}

/* ===== SEARCH / LOGIN ===== */
function searchAgent(){
  const idRaw=(document.getElementById("agent-id").value||'').trim();
  const ngayRaw=(document.getElementById("ngay-gia-nhap").value||'').trim();
  if(!isDataReady){alert("KhÃ´ng táº£i Ä‘Æ°á»£c dá»¯ liá»‡u (income.json).");return}
  if(!idRaw){alert("Vui lÃ²ng nháº­p MÃ£ sá»‘ Ä‘áº¡i lÃ½");return}
  if(!ngayRaw){alert("Vui lÃ²ng nháº­p NgÃ y gia nháº­p");return}
  const ngayKey=normalizeDateForCompare(ngayRaw); if(!ngayKey){alert("NgÃ y gia nháº­p khÃ´ng há»£p lá»‡.");return}
  if(/^\d{8}$/.test(ngayRaw)){const d=ngayRaw.slice(0,2),m=ngayRaw.slice(2,4),y=ngayRaw.slice(4,8); document.getElementById("ngay-gia-nhap").value=`${d}/${m}/${y}`;}
  const same=data.filter(r=>eqAgent(getByKeyLoose(r,"MÃ£ Äáº¡i lÃ½"), idRaw));
  const found=same.find(r=>datesEqual(getByKeyLoose(r,"NgÃ y gia nháº­p"), ngayRaw));
  if(!found){alert("Äáº¡i lÃ½ khÃ´ng thuá»™c há»‡ thá»‘ng");return}

  // Hiá»ƒn thá»‹ loading screen
  showLoadingScreen();
  
  // Hiá»ƒn thá»‹ banner chÃ o má»«ng sau 1 giÃ¢y
  setTimeout(() => {
    hideLoadingScreen();
    
    // Cáº­p nháº­t tÃªn trong banner
    const welcomeName = document.getElementById('welcomeName');
    if (welcomeName) {
      const hoTen = getByKeyLoose(found, "TÃªn Äáº¡i lÃ½") || '';
      welcomeName.textContent = `${idRaw}_${hoTen}`;
    }
    
    // Hiá»ƒn thá»‹ banner
    const welcomeBanner = document.getElementById('welcomeBanner');
    if (welcomeBanner) {
      welcomeBanner.style.display = 'block';
    }
    
    // Hiá»ƒn thá»‹ update date mobile
    const mobileUpdateDate = document.getElementById('mobileUpdateDate');
    if (mobileUpdateDate) {
      mobileUpdateDate.style.display = 'block';
      const mobileUpdateDateText = document.getElementById('mobileUpdateDateText');
      if (mobileUpdateDateText) {
        // TÃ¬m kiáº¿m ngÃ y chá»‘t tá»« dá»¯ liá»‡u thá»±c táº¿ (income.json khÃ´ng cÃ³ cá»™t nÃ y)
        // Sáº½ sá»­ dá»¥ng fallback: ngÃ y cuá»‘i cÃ¹ng cá»§a thÃ¡ng liá»n trÆ°á»›c
        const ngayChot = getByKeyLoose(found, "NGAY CHOT DATA") || 
                         getByKeyLoose(found, "NGAY CHOT") || 
                         getByKeyLoose(found, "NGAY CAP NHAT") ||
                         getByKeyLoose(found, "NGAY Cáº¬P NHáº¬T");
        
        if (ngayChot) {
          // Hiá»ƒn thá»‹ ngÃ y chá»‘t tá»« dá»¯ liá»‡u thá»±c táº¿
          mobileUpdateDateText.textContent = ngayChot;
        } else {
          // Fallback: Láº¥y ngÃ y cuá»‘i cÃ¹ng cá»§a thÃ¡ng liá»n trÆ°á»›c (thá»±c táº¿)
          const now = new Date();
          // TÃ­nh thÃ¡ng liá»n trÆ°á»›c (thÃ¡ng hiá»‡n táº¡i - 1)
          let lastMonthYear = now.getFullYear();
          let lastMonthMonth = now.getMonth() - 1;
          
          // Xá»­ lÃ½ trÆ°á»ng há»£p thÃ¡ng 1 (thÃ¡ng 0)
          if (lastMonthMonth < 0) {
            lastMonthMonth = 11; // ThÃ¡ng 12
            lastMonthYear = now.getFullYear() - 1; // NÄƒm trÆ°á»›c
          }
          
          // Láº¥y ngÃ y cuá»‘i cÃ¹ng cá»§a thÃ¡ng liá»n trÆ°á»›c
          const lastDayOfLastMonth = new Date(lastMonthYear, lastMonthMonth + 1, 0);
          mobileUpdateDateText.textContent = lastDayOfLastMonth.toLocaleDateString('vi-VN');
        }
      }
    }
    
    // Hiá»ƒn thá»‹ update date desktop
    const sidebarUpdateInfo = document.getElementById('sidebarUpdateInfo');
    const sidebarUpdateDate = document.getElementById('sidebarUpdateDate');
    if (sidebarUpdateInfo && sidebarUpdateDate) {
      sidebarUpdateInfo.style.display = 'block';
      sidebarUpdateDate.style.display = 'block';
      
      const sidebarUpdateDateText = document.getElementById('sidebarUpdateDateText');
      if (sidebarUpdateDateText) {
        // TÃ¬m kiáº¿m ngÃ y chá»‘t tá»« dá»¯ liá»‡u thá»±c táº¿ (income.json khÃ´ng cÃ³ cá»™t nÃ y)
        // Sáº½ sá»­ dá»¥ng fallback: ngÃ y cuá»‘i cÃ¹ng cá»§a thÃ¡ng liá»n trÆ°á»›c
        const ngayChot = getByKeyLoose(found, "NGAY CHOT DATA") || 
                         getByKeyLoose(found, "NGAY CHOT") || 
                         getByKeyLoose(found, "NGAY CAP NHAT") ||
                         getByKeyLoose(found, "NGAY Cáº¬P NHáº¬T");
        
        if (ngayChot) {
          // Hiá»ƒn thá»‹ ngÃ y chá»‘t tá»« dá»¯ liá»‡u thá»±c táº¿
          sidebarUpdateDateText.textContent = ngayChot;
        } else {
          // Fallback: Láº¥y ngÃ y cuá»‘i cÃ¹ng cá»§a thÃ¡ng liá»n trÆ°á»›c (thá»±c táº¿)
          const now = new Date();
          // TÃ­nh thÃ¡ng liá»n trÆ°á»›c (thÃ¡ng hiá»‡n táº¡i - 1)
          let lastMonthYear = now.getFullYear();
          let lastMonthMonth = now.getMonth() - 1;
          
          // Xá»­ lÃ½ trÆ°á»ng há»£p thÃ¡ng 1 (thÃ¡ng 0)
          if (lastMonthMonth < 0) {
            lastMonthMonth = 11; // ThÃ¡ng 12
            lastMonthYear = now.getFullYear() - 1; // NÄƒm trÆ°á»›c
          }
          
          // Láº¥y ngÃ y cuá»‘i cÃ¹ng cá»§a thÃ¡ng liá»n trÆ°á»›c
          const lastDayOfLastMonth = new Date(lastMonthYear, lastMonthMonth + 1, 0);
          sidebarUpdateDateText.textContent = lastDayOfLastMonth.toLocaleDateString('vi-VN');
        }
      }
    }
  }, 1000);

  document.getElementById("ho-ten").value=getByKeyLoose(found,"TÃªn Äáº¡i lÃ½")||'';
  document.getElementById("khu-vuc").value=getByKeyLoose(found,"Khu vá»±c")||'';
  document.getElementById("thang-lam-viec").value=parseActiveValue(getByKeyLoose(found,"Sá»‘ thÃ¡ng lÃ m viá»‡c"));
  document.getElementById("nhom-dai-ly").value=getByKeyLoose(found,"NhÃ³m Äáº¡i lÃ½")||'';
  const p13=parseActiveValue(getByKeyLoose(found,"TLDTHD cÃ¡ nhÃ¢n") ?? getByKeyLoose(found,"P13 cÃ¡ nhÃ¢n"));
  document.getElementById("p13-ca-nhan").value=Number.isFinite(p13)&&p13!==0?p13:'';
  document.getElementById("he-so-thuong").value=getHeSoThuong(p13);
  document.getElementById("mdrt-fyp").value=formatMoney3(parseActiveValue(getByKeyLoose(found,"MDRT-FYP tá»›i hiá»‡n táº¡i")));
  const fycT1=parseActiveValue(getByKeyLoose(found,"FYC thÃ¡ng T-1"));
  const fycT2=parseActiveValue(getByKeyLoose(found,"FYC thÃ¡ng T-2"));
  document.getElementById("tong-fyc").value=formatMoney3(fycT1+fycT2);
  document.getElementById("tong-fyc-quy").value=formatMoney3(parseActiveValue(getByKeyLoose(found,"Tá»•ng FYC trong QÃºy hiá»‡n táº¡i")));
  // TÃ­nh sá»‘ thÃ¡ng cÃ³ hoáº¡t Ä‘á»™ng trong quÃ½ dá»±a trÃªn thÃ¡ng hiá»‡n táº¡i
  // Logic: T lÃ  thÃ¡ng hiá»‡n táº¡i, suy ra T-1 vÃ  T-2 theo quÃ½
  const currentMonth = new Date().getMonth() + 1; // ThÃ¡ng hiá»‡n táº¡i (1-12)
  
  // XÃ¡c Ä‘á»‹nh quÃ½ hiá»‡n táº¡i vÃ  cÃ¡c thÃ¡ng cáº§n xÃ©t
  let month1, month2, month3;
  
  if (currentMonth >= 1 && currentMonth <= 3) {
    // QuÃ½ 1: thÃ¡ng 1, 2, 3
    month1 = 1; month2 = 2; month3 = 3;
  } else if (currentMonth >= 4 && currentMonth <= 6) {
    // QuÃ½ 2: thÃ¡ng 4, 5, 6
    month1 = 4; month2 = 5; month3 = 6;
  } else if (currentMonth >= 7 && currentMonth <= 9) {
    // QuÃ½ 3: thÃ¡ng 7, 8, 9
    month1 = 7; month2 = 8; month3 = 9;
  } else {
    // QuÃ½ 4: thÃ¡ng 10, 11, 12
    month1 = 10; month2 = 11; month3 = 12;
  }
  
  // GÃ¡n giÃ¡ trá»‹ cho Active T, T-1, T-2 dá»±a trÃªn thÃ¡ng hiá»‡n táº¡i
  let activeT, activeT1, activeT2;
  
  if (currentMonth === month1) {
    // ThÃ¡ng Ä‘áº§u quÃ½: chá»‰ xÃ©t thÃ¡ng hiá»‡n táº¡i
    activeT = getByKeyLoose(found, "Active T");
    activeT1 = 0; activeT2 = 0;
  } else if (currentMonth === month2) {
    // ThÃ¡ng giá»¯a quÃ½: xÃ©t 2 thÃ¡ng Ä‘áº§u quÃ½
    activeT = getByKeyLoose(found, "Active T");
    activeT1 = getByKeyLoose(found, "Active T-1");
    activeT2 = 0;
  } else {
    // ThÃ¡ng cuá»‘i quÃ½: xÃ©t cáº£ 3 thÃ¡ng cá»§a quÃ½
    activeT = getByKeyLoose(found, "Active T");
    activeT1 = getByKeyLoose(found, "Active T-1");
    activeT2 = getByKeyLoose(found, "Active T-2");
  }
  

  
  const activeTNum = parseActiveValue(activeT);
  const activeT1Num = parseActiveValue(activeT1);
  const activeT2Num = parseActiveValue(activeT2);
  
  // Äáº¿m sá»‘ thÃ¡ng cÃ³ hoáº¡t Ä‘á»™ng (giÃ¡ trá»‹ > 0)
  let activeMonthsCount = 0;
  if (activeTNum > 0) activeMonthsCount++;
  if (activeT1Num > 0) activeMonthsCount++;
  if (activeT2Num > 0) activeMonthsCount++;
  
  document.getElementById("active-months").value = activeMonthsCount.toString();

  ["sohd-gd1","sohd-gd2","sohd-gd3","fypchinh-gd1","fypchinh-gd2","fypchinh-gd3","fypkem-gd1","fypkem-gd2","fypkem-gd3"].forEach(id=>{const el=document.getElementById(id); if(el) el.value='';});
  sanitizeAllNumericInputs(); 
  updateTongHop(); // updateTongHop() Ä‘Ã£ bao gá»“m táº¥t cáº£ cÃ¡c hÃ m tÃ­nh thÆ°á»Ÿng
  calculateTongThuNhap(); // TÃ­nh tá»•ng thu nháº­p cuá»‘i cÃ¹ng
  syncReadonlyTitles();

  isLoggedIn=true;
  // Báº­t giao diá»‡n sau Ä‘Äƒng nháº­p
  document.body.classList.remove('logged-out');
  document.body.classList.add('logged-in');
  applySidebarMode(); // chá»‰ báº­t sidebar trÃªn desktop
  buildMobileTOC();
  showSection('sec-daily');
  setLayoutVars();          // cáº­p nháº­t header/toc/footer height Ä‘á»ƒ Ä‘áº©y ná»™i dung xuá»‘ng dÆ°á»›i Ä‘Ãºng chuáº©n
}

/* ===== ENTER TO CALC ===== */
function enableEnterToCalc(){
  document.addEventListener('keydown', (e)=>{
    if(e.key!=='Enter') return;
    if(!isLoggedIn) return;
    const ae=document.activeElement;
    if(ae && (ae.id==='agent-id' || ae.id==='ngay-gia-nhap')) return;
    e.preventDefault();
    const btn=document.getElementById('calc-btn');
    if(btn) btn.click();
  });
}

/* ===== LAYOUT VARS ===== */
function setLayoutVars(){
  const head=document.getElementById('pageHeader');
  const footer=document.getElementById('pageFooter');
  const toc=document.getElementById('tocMobile');
  const h = head ? Math.ceil(head.getBoundingClientRect().height) : 64;
  const f = footer ? Math.ceil(footer.getBoundingClientRect().height) : 66;
  let t = 0;
  if(toc && getComputedStyle(toc).display!=='none'){
    t = Math.ceil(toc.getBoundingClientRect().height);
  }
  document.documentElement.style.setProperty('--header-h', h+'px');
  document.documentElement.style.setProperty('--footer-h', f+'px');
  document.documentElement.style.setProperty('--toc-h', t+'px');
}
function applySidebarMode(){
  if(!document.body.classList.contains('logged-in')) return;
  if(window.matchMedia('(min-width:1024px)').matches){
    document.body.classList.add('sidebar-open');
  }else{
    document.body.classList.remove('sidebar-open');
  }
}

/* ===== Gá»˜P TÃNH THU NHáº¬P ===== */
function calculateIncome(){
  console.log('=== calculateIncome START ===');
  
  // 1. CHUYá»‚N Äá»”I Dá»® LIá»†U Vá»€ Sá» TRÆ¯á»šC KHI TÃNH
  const tongFYP = parseMoney3(document.getElementById('tong-fyp').value) || 0;
  const chinh = parseMoney3(document.getElementById('fyp-chinh').value) || 0;
  const kem = parseMoney3(document.getElementById('fyp-kem').value) || 0;

  console.log('calculateIncome - INPUT VALUES:', {
    tongFYP: tongFYP,
    chinh: chinh,
    kem: kem
  });

  // 2. THá»°C HIá»†N LOGIC TÃNH TOÃN Vá»šI Sá»
  const fycChinh = chinh * 0.3;
  const fycKem = kem * 0.2;
  const thuongKem = kem * 0.2;
  const fycThuong = fycChinh + fycKem + thuongKem;

  console.log('calculateIncome - CALCULATED VALUES:', {
    fycChinh: fycChinh,
    fycKem: fycKem,
    thuongKem: thuongKem,
    fycThuong: fycThuong
  });

  // 3. HIá»‚N THá»Š Káº¾T QUáº¢ THEO Äá»ŠNH Dáº NG YÃŠU Cáº¦U
  document.getElementById('fyc-chinh').value = formatMoney3(fycChinh);
  document.getElementById('fyc-kem').value = formatMoney3(fycKem);
  document.getElementById('thuong-kem').value = formatMoney3(thuongKem);
  document.getElementById('fyc-thuong').value = formatMoney3(fycThuong);

  // 4. Gá»ŒI CÃC HÃ€M TÃNH THÆ¯á»NG KHÃC
  console.log('calculateIncome - calling calculateNSPro()');
  calculateNSPro();
  
  console.log('calculateIncome - calling calculateNST()');
  calculateNST();
  
  console.log('calculateIncome - calling calculateNSQ()');
  calculateNSQ();
  
  console.log('calculateIncome - calling calculateThuongMDRT()');
  calculateThuongMDRT();
  
  console.log('calculateIncome - calling calculateTongThuNhap()');
  calculateTongThuNhap();
  
  console.log('=== calculateIncome END ===');
}

/* ===== LOADING SCREEN FUNCTIONS ===== */
function showLoadingScreen() {
  const loadingScreen = document.getElementById('loadingScreen');
  if (loadingScreen) {
    loadingScreen.style.display = 'flex';
  }
}

function hideLoadingScreen() {
  const loadingScreen = document.getElementById('loadingScreen');
  if (loadingScreen) {
    loadingScreen.style.display = 'none';
  }
}

/* ===== TEST FUNCTIONS ===== */
function testCalculations() {
  console.log('=== TESTING CALCULATIONS ===');
  
  // Kiá»ƒm tra dá»¯ liá»‡u Ä‘Ã£ load
  console.log('Data status:', {
    income: data.length,
    nspro: nspro.length,
    nst6: nst6.length,
    nst7: nst7.length,
    nsq6: nsq6.length,
    nsq7: nsq7.length,
    hsdt: hsdt.length,
    trackingMDRT: trackingMDRT.length
  });
  
  // Test parseMoney3
  console.log('parseMoney3 test:', {
    '1000': parseMoney3('1000'),
    '1,000': parseMoney3('1,000'),
    '1.000': parseMoney3('1.000'),
    'empty': parseMoney3(''),
    'null': parseMoney3(null),
    'undefined': parseMoney3(undefined)
  });
  
  // Test getByKeyLoose
  if(nst6.length > 0) {
    const testRow = nst6[0];
    console.log('getByKeyLoose test with nst6[0]:', {
      original: testRow,
      'FYC trong 3 thÃ¡ng gáº§n nháº¥t': getByKeyLoose(testRow, 'FYC trong 3 thÃ¡ng gáº§n nháº¥t'),
      '% Tá»· lá»‡ thÆ°á»Ÿng nÄƒng suáº¥t thÃ¡ng': getByKeyLoose(testRow, '% Tá»· lá»‡ thÆ°á»Ÿng nÄƒng suáº¥t thÃ¡ng')
    });
  } else {
    console.log('nst6 is empty or not loaded');
  }
  
  // Test normKeyMap
  if(nst6.length > 0) {
    const testRow = nst6[0];
    const keys = normKeyMap(testRow);
    console.log('normKeyMap test:', {
      original: Object.keys(testRow),
      normalized: Object.keys(keys)
    });
  }
  
  // Test vá»›i dá»¯ liá»‡u thá»±c táº¿
  console.log('Testing with real data...');
  if(data.length > 0) {
    console.log('Sample income data:', data[0]);
  }
}

/* ===== INIT ===== */
window.addEventListener('load', async ()=>{
  await loadData();
  
  // Test cÃ¡c hÃ m sau khi load dá»¯ liá»‡u
  setTimeout(() => {
    testCalculations();
  }, 1000);
  
  populateMonthSelect(); sanitizeAllNumericInputs(); autoFormatInputs();
  enableEnterToCalc(); setLayoutVars(); applySidebarMode();
  window.addEventListener('resize', ()=>{ setLayoutVars(); applySidebarMode(); });

  // Chuáº©n hoÃ¡ nháº­p ngÃ y
  const ngay=document.getElementById("ngay-gia-nhap");
  if(ngay){
    ngay.addEventListener('blur',()=>{const v=ngay.value.trim(); if(/^\d{8}$/.test(v)) ngay.value=standardizeDate(v);});
    document.getElementById("agent-id").addEventListener("keydown",e=>{if(e.key==="Enter")searchAgent()});
    ngay.addEventListener("keydown",e=>{if(e.key==="Enter")searchAgent()});
  }

  // Form submit event
  const loginForm = document.getElementById('loginForm');
  if (loginForm) {
    loginForm.addEventListener('submit', (e) => {
      e.preventDefault();
      searchAgent();
    });
  }
  
  // ThÃªm class mobile cho body náº¿u cáº§n
  if (window.matchMedia('(max-width: 1023px)').matches) {
    document.body.classList.add('mobile');
  }
  
  // Mobile menu event listeners
  const mobileMenuBtn = document.getElementById('mobileMenuBtn');
  const mobileLogoutBtn = document.getElementById('mobileLogoutBtn');
  const mobileMenuDropdown = document.getElementById('mobileMenuDropdown');
  
  if (mobileMenuBtn) {
    mobileMenuBtn.addEventListener('click', () => {
      mobileMenuDropdown.style.display = mobileMenuDropdown.style.display === 'none' ? 'block' : 'none';
    });
  }
  
  if (mobileLogoutBtn) {
    mobileLogoutBtn.addEventListener('click', () => {
      location.reload();
    });
  }
  
  // Close dropdown when clicking outside
  document.addEventListener('click', (e) => {
    if (!mobileMenuBtn?.contains(e.target) && !mobileMenuDropdown?.contains(e.target)) {
      if (mobileMenuDropdown) {
        mobileMenuDropdown.style.display = 'none';
      }
    }
  });
  
  // Mobile menu item click handlers
  document.querySelectorAll('.mobile-menu-item').forEach(item => {
    item.addEventListener('click', (e) => {
      e.preventDefault();
      const target = item.getAttribute('data-target');
      if (target) {
        showSection(target);
        if (mobileMenuDropdown) {
          mobileMenuDropdown.style.display = 'none';
        }
      }
    });
  });

  // Sidebar click
  bindSidebar();

  // Máº·c Ä‘á»‹nh áº©n táº¥t cáº£ section khi chÆ°a login
  document.querySelectorAll('.app-section').forEach(s=>s.style.display='none');
});
  </script>
</body>
</html>
  
