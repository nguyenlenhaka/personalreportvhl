<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>BÁO CÁO CÁ NHÂN – Vùng Hằng Lâm</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />

  <!-- Font của dự án -->
  <link rel="stylesheet" href="fonts/fonts.css" />
  <!-- Tailwind (dùng utility nhỏ) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    :root{
      --sidebar-width: 360px;
      --header-h: 64px;
      --footer-h: 66px;
      --toc-h: 0px;          /* chiều cao dropdown mobile (tự tính bằng JS) */
      --brand:#059669; 
      --accent:#00a758;
    }
    /* đảm bảo không tràn ngang trên mọi thiết bị */
    html,body{height:100%;margin:0;background:#f3f4f6;overflow-x:hidden}
    *{box-sizing:border-box;min-width:0}
    .hide{display:none !important;} /* quan trọng: phục vụ show/hide mục */

    /* ===== HEADER (FIXED) ===== */
    .app-header{
      position:fixed; top:0; left:0; right:0; z-index:1000;
      background:#e8fff3; border-bottom:1px solid #d9f7e6;
      padding-top:env(safe-area-inset-top,0px);
    }
    .header-grid{
      display:grid; grid-template-columns: 1fr auto;
      align-items:center; gap:12px; padding:10px 12px;
    }
    .brand-row{ display:flex; align-items:center; gap:10px; min-width:0; }
    .logo-d{ height:70px; width:auto; display:block; flex:0 0 auto; }

    .title-wrap{ display:flex; flex-direction:column; gap:2px; min-width:0; }
    .title-top,.title-main{
      font-family:'Manulife JH Sans','ManulifeJHSans',system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif;
      color:var(--brand); font-weight:800;
      white-space:normal; overflow:visible; text-overflow:clip;
      word-break:keep-all; line-height:1.25; padding-block:2px;
    }
    .title-top{  font-size:clamp(14px, 1vw + 10px, 22px); text-transform:uppercase; }
    .title-main{ font-size:clamp(18px, 1.8vw + 12px, 34px); }

    /* ===== LOGIN / LOGOUT ===== */
    .login-cluster{ display:grid; gap:.5rem; align-items:center; grid-template-columns: 1fr; width:min(560px, 100%); justify-self:end; }
    .login-cluster input{ height:44px; padding:0 12px; font-size:16px; border:1.3px solid #b7e7ce; border-radius:10px; background:#effaf3; font-weight:600; color:#0d7233; outline:none; width:100%; }
    .login-btn{ height:44px; padding:0 18px; background:#008a53; color:#fff; border:none; border-radius:10px; font-weight:800; cursor:pointer; touch-action:manipulation; }
    .login-btn:hover{ background:#066a42; }
    .logout-only{ display:none !important; }
    body.logged-in .login-only{ display:none !important; }
    body.logged-in .logout-only{ display:block !important; }

    /* ===== SIDEBAR (DESKTOP) ===== */
    #sidebar{ position:fixed; left:0; top:var(--header-h); bottom:var(--footer-h); width:var(--sidebar-width); background:#fff; border-right:1px solid #e5e7eb; z-index:900; overflow-y:auto; overflow-x:hidden; display:none; }
    .sidebar-inner{ padding:12px; }
    .menu-title{ font-weight:900; color:#065f46; margin:6px 8px 8px; white-space:normal; line-height:1.25; }
    .menu-group{ margin:12px 0 6px 8px; font-weight:900; color:#0b3d2c; white-space:normal; line-height:1.25; }
    .menu-item{ display:block; padding:.55rem .75rem; border-radius:.55rem; font-weight:800; color:#0b3d2c; white-space:normal; overflow-wrap:anywhere; word-break:break-word; line-height:1.25; font-size:0.96rem; }
    .menu-item:hover{ background:#e5f7ee; }
    .menu-item.active{ background:#0ea35b; color:#fff; }
    .submenu{ margin:.25rem 0 .5rem .75rem; }
    .submenu .menu-item{ padding:.45rem .6rem; }

    /* ===== MOBILE TOC (dropdown chỉ cho mobile) ===== */
    #tocMobile{ position:fixed; top:var(--header-h); left:0; right:0; z-index:880; background:#fff; padding:10px 10px 6px; border-bottom:1px solid #e5e7eb; display:none; will-change:top; }
    #tocMobile .row{ display:flex; gap:8px; }
    #tocSelect{ flex:1 1 auto; height:44px; border:1px solid #c7d5e6; border-radius:10px; padding:0 10px; font-weight:800; color:#00519c; background:#eff5ff; font-size:16px; }
    #supportMobile{ flex:0 0 auto; display:inline-flex; align-items:center; justify-content:center; height:44px; padding:0 14px; background:#00a758; color:#fff; border-radius:10px; text-decoration:none; font-weight:900; white-space:nowrap; }

    /* ===== CONTENT ===== */
    body{ padding-top: calc(var(--header-h) + var(--toc-h) + 8px); }
    body{ padding-bottom: calc(2.25 * var(--footer-h) + env(safe-area-inset-bottom,0px)); }

    #contentWrap{ margin-left:0; }
    body.sidebar-open #contentWrap{ margin-left:var(--sidebar-width); }
    main{ max-width:1200px; margin:0 auto; padding:14px; }

    /* Ẩn toàn bộ phần ngoài header khi chưa login */
    body.logged-out #sidebar,
    body.logged-out #tocMobile,
    body.logged-out #contentWrap,
    body.logged-out #supportDesk { display:none !important; }

    .section-title{ background:#fff; padding:12px 16px; border-left:6px solid #0ea35b; border-radius:8px; font-weight:900; color:#0b3d2c; margin:6px 0 14px; }

    /* ===== INFO GRID ===== */
    .info-grid{ display:grid; grid-template-columns: repeat(auto-fit, minmax(240px,1fr)); gap:.85rem; }
    .info-item{ display:flex; flex-direction:column; gap:.3rem; background:#fff; border:1px solid #e5e7eb; border-left:4px solid #0ea35b; border-radius:.6rem; padding:.7rem .85rem; }
    .info-item .val{ font-size:1.05rem; line-height:1.3; word-break:break-word; }
    .pro-alert{ margin-top:.4rem; padding:.7rem .9rem; border:2px solid #dc2626; border-left-width:6px; border-radius:.6rem; background:#fff; color:#b91c1c; font-weight:900; font-size:1.05rem; }

    .list-dot li, .bullet-strong li{ list-style:none; padding-left:0; display:grid; grid-template-columns:minmax(170px,max-content) 1fr; column-gap:1rem; align-items:start; margin:.3rem 0; }
    .bullet-strong li{ border-left:3px solid #0ea35b; padding-left:.75rem; }
    .hl{ grid-column:2; font-weight:900; font-size:1.02rem; line-height:1.3; color:#10b981; }
    .thin{ font-weight:700; color:#0b3d2c; }
    .subsec{ margin:12px 0 10px; font-weight:900; color:#0b3d2c; padding-left:.75rem; border-left:6px solid #0ea35b; font-size:1.05rem; }
    .sub-block{ margin-bottom:8px; }

    /* ===== MOBILE ===== */
    @media (max-width:1023px){
      .header-grid{ grid-template-columns:1fr; }
      .brand-row{ justify-content:flex-start; }
      .login-cluster{ width:100%; justify-self:stretch; grid-template-columns:1fr; }
      .logo-d{ height:44px; }
      body.sidebar-open #contentWrap{ margin-left:0 }
      body.logged-in #tocMobile{ display:block; }   /* dropdown chỉ hiện ở mobile khi đã login */
      .list-dot li, .bullet-strong li{
        grid-template-columns: minmax(0,1fr) auto;  /* nhãn co giãn, xuống dòng */
        align-items:flex-start;
      }
    }
    @media (min-width:1024px){
      body.logged-in #sidebar{ display:block; }
      body.logged-in.sidebar-open #supportDesk{ display:inline-flex; } /* nút hỗ trợ nổi chỉ desktop */
    }

    /* ===== FOOTER ===== */
    #pageFooter{ position:fixed; left:0; right:0; bottom:0; min-height:var(--footer-h); display:flex; flex-direction:column; align-items:center; justify-content:center; gap:6px; background:#f4f6f8; color:#0b3a2a; border-top:1px solid #e3e7eb; z-index:950; padding:8px 10px 10px; text-align:center; font-weight:800; }
    #pageFooter img{ height:22px; width:auto; display:block; }
    #contentWrap::after{ content:""; display:block; height: calc(0.75 * var(--footer-h) + 24px); }

    /* Hỗ trợ desktop */
    #supportDesk{ position:fixed; right:18px; bottom:calc(var(--footer-h) + 14px); background:#00a758;color:#fff;padding:12px 16px;border-radius:28px;font-weight:900;text-decoration:none;box-shadow:0 4px 12px rgba(0,0,0,.18); z-index:940; display:none; }

    /* Thông báo lỗi dưới header */
    #errorTop{ display:none; margin:0; border-top:1px solid #f5c2c7; background:#fff5f5; color:#b91c1c; font-weight:800; padding:8px 12px; }
    #errorTop.show{ display:block; }

    /* Nhãn (label) cho mục B để dễ xuống dòng ở mobile */
    .li-label{
      font-weight:700; color:#0b3d2c;
      white-space:normal; overflow-wrap:anywhere; line-height:1.3;
    }
    #sectionInfo .info-item .val { font-weight: 900; color: #10b981; }

  </style>
</head>
<body class="logged-out">
  <!-- ===== HEADER ===== -->
  <header id="pageHeader" class="app-header">
    <div class="header-grid">
      <div class="brand-row">
         &#160;&#160;<img src="/logo.webp" alt="logo" class="logo-d" />
        <div class="title-wrap">
          <div class="title-top">CỔNG THÔNG TIN VÙNG HẰNG LÂM</div>
          <div class="title-main">BÁO CÁO CÁ NHÂN</div>
        </div>
      </div>

      <!-- Cụm đăng nhập / đăng xuất -->
      <form id="loginForm" class="login-cluster">
        <input class="login-only" type="text" id="msdlInput" placeholder="Nhập MSĐL" required />
        <input class="login-only" type="text" id="dateInput" placeholder="Ngày gia nhập (dd/mm/yyyy hoặc ddmmyyyy)" required />
        <button id="loginBtn" class="login-btn login-only" type="submit"><b>Đăng nhập</b></button>
        <button id="logoutBtn" class="login-btn logout-only" type="button">Đăng xuất</button>
      </form>
    </div>
    <div id="errorTop"></div>
  </header>

  <!-- ===== TOC chỉ dành cho mobile ===== -->
  <div id="tocMobile">
    <div class="row">
      <select id="tocSelect" aria-label="Chọn mục"></select>
      <a id="supportMobile" href="http://zalo.me/0376763390" target="_blank" rel="noopener">Hỗ trợ</a>
    </div>
  </div>

  <!-- ===== SIDEBAR (desktop) ===== -->
  <aside id="sidebar">
    <div class="sidebar-inner">
      <div class="menu-title">Danh mục</div>

      <a href="#" class="menu-item active" data-target="sectionInfo">THÔNG TIN ĐẠI LÝ</a>
      <a href="#" class="menu-item" data-target="sectionA">A. TỔNG QUAN (MTD)</a>

      <div class="menu-group">B. HOẠT ĐỘNG CÁ NHÂN</div>
      <div class="submenu">
        <a href="#" class="menu-item" data-target="sectionB" data-anchor="#b1">B.1 Bán hàng</a>
        <a href="#" class="menu-item" data-target="sectionB" data-anchor="#b2">B.2 Manulife Pro</a>
        <a href="#" class="menu-item" data-target="sectionB" data-anchor="#b3">B.3 MDRT+</a>
        <a href="#" class="menu-item" data-target="sectionB" data-anchor="#b4">B.4 M-Star / Japan</a>
        <a href="#" class="menu-item" data-target="sectionB" data-anchor="#b5">B.5 Thưởng năm</a>
      </div>

      <div class="menu-group">C. TUYỂN DỤNG & HỆ THỐNG</div>
      <div class="submenu">
        <a href="#" class="menu-item" data-target="sectionC" data-anchor="#c1">C.1 Tuyển dụng</a>
        <a href="#" class="menu-item" data-target="sectionC" data-anchor="#c2">C.2 Thăng cấp</a>
        <a href="#" class="menu-item" data-target="sectionC" data-anchor="#c3">C.3 Duy trì chức danh</a>
        <a href="#" class="menu-item" data-target="sectionC" data-anchor="#c4">C.4 MBA Pro</a>
        <a href="#" class="menu-item" data-target="sectionC" data-anchor="#c5">C.5 Thưởng nhóm ưu tú</a>
      </div>

      <!-- Mở tab mới -->
      <a href="https://tracuubaocao.vunghanglam.com/income/" target="_blank" rel="noopener" class="menu-item">TÍNH THU NHẬP</a>
    </div>
  </aside>

  <!-- ===== CONTENT ===== -->
  <a id="supportDesk" href="http://zalo.me/0376763390" target="_blank" rel="noopener">Hỗ trợ</a>

  <div id="contentWrap">
    <main>
      <section id="report"></section>
    </main>
  </div>

  <!-- ===== FOOTER ===== -->
  <footer id="pageFooter">
    <div>Bản quyền trang web thuộc về</div>
    <img src="/logo_textr.webp" alt="Logo" />
  </footer>

  <!-- ===== LOGIC ===== -->
  <script>
    /* ===== STATE ===== */
    let dataRows = [];
    let mapping = [];
    let dataReady;
    let loggedIn = false;

    /* ===== CONST ===== */
    const INCOME_URL  = 'https://tracuubaocao.vunghanglam.com/income/';

    /* ===== LOAD DATA ===== */
    async function loadData(){
      const mapUrl = encodeURI('tham chieu.json');
      const dataUrl = 'data.json';
      const [mapS, dataS] = await Promise.allSettled([
        fetch(mapUrl).then(r => r.ok ? r.json() : []),
        fetch(dataUrl).then(r => r.ok ? r.json() : [])
      ]);
      mapping = (mapS.status === 'fulfilled' && Array.isArray(mapS.value)) ? mapS.value : [];
      dataRows = (dataS.status === 'fulfilled' && Array.isArray(dataS.value)) ? dataS.value : [];
    }
    dataReady = loadData();

    /* ===== DOM ===== */
    const reportEl  = document.getElementById('report');
    const errorTop  = document.getElementById('errorTop');
    const loginForm = document.getElementById('loginForm');
    const msdlInput = document.getElementById('msdlInput');
    const dateInput = document.getElementById('dateInput');
    const loginBtn  = document.getElementById('loginBtn');
    const logoutBtn = document.getElementById('logoutBtn');

    function isMobile(){ return window.matchMedia('(max-width: 1023px)').matches; }

    /* ===== UTIL ===== */
    function showErrorTop(msg){ if(!msg){errorTop.classList.remove('show'); errorTop.textContent=''; return;} errorTop.textContent=msg; errorTop.classList.add('show'); }

    function normalizeDate(s){
      if(!s) return '';
      s = String(s).trim();
      if (/^\d{8}$/.test(s)) { const d=s.slice(0,2), m=s.slice(2,4), y=s.slice(4,8); return `${d}/${m}/${y}`; }
      if (/^\d{1,2}\/\d{1,2}\/\d{4}$/.test(s)) { const [d,m,y]=s.split('/').map(x=>parseInt(x,10)); return `${String(d).padStart(2,'0')}/${String(m).padStart(2,'0')}/${y}`; }
      if (/^\d{4}-\d{1,2}-\d{1,2}$/.test(s)) { const [y,m,d]=s.split('-').map(x=>parseInt(x,10)); return `${String(d).padStart(2,'0')}/${String(m).padStart(2,'0')}/${y}`; }
      return s;
    }
    function normalizeMSDL(s){ return String(s||'').trim().replace(/\s+/g,'').toLowerCase(); }

    function parseLocaleNumber(v){
      if (v===null||v===undefined||v==='') return NaN;
      if (typeof v==='number') return v;
      let s = String(v).trim().replace(/[^0-9,.\-]/g,'');
      if (s===''||s==='-'||s==='.'||s===',') return NaN;
      const hasDot=s.includes('.'), hasComma=s.includes(',');
      if (hasDot&&hasComma){
        if (s.lastIndexOf(',')>s.lastIndexOf('.')){ s=s.replace(/\./g,'').replace(',', '.'); }
        else { s=s.replace(/,/g,''); }
      } else if (hasComma&&!hasDot){ s=s.replace(',', '.'); }
      const n=parseFloat(s); return isNaN(n)?NaN:n;
    }
    function formatThousand(n,dec){ if (n===null||n===undefined||isNaN(n)) return ""; const fixed = Number(n).toFixed(dec); let [intPart, frac=""] = fixed.split('.'); const sign = intPart.startsWith('-')?'-':''; intPart = intPart.replace('-','').replace(/\B(?=(\d{3})+(?!\d))/g,'.'); return sign + intPart + (dec>0?','+frac:""); }
    function formatF3(val){ const n=parseLocaleNumber(val); if(isNaN(n)) return val??""; return formatThousand(n,3); }
    function formatNumber(val){ return (val ?? ""); }

    function normalizeLabel(label=""){ return String(label||"").toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/\s+/g,' ').trim(); }
    const FORCE_F3_LABELS = new Set([
      'Doanh thu FYP thực cấp','Tổng doanh thu FYP','FYP phát sinh tính thưởng','Mức thưởng tạm đạt','Cần thêm để đạt mức thưởng tiếp theo','Mức thưởng tiếp theo','FYP cần thêm để thăng hạng','FYP thực đạt (YTD)','FYP cần thêm để đạt tiến độ quý hiện tại','FYP cần thêm để đạt danh hiệu MDRT+','FYP phát sinh trong thời gian thi đua','Tổng FYP cần thêm để đạt thi đua','Tổng FYP phát sinh (YTD)','FYC Whole team L6M sau luật 50% cần thêm','fYP Whole team L6M sau luật 50% cần thêm','FYC cá nhân UM+ và ĐL trực tiếp L12M sau luật 50%','FYC cá nhân UM+ và ĐL trực tiếp L12M sau luật 50%','Tổng FYP phát sinh trong tháng của bản thân UM+ (A)','FYP của bản thân UM+ (A) và nhóm trực tiếp sau luật 50%','FYP của bản thân UM+ (B) báo cáo trực tiếp cho UM+ (A)','Tổng FYP sau luật 50% dùng để tính thưởng (cấp UM)','Tổng FYP WT trước luật 50% (cấp SUM+)','Tổng FYP WT sau luật 50% để tính thưởng (cấp SUM+)','Thưởng dự tính sau khi đã nhân hệ số TLDTHD'
    ].map(normalizeLabel));
    function shouldF3Label(label=""){ const norm = normalizeLabel(label); if (FORCE_F3_LABELS.has(norm)) return true; return (norm.includes('fyp') || norm.includes('fyc')); }
    function fmt(val,key="",label=""){ return shouldF3Label(label)?formatF3(val):(val??""); }
    function addPercent(val){ return (val ?? ""); }
    function exists(v){ return !(v===null||v===undefined||(typeof v==='string'&&v.trim()==='')); }
    function pick(row,keys){ for (const k of keys) if (exists(row[k])) return row[k]; return ''; }

    /* ===== BỔ SUNG: format số nguyên cho NRA & bọc nhãn mục B ===== */
    function formatInt(val){
      const n = parseLocaleNumber(val);
      if (isNaN(n)) return (val ?? "");
      return String(Math.round(n));
    }
    function enhanceListLabels(){
      const sectionB = document.getElementById('sectionB');
      if(!sectionB) return;
      sectionB.querySelectorAll('.list-dot li, .bullet-strong li').forEach(li=>{
        if(li.querySelector('.li-label')) return;
        const valEl = li.querySelector('.hl'); 
        if(!valEl) return;
        const before = [];
        for (const node of Array.from(li.childNodes)){
          if(node === valEl) break;
          before.push(node);
        }
        const labelText = before.map(n=>n.textContent||'').join('').replace(/\s*:\s*$/,'');
        const span = document.createElement('span');
        span.className = 'li-label';
        span.textContent = labelText + ': ';
        before.forEach(n=>li.removeChild(n));
        li.insertBefore(span, valEl);
      });
    }
    function coerceNRAIntegers(){
      const sectionB = document.getElementById('sectionB');
      if(!sectionB) return;
      sectionB.querySelectorAll('.list-dot li, .bullet-strong li').forEach(li=>{
        const labelEl = li.querySelector('.li-label'); 
        const valEl = li.querySelector('.hl');
        if(!labelEl || !valEl) return;
        if(/nra/i.test(labelEl.textContent)){
          const n = parseLocaleNumber(valEl.textContent);
          if(!isNaN(n)){ valEl.textContent = String(Math.round(n)); }
        }
      });
    }

    /* ===== LAYOUT HELPERS ===== */
    function setLayoutVars(){
      const head=document.getElementById('pageHeader');
      const footer=document.getElementById('pageFooter');
      const toc=document.getElementById('tocMobile');
      const h = head ? Math.ceil(head.getBoundingClientRect().height) : 64;
      const f = footer ? Math.ceil(footer.getBoundingClientRect().height) : 66;
      let t = 0;
      if(toc && getComputedStyle(toc).display!=='none') t = Math.ceil(toc.getBoundingClientRect().height);
      document.documentElement.style.setProperty('--header-h', h+'px');
      document.documentElement.style.setProperty('--footer-h', f+'px');
      document.documentElement.style.setProperty('--toc-h', t+'px');
    }
    function applySidebarMode(){ if(!document.body.classList.contains('logged-in')) return; if(window.matchMedia('(min-width:1024px)').matches){ document.body.classList.add('sidebar-open'); } else { document.body.classList.remove('sidebar-open'); } }

    /* ===== SECTION RENDER ===== */
    function infoItem(label, value){ if(!exists(value)) return ''; return `<div class="info-item"><div class="label">${label}:</div><div class="val">${value}</div></div>`; }
    function renderInfoSection(row){
      const p13cn = addPercent(row["TLDTHD cá nhân"]);
      const p13nh = addPercent(row["TLDTHD toàn nhánh"]);
      const p13c1 = addPercent(row["TLDTHD cấp 1"]);
      const proMoc3 = row["PRO.MOC 3 THANG"];
      const hasAlert = exists(proMoc3) && String(proMoc3).trim() !== "-";
      const alertHtml = hasAlert ? `<div class="pro-alert ${isMobile() ? 'info-alert' : ''}">Cảnh báo: <span class="pro-name" style="font-weight:900;">Danh hiệu Manulife Pro</span> – ${proMoc3}</div>` : "";
      const firstBlock = infoItem("Báo cáo dành cho", (row["TEN DAI LY"] || row["AGEN NAME"]));
      const restBlocks = `
        ${infoItem("KV | MS", row["KV|MS"])}
        ${infoItem("Ngày gia nhập", row["JOIN DATE"])}
        ${infoItem("Tháng làm việc", row["WORK MNTHS"])}
        ${infoItem("Chức danh", row["Chức danh"])}
        ${infoItem("Ngày hiệu lực Chức danh", row["Ngày hiệu lực Chức danh"])}
        ${infoItem("Nhóm đại lý", row["Nhóm Đại lý"])}
        ${infoItem("Manulife Pro (chính thức)", row["PRO.DH CHINH THUC"])}
        ${infoItem("Chính thức từ", row["PRO.BAT DAU"])}
        ${infoItem("P13 Cá nhân", p13cn)}
        ${infoItem("P13 Toàn nhánh", p13nh)}
        ${infoItem("P13 cấp 1", p13c1)}
        ${infoItem("Số liệu cập nhật đến ngày", row["NGAY CHOT DATA"])}
        ${infoItem("ĐVT", "Nghìn VND")}
      `;
      const gridInner = isMobile() ? `${alertHtml}${firstBlock}${restBlocks}` : `${firstBlock}${restBlocks}`;
      const alertAfter = (!isMobile() && hasAlert) ? alertHtml : "";
      return `
        <div id="sectionInfo" class="section">
          <div class="section-title">Thông tin đại lý</div>
          <div class="info-grid">${gridInner}</div>
          ${alertAfter}
        </div>
      `;
    }

    function renderReport(row){
      const Info = renderInfoSection(row);
      const A = `
        <div id="sectionA" class="section hide">
          <div class="section-title">A. BÁO CÁO TỔNG QUAN – (Month to date)</div>
          <ul class="mb-4 list-dot bullet-strong lvl-2">
            <li>Số hợp đồng thực cấp: <span class="hl">${formatNumber(row["MTD.CC CAP"])}</span></li>
            <li>Doanh thu FYP thực cấp: <span class="hl">${fmt(row["MTD.FYP CAP"], "MTD.FYP CAP", "Doanh thu FYP thực cấp")}</span></li>
            <li>Số lượng Đại lý mới tuyển dụng: <span class="hl">${formatNumber(row["RECRUIT T"])}</span></li>
          </ul>
        </div>`;

      const B = `
        <div id="sectionB" class="section hide">
          <div class="section-title">B. BÁO CÁO CHI TIẾT HOẠT ĐỘNG CÁ NHÂN</div>

          <div id="b1" class="sub-block">
            <div class="subsec lvl-1">1. Hoạt động bán hàng</div>
            <div class="thin lvl-2">Nộp mới trong tháng</div>
            <ul class="mb-2 list-dot bullet-strong lvl-3">
              <li>Tổng số hợp đồng: <span class="hl">${formatNumber(row["MTD.CC NOP"])}</span></li>
              <li>Tổng doanh thu FYP: <span class="hl">${fmt(row["MTD.FYP NOP"], "MTD.FYP NOP", "Tổng doanh thu FYP")}</span></li>
            </ul>
            <div class="thin lvl-2">Thực cấp trong tháng</div>
            <ul class="mb-2 list-dot bullet-strong lvl-3">
              <li>Tổng số hợp đồng: <span class="hl">${formatNumber(row["MTD.CC CAP"])}</span></li>
              <li>Tổng doanh thu FYP: <span class="hl">${fmt(row["MTD.FYP CAP"], "MTD.FYP CAP", "Tổng doanh thu FYP")}</span></li>
            </ul>
          </div>

          <div id="b2" class="sub-block hide">
            <div class="subsec lvl-1">2. Danh hiệu Manulife Pro</div>
            <div class="lvl-2">Danh hiệu chính thức hiện tại: <span class="hl">${formatNumber(row["PRO.DH CHINH THUC"])}</span></div>
            <ul class="mb-2 list-dot bullet-strong lvl-3">
              <li>Tháng bắt đầu: <span class="hl">${formatNumber(row["PRO.BAT DAU"])}</span></li>
              <li>Tháng kết thúc: <span class="hl">${formatNumber(row["PRO.KET THUC"])}</span></li>
            </ul>
            <div class="thin mb-1 lvl-2">Thưởng năng suất xuất sắc tháng hiện tại:</div>
            <ul class="mb-2 list-dot lvl-3">
              <li>Danh hiệu dùng để xét thưởng: <span class="hl">${formatNumber(row["PRO.DH XET THUONG"])}</span></li>
              <li>FYP phát sinh tính thưởng: <span class="hl">${fmt(row["PRO.FYP HIEN TAI"], "PRO.FYP HIEN TAI", "FYP phát sinh tính thưởng")}</span></li>
              <li>Mức thưởng tạm đạt: <span class="hl">${fmt(row["PRO.THUONG TAM DAT"], "PRO.THUONG TAM DAT", "Mức thưởng tạm đạt")}</span></li>
              <li>Cần thêm để đạt mức thưởng tiếp theo: <span class="hl">${fmt(row["PRO.FYP CAN TANG THUONG"], "PRO.FYP CAN TANG THUONG", "Cần thêm để đạt mức thưởng tiếp theo")}</span></li>
              <li>Mức thưởng tiếp theo: <span class="hl">${fmt(row["PRO.THUONG TIEP THEO"], "PRO.THUONG TIEP THEO", "Mức thưởng tiếp theo")}</span></li>
            </ul>
            <div class="thin mb-1 lvl-2">Theo dõi thăng hạng danh hiệu</div>
            <ul class="mb-2 list-dot lvl-3">
              <li>Tiến độ thăng hạng danh hiệu: <span class="hl">${addPercent(row["PRO % THANG HANG"])}</span></li>
              <li>Kết quả tại tháng T-2: <span class="hl">${formatNumber(row["PRO.DH TAM TINH T-2"])}</span></li>
              <li>Kết quả tại tháng T-1: <span class="hl">${formatNumber(row["PRO.DH TAM TINH T-1"])}</span></li>
              <li>FYP cần thêm để thăng hạng: <span class="hl">${fmt(row["PRO.UP FYP CAN THEM"], "PRO.UP FYP CAN THEM", "FYP cần thêm để thăng hạng")}</span></li>
              <li>CC cần thêm để để thăng hạng: <span class="hl">${formatNumber(row["PRO.UP CC CAN THEM"])}</span></li>
              <li>Số tháng có hoạt động cần thêm: <span class="hl">${formatNumber(row["PRO.UP THANG CAN THEM"])}</span></li>
              <li>Tỷ lệ P13 cần thêm để đạt danh hiệu: <span class="hl">${addPercent(row["PRO.UP P13 CAN THEM"])}</span></li>
            </ul>
            <div class="thin mb-1 lvl-2">Theo dõi duy trì danh hiệu</div>
            <ul class="mb-2 list-dot lvl-3">
              <li>Kết quả xét duy trì danh hiệu: <span class="hl">${formatNumber(row["PRO.KQ DUY TRI"])}</span></li>
              <li>Tạm tính theo kết quả tại tháng T-2: <span class="hl">${formatNumber(row["PRO.DH TAM TINH T-2"])}</span></li>
              <li>Tạm tính theo kết quả tại tháng T-1: <span class="hl">${formatNumber(row["PRO.DH TAM TINH T-1"])}</span></li>
              <li>Danh hiệu tạm tính cao nhất: <span class="hl">${formatNumber(row["PRO.DH TAM TINH CAO NHAT"])}</span></li>
              <li>Tiến độ duy trì danh hiệu: <span class="hl">${addPercent(row["PRO % MOC"])}</span></li>
              <li>Giai đoạn đánh giá: <span class="hl">${formatNumber(row["PRO.GD MOC"])}</span></li>
              <li>FYP đã đạt so với yêu cầu: <span class="hl">${row["PRO.MOC FYP"]}</span></li>
              <li>Số tháng có hoạt động so với yêu cầu: <span class="hl">${formatNumber(row["PRO.MOC THANG HĐ"])}</span></li>
              <li>Cảnh báo 3 tháng cuối kỳ xét: <span class="hl">${formatNumber(row["PRO.MOC 3 THANG"])}</span></li>
            </ul>
          </div>

          <div id="b3" class="sub-block hide">
            <div class="subsec lvl-1">3. Danh hiệu MDRT+</div>
            <div class="lvl-2">Yêu cầu FYP tiến độ quý hiện tại: <span class="hl">${fmt(row["MDRT.FYP Y/C QUY HT"], "MDRT.FYP Y/C QUY HT", "FYP tiến độ quý hiện tại")}</span></div>
            <div class="lvl-2">Tiến độ quý hiện tại đã đạt: <span class="hl">${addPercent(row["MDRT.TIEN DO QUY"])}</span></div>
            <ul class="mb-2 list-dot lvl-3">
              <li>FYP thực đạt (YTD): <span class="hl">${fmt(row["MDRT.FYP CAP"], "MDRT.FYP CAP", "FYP thực đạt (YTD)")}</span></li>
              <li>FYP cần thêm để đạt tiến độ quý hiện tại: <span class="hl">${fmt(row["MDRT.FYP CAN DAT TD QUY"], "MDRT.FYP CAN DAT TD QUY", "FYP cần thêm để đạt tiến độ quý hiện tại")}</span></li>
              <li>FYP cần thêm để đạt danh hiệu MDRT+: <span class="hl">${fmt(row["MDRT.FYP CAN DAT DH"], "MDRT.FYP CAN DAT DH", "FYP cần thêm để đạt danh hiệu MDRT+")}</span></li>
              <li>Danh hiệu đang trong tiến độ: <span class="hl">${formatNumber(row["MDRT.DH TIEP THEO"])}</span></li>
            </ul>
          </div>

          <div id="b4" class="sub-block hide">
            <div class="subsec lvl-1">4. Hành trình M-Star, Xứ sở hoa anh đào</div>
            <ul class="mb-2 list-dot lvl-2">
              <li>FYP phát sinh trong thời gian thi đua: <span class="hl">${fmt(row["JPAN.FYP THI DUA"], "JPAN.FYP THI DUA", "FYP phát sinh trong thời gian thi đua")}</span></li>
              <li>Tổng FYP cần thêm để đạt thi đua: <span class="hl">${fmt(row["JPAN.FYP CAN DAT"], "JPAN.FYP CAN DAT", "Tổng FYP cần thêm để đạt thi đua")}</span></li>
              <li>Tỷ lệ P13 hiện tại: <span class="hl">${addPercent(row["JPAN.P13"])}</span></li>
              <li>Số lượng vé đạt tạm tính: <span class="hl">${formatNumber(row["JPAN.Đạt vé (tạm tính)"])}</span></li>
            </ul>
          </div>

          <div id="b5" class="sub-block hide">
            <div class="subsec lvl-1">5. Khoản thưởng kinh doanh xuất sắc hàng năm</div>
            <ul class="mb-4 list-dot lvl-2">
              <li>Tổng số CC thực cấp (YTD): <span class="hl">${formatNumber(row["FC.FC CC YTD"])}</span></li>
              <li>Tổng FYP phát sinh (YTD): <span class="hl">${fmt(row["FC.FC FYP YTD"], "FC.FC FYP YTD", "Tổng FYP phát sinh (YTD)")}</span></li>
            </ul>
          </div>
        </div>`;

      const C = `
        <div id="sectionC" class="section hide">
          <div class="section-title">C. BÁO CÁO CHI TIẾT HOẠT ĐỘNG TUYỂN DỤNG VÀ HỆ THỐNG</div>

          <div id="c1" class="sub-block">
            <div class="subsec lvl-1">1. Hoạt động tuyển dụng</div>
            <ul class="mb-2 list-dot lvl-2">
              <li>Số lượng tuyển dụng trực tiếp tháng hiện tại: <span class="hl">${formatNumber(row["RECRUIT T"])}</span></li>
              <li>Số lượng tuyển dụng trực tiếp active M0: <span class="hl">${formatNumber(row["RECRUIT ACT T"])}</span></li>
            </ul>
          </div>

          <div id="c2" class="sub-block hide">
            <div class="subsec lvl-1">2. Theo dõi thăng cấp</div>
            <ul class="mb-2 list-dot lvl-2">
              <li>Tiến độ thăng lên UM (đối với FA): <span class="hl">${addPercent(row["UP % FA TO UM"])}</span></li>
              <li>Vị trí thăng cấp: <span class="hl">${formatNumber(row["UP.TC LEN"])}</span></li>
              <li>Kết quả đánh giá: <span class="hl">${formatNumber(row["UP.KQ DG"])}</span></li>
              <li>Tiềm năng thăng cấp: <span class="hl">${formatNumber(row["UP.TIEM NANG TC UM"])}</span></li>
              <li>Theo dõi các khóa đào tạo bắt buộc (Y/N):<br>
                SBW: <span class="hl">${formatNumber(row["UP.SBW"])}</span> &nbsp; 
                MS: <span class="hl">${formatNumber(row["UP.MS"])}</span> &nbsp;
                LS: <span class="hl">${formatNumber(row["UP.LS"])}</span> &nbsp;
                COACHING: <span class="hl">${formatNumber(row["UP.COACHING"])}</span>
              </li>
              <li>Số lượng NRA với 1CC & 4tr FYC cần thêm: <span class="hl">${formatInt(row["UP.CAN TD ACT 4TR FYC L3M"])}</span></li>
              <li>2A Số lượng đại lý còn làm việc Whole team cần thêm: <span class="hl">${formatNumber(row["UP.CAN CA WT"])}</span></li>
              <li>2B Số lượng đại lý còn làm việc và có ≥ 15tr FYC L3M cần thêm: <span class="hl">${formatNumber(row["UP.CAN CA 15TR L3M"])}</span></li>
              <li>Số lượng UM+ báo cáo trực tiếp cần thêm: <span class="hl">${formatNumber(row["UP.CAN UM+TT"])}</span></li>
              <li>Nguồn sản xuất cần thêm: <span class="hl">${formatNumber(row["UP.CAN NGUON SX"])}</span></li>
              <li>FYC Whole team L6M sau luật 50% cần thêm: <span class="hl">${fmt(row["UP.CAN FYC WT L6M"], "UP.CAN FYC WT L6M", "FYC Whole team L6M sau luật 50% cần thêm")}</span></li>
            </ul>
          </div>

          <div id="c3" class="sub-block hide">
            <div class="subsec lvl-1">3. Theo dõi duy trì chức danh</div>
            <div class="thin lvl-2">Đánh giá từ <span class="hl">${formatNumber(row["MOC.FROM"])}</span> đến <span class="hl">${formatNumber(row["MOC.TO"])}</span> của kỳ đánh giá ngày <span class="hl">${formatNumber(row["MOC.IN"])}</span></div>
            <ul class="mb-2 list-dot lvl-3">
              <li>Chức danh hiện tại: <span class="hl">${formatNumber(row["MOC.RANK"])}</span></li>
              <li>Tháng tại chức: <span class="hl">${formatNumber(row["MOC.TAI VI"])}</span></li>
              <li>Kết quả đánh giá tạm tính (Y/N): <span class="hl">${formatNumber(row["MOC.KQ TAM TINH"])}</span></li>
              <li>Theo dõi các khóa đào tạo bắt buộc (Y/N):<br>
                MS: <span class="hl">${formatNumber(row["UP.MS"])}</span> &nbsp;
                LS: <span class="hl">${formatNumber(row["UP.LS"])}</span> &nbsp;
                COACHING: <span class="hl">${formatNumber(row["UP.COACHING"])}</span>
              </li>
              <li>Số lượng NRA với 1CC & 4tr FYC cần thêm: <span class="hl">${formatInt(row["MOC.CAN TD ACT 4TR L6M"])}</span></li>
              <li>Số lượng UM+ báo cáo trực tiếp cần thêm: <span class="hl">${formatNumber(row["MOC.CAN UM+ TT"])}</span></li>
              <li>FYP Whole team L6M sau luật 50% cần thêm: <span class="hl">${fmt(row["MOC.CAN FYC WT L6M"], "MOC.CAN FYC WT L6M", "FYP Whole team L6M sau luật 50% cần thêm")}</span></li>
              <li>Tỷ lệ duy trì P13 cần thêm: <span class="hl">${addPercent(row["MOC.CAN P13 WT"])}</span></li>
            </ul>
          </div>

          <div id="c4" class="sub-block hide">
            <div class="subsec lvl-1">4. Danh hiệu MBA Pro</div>
            <ul class="mb-2 list-dot lvl-2">
              <li>Danh hiệu chính thức hiện tại: <span class="hl">${formatNumber(row["MBA.DH CT HIEN TAI"])}</span></li>
              <li><span class="thin">Theo dõi thăng hạng:</span></li>
            </ul>
            <ul class="mb-2 list-dot lvl-3">
              <li>Tiềm năng thăng hạng (FYC ≥ 80% yêu cầu hạn tiếp theo): <span class="hl">${fmt(row["MBA.TIEM NANG 80%FYC"], "MBA.TIEM NANG 80%FYC", "FYC cá nhân UM+ và ĐL trực tiếp L12M sau luật 50%")}</span></li>
              <li>Số lượng đại lý đạt chuẩn trong quý: <span class="hl">${formatNumber(row["MBA.TH DL DAT CHUAN TRONG QUY"])}</span></li>
              <li>Số lượng đại lý đạt chuẩn trong 2 quý: <span class="hl">${formatNumber(row["MBA.TH DL DAT CHUAN 2 QUY"])}</span></li>
              <li>FYC cá nhân UM+ và ĐL trực tiếp L12M sau luật 50%: <span class="hl">${fmt(row["MBA.TH FYC TO TT SAU 50"], "MBA.TH FYC TO TT SAU 50", "FYC cá nhân UM+ và ĐL trực tiếp L12M sau luật 50%")}</span></li>
              <li>Số UM+ mới thăng cấp L12M: <span class="hl">${formatNumber(row["MBA.TH UM+ MOI L12M"])}</span></li>
              <li>P13 cấp báo cáo trực tiếp: <span class="hl">${addPercent(row["MBA.TH P13 BCTT"])}</span></li>
              <li>Danh hiệu MBA Pro tạm tính theo kết quả xét thăng hạng: <span class="hl">${formatNumber(row["MBA.TH DH TAM TINH QUY SAU"])}</span></li>
            </ul>
            <ul class="mb-2 list-dot lvl-2"><li><span class="thin">Theo dõi duy trì hạng:</span></li></ul>
            <ul class="mb-2 list-dot lvl-3">
              <li>Kết quả xét duy trì tạm tính: <span class="hl">${formatNumber(row["MBA.KQ DT DH HTAI"])}</span></li>
              <li>Số quý liên tục giữ danh hiệu MBA Pro hiện tại: <span class="hl">${formatNumber(row["MBA.DT SO QUY LIEN TUC"])}</span></li>
              <li>Số lượng Manulife Pro có sản xuất trong quý: <span class="hl">${formatNumber(row["MBA.SO MANPRO ACT TRONG QUY"])}</span></li>
              <li>FYC cá nhân UM+ và ĐL trực tiếp L12M sau luật 50%: <span class="hl">${fmt(row["MBA.TH FYC TO TT SAU 50"], "MBA.TH FYC TO TT SAU 50", "FYC cá nhân UM+ và ĐL trực tiếp L12M sau luật 50%")}</span></li>
              <li>Số UM+ mới thăng cấp L12M: <span class="hl">${formatNumber(row["MBA.TH UM+ MOI L12M"])}</span></li>
            </ul>
            <ul class="mb-2 list-dot lvl-2"><li>Danh hiệu tạm tính quý sau (sau thăng hạng & duy trì): <span class="hl">${formatNumber(row["MBA.DH TAM TINH QUY SAU"])}</span></li></ul>
          </div>

          <div id="c5" class="sub-block hide">
            <div class="subsec lvl-1">5. Thưởng năng suất nhóm ưu tú hàng tháng</div>
            <ul class="mb-2 list-dot lvl-2">
              <li>Tổng CC phát sinh trong tháng của bản thân UM+ (A): <span class="hl">${formatNumber(row["OTEAM.CC UM+"])}</span></li>
              <li>Tổng FYP phát sinh trong tháng của bản thân UM+ (A): <span class="hl">${fmt(row["OTEAM.FYP UM+"], "OTEAM.FYP UM+", "Tổng FYP phát sinh trong tháng của bản thân UM+ (A)")}</span></li>
              <li>Số NRA có ≥1CC và 15tr FYP L3M của bản thân UM+(A): <span class="hl">${formatInt(row["OTEAM.TDTT ACT"])}</span></li>
              <li>FYP của bản thân UM+ (A) và nhóm trực tiếp sau luật 50%: <span class="hl">${fmt(row["OTEAM.TONG FYP TT"], "OTEAM.TONG FYP TT", "FYP của bản thân UM+ (A) và nhóm trực tiếp sau luật 50%")}</span></li>
              <li>FYP của bản thân UM+ (B) báo cáo trực tiếp cho UM+ (A): <span class="hl">${fmt(row["OTEAM.FYP UM+ MOI"], "OTEAM.FYP UM+ MOI", "FYP của bản thân UM+ (B) báo cáo trực tiếp cho UM+ (A)")}</span></li>
              <li>Tổng FYP sau luật 50% dùng để tính thưởng (cấp UM): <span class="hl">${fmt(row["OTEAM.TONG FYP SAU LUAT XET THUONG"], "OTEAM.TONG FYP SAU LUAT XET THUONG", "Tổng FYP sau luật 50% dùng để tính thưởng (cấp UM)")}</span></li>
              <li>Tổng FYP WT trước luật 50% (cấp SUM+): <span class="hl">${fmt(row["OTEAM.FYP WT TRUOC LUAT"], "OTEAM.FYP WT TRUOC LUAT", "Tổng FYP WT trước luật 50% (cấp SUM+)")}</span></li>
              <li>Tổng FYP WT sau luật 50% để tính thưởng (cấp SUM+):(2): <span class="hl">${fmt(row["OTEAM.FYP WT SAU LUAT"], "OTEAM.FYP WT SAU LUAT", "Tổng FYP WT sau luật 50% để tính thưởng (cấp SUM+)")}</span></li>
              <li>Y/c về tổng FYP: <span class="hl">${fmt(row["OTEAM.Y/C TONG FYP"], "OTEAM.Y/C TONG FYP", "Y/c về tổng FYP")}</span></li>
              <li>Y/c về bán cá nhân: <span class="hl">${formatNumber(row["OTEAM.Y/C SX CA NHAN"])}</span></li>
              <li>Y/c về tuyển có active: <span class="hl">${formatNumber(row["OTEAM.Y/C TDTT ACT"])}</span></li>
              <li>Kết quả đạt thưởng thi đua (Y/N): <span class="hl">${formatNumber(row["OTEAM.DAT THUONG"])}</span></li>
              <li>Tỷ lệ P13: <span class="hl">${addPercent(row["OTEAM.P13"])}</span></li>
              <li>Hệ số nhân TLDTHD: <span class="hl">${formatNumber(row["OTEAM.HE SO THUONG"])}</span></li>
              <li>Thưởng dự tính sau khi đã nhân hệ số TLDTHD: <span class="hl">${fmt(row["OTEAM.TIEN THUONG"], "OTEAM.TIEN THUONG", "Thưởng dự tính sau khi đã nhân hệ số TLDTHD")}</span></li>
            </ul>
          </div>
        </div>`;

      reportEl.innerHTML = Info + A + B + C;

      enhanceListLabels();
      coerceNRAIntegers();
    }

    /* ===== NAV / TOC ===== */
    function buildMobileTOC(){
      const sel=document.getElementById('tocSelect'); if(!sel) return; sel.innerHTML='';
      const addOpt=(val,text)=>{ const op=document.createElement('option'); op.value=val; op.textContent=text; sel.appendChild(op); };
      addOpt('sectionInfo','Thông tin đại lý');
      addOpt('sectionA','A. Tổng quan (MTD)');
      addOpt('sectionB#b1','B.1 Bán hàng');
      addOpt('sectionB#b2','B.2 Manulife Pro');
      addOpt('sectionB#b3','B.3 MDRT+');
      addOpt('sectionB#b4','B.4 M-Star / Japan');
      addOpt('sectionB#b5','B.5 Thưởng năm');
      addOpt('sectionC#c1','C.1 Tuyển dụng');
      addOpt('sectionC#c2','C.2 Thăng cấp');
      addOpt('sectionC#c3','C.3 Duy trì chức danh');
      addOpt('sectionC#c4','C.4 MBA Pro');
      addOpt('sectionC#c5','C.5 Thưởng nhóm ưu tú');
      addOpt('openIncome','Tính thu nhập (mở tab)');
      sel.addEventListener('change',()=>{ const v=sel.value; if(!v) return; if(v==='openIncome'){ window.open(INCOME_URL,'_blank'); sel.value=''; return; } showSection(v); });
    }

    function bindSidebar(){
      document.querySelectorAll('#sidebar .menu-item').forEach(a=>{
        a.addEventListener('click',e=>{
          const hasData=a.hasAttribute('data-target');
          if(hasData){
            e.preventDefault();
            const base=a.getAttribute('data-target')||'';
            const anchor=a.getAttribute('data-anchor')||'';
            const val=anchor?`${base}${anchor}`:base;
            showSection(val);
          }
          // link ngoài (TÍNH THU NHẬP) sẽ để nguyên target _blank
        });
      });
    }

    function showSection(value){
      // value dạng 'sectionB#b2' hoặc 'sectionA'
      const [sectionId, anchorRaw] = value.split('#');
      const anchor = anchorRaw ? `#${anchorRaw}`.replace('##','#') : '';

      // Ẩn tất cả section
      document.querySelectorAll('#report .section').forEach(sec=>sec.classList.add('hide'));
      const section = document.getElementById(sectionId); if(!section) return;
      section.classList.remove('hide');

      // Ẩn/hiện các sub-block theo anchor
      section.querySelectorAll('.sub-block').forEach(sb=>sb.classList.remove('hide'));
      if(anchor){
        section.querySelectorAll('.sub-block').forEach(sb=>sb.classList.add('hide'));
        const sub = section.querySelector(anchor);
        if(sub) sub.classList.remove('hide');
      }

      // Active menu bên trái
      document.querySelectorAll('#sidebar .menu-item').forEach(el=>el.classList.remove('active'));
      if(!anchor){
        const top=document.querySelector(`#sidebar .menu-item[data-target="${sectionId}"]`);
        if(top) top.classList.add('active');
      } else {
        const sublink=document.querySelector(`#sidebar .menu-item[data-target="${sectionId}"][data-anchor="${anchor}"]`);
        if(sublink) sublink.classList.add('active');
      }

      // Đồng bộ dropdown mobile (nếu đang hiện)
      const sel=document.getElementById('tocSelect'); 
      if(sel && getComputedStyle(document.getElementById('tocMobile')).display!=='none'){
        sel.value = anchor ? `${sectionId}${anchor}` : sectionId;
      }

      // Scroll tới đầu section (bên dưới header + TOC)
      setLayoutVars();
      const headH = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--header-h'))||64;
      const tocH  = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--toc-h'))||0;
      const offset = headH + tocH + 6;
      const y = section.getBoundingClientRect().top + window.scrollY - offset;
      window.scrollTo({ top: Math.max(0,y), behavior:'smooth' });
    }

    /* ===== LOGIN ===== */
    loginBtn.disabled = true; loginBtn.textContent = 'Đang tải dữ liệu...';
    dataReady.finally(()=>{ loginBtn.disabled=false; loginBtn.textContent='Đăng nhập'; });

    loginForm.addEventListener('submit', async (e)=>{
      e.preventDefault(); showErrorTop(''); await dataReady;
      if (!Array.isArray(dataRows) || dataRows.length===0){ showErrorTop('Không tải được dữ liệu. Hãy kiểm tra data.json.'); return; }

      const msdlNorm = normalizeMSDL(msdlInput.value);
      const dateNorm = normalizeDate(dateInput.value);
      const msdlCols = ["MSDL","AGEN CODE","AGENT CODE","Agent Code","Mã Số Đại Lý","MÃ SỐ ĐẠI LÝ"];
      const joinCols = ["JOIN DATE","Join Date","NGÀY GIA NHẬP","Ngày gia nhập"];

      const row = dataRows.find(r => normalizeMSDL(pick(r,msdlCols))===msdlNorm && normalizeDate(pick(r,joinCols))===dateNorm);
      if (!row){ showErrorTop('Không tìm thấy đại lý phù hợp với thông tin bạn nhập!'); return; }

      // Render & bật giao diện
      renderReport(row);
      document.body.classList.remove('logged-out');
      document.body.classList.add('logged-in');
      applySidebarMode();
      buildMobileTOC();
      showSection('sectionInfo');     // mặc định vào mục Thông tin đại lý
      setLayoutVars();

      // Reset input
      msdlInput.value=''; dateInput.value=''; msdlInput.blur(); dateInput.blur();
    });

    logoutBtn.addEventListener('click', ()=>{ location.reload(); });

    /* ===== INIT ===== */
    function init(){ setLayoutVars(); applySidebarMode(); bindSidebar(); window.addEventListener('resize', ()=>{ setLayoutVars(); applySidebarMode(); }); }
    window.addEventListener('load', init);
  </script>
</body>
</html>
