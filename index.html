<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>B√ÅO C√ÅO C√Å NH√ÇN ‚Äì V√πng H·∫±ng L√¢m</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />

  <!-- Font c·ªßa d·ª± √°n -->
  <link rel="stylesheet" href="fonts/fonts.css" />
  <!-- Tailwind (d√πng utility nh·ªè) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    :root{
      --sidebar-width: 360px;
      --header-h: 64px;
      --footer-h: 66px;
      --toc-h: 0px;          /* chi·ªÅu cao dropdown mobile (t·ª± t√≠nh b·∫±ng JS) */
      --brand:#059669; 
      --accent:#00a758;
    }
    /* ƒë·∫£m b·∫£o kh√¥ng tr√†n ngang tr√™n m·ªçi thi·∫øt b·ªã */
    html,body{height:100%;margin:0;background:#f3f4f6;overflow-x:hidden}
    *{box-sizing:border-box;min-width:0}
    .hide{display:none !important;} /* quan tr·ªçng: ph·ª•c v·ª• show/hide m·ª•c */

    /* ===== HEADER (FIXED) ===== */
    .app-header{
      position:fixed; top:0; left:0; right:0; z-index:1000;
      background:#e8fff3; border-bottom:1px solid #d9f7e6;
      padding-top:env(safe-area-inset-top,0px);
    }
    .header-grid{
      display:grid; grid-template-columns: 1fr auto;
      align-items:center; gap:12px; padding:10px 12px;
    }
    .brand-row{ display:flex; align-items:center; gap:10px; min-width:0; }
    .logo-d{ height:70px; width:auto; display:block; flex:0 0 auto; }

    .title-wrap{ display:flex; flex-direction:column; gap:2px; min-width:0; }
    .title-top,.title-main{
      font-family:'Manulife JH Sans','ManulifeJHSans',system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif;
      color:var(--brand); font-weight:800;
      white-space:normal; overflow:visible; text-overflow:clip;
      word-break:keep-all; line-height:1.25; padding-block:2px;
    }
    .title-top{  font-size:clamp(14px, 1vw + 10px, 22px); text-transform:uppercase; }
    .title-main{ font-size:clamp(18px, 1.8vw + 12px, 34px); }

    /* ===== LOGIN / LOGOUT ===== */
    .login-cluster{ 
      display: flex; 
      gap: 16px; 
      align-items: flex-end;
      justify-self: end;
    }
    
    .input-group {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    
    .password-input-wrapper {
      position: relative;
      display: inline-block;
    }
    
    .login-cluster input{ 
      height: 44px; 
      padding: 0 12px; 
      font-size: 16px; 
      border: 1.3px solid #b7e7ce; 
      border-radius: 10px; 
      background: #effaf3; 
      font-weight: 600; 
      color: #0d7233; 
      outline: none; 
      width: 180px;
    }
    
    .toggle-password {
      position: absolute;
      right: 8px;
      top: 50%;
      transform: translateY(-50%);
      background: none;
      border: none;
      cursor: pointer;
      padding: 4px;
      border-radius: 4px;
      font-size: 16px;
      color: #666;
      transition: background-color 0.2s;
    }
    
    .toggle-password:hover {
      background-color: rgba(0, 0, 0, 0.1);
    }
    
    .password-input-wrapper input[type="password"] {
      padding-right: 40px;
    }
    
    /* ·∫®n n√∫t toggle khi ƒë√£ ƒëƒÉng nh·∫≠p */
    body.logged-in .toggle-password {
      display: none !important;
    }
    
    /* ·∫®n n√∫t toggle khi ƒë√£ ƒëƒÉng nh·∫≠p */
    body.logged-in .password-input-wrapper input {
      padding-right: 12px;
    }
    
    .login-cluster input::placeholder{ 
      color: #666; 
    }
    
    .login-btn{ 
      height: 44px; 
      padding: 0 18px; 
      background: #008a53; 
      color: #fff; 
      border: none; 
      border-radius: 10px; 
      font-weight: 800; 
      cursor: pointer; 
      touch-action: manipulation;
      min-width: 140px;
    }
    
    .login-btn:hover{ background: #066a42; }
    .logout-only{ display:none !important; }
    body.logged-in .login-only{ display:none !important; }
    body.logged-in .logout-only{ display:block !important; }

    /* ===== SIDEBAR (DESKTOP) ===== */
    #sidebar{ position:fixed; left:0; top:var(--header-h); bottom:var(--footer-h); width:var(--sidebar-width); background:#fff; border-right:1px solid #e5e7eb; z-index:900; overflow-y:auto; overflow-x:hidden; display:none; }
    .sidebar-inner{ padding:12px; }
    .menu-title{ font-weight:900; color:#065f46; margin:6px 8px 8px; white-space:normal; line-height:1.25; }
    .menu-group{ margin:12px 0 6px 8px; font-weight:900; color:#0b3d2c; white-space:normal; line-height:1.25; }
    .menu-item{ display:block; padding:.55rem .75rem; border-radius:.55rem; font-weight:800; color:#0b3d2c; white-space:normal; overflow-wrap:anywhere; word-break:break-word; line-height:1.25; font-size:0.96rem; }
    .menu-item:hover{ background:#e5f7ee; }
    .menu-item.active{ background:#0ea35b; color:#fff; }
    .submenu{ margin:.25rem 0 .5rem .75rem; }
    .submenu .menu-item{ padding:.45rem .6rem; }

    /* ===== MOBILE TOC (dropdown ch·ªâ cho mobile) ===== */
    #tocMobile{ position:fixed; top:var(--header-h); left:0; right:0; z-index:880; background:#fff; padding:10px 10px 6px; border-bottom:1px solid #e5e7eb; display:none; will-change:top; }
    #tocMobile .row{ display:flex; gap:8px; }
    #tocSelect{ flex:1 1 auto; height:44px; border:1px solid #c7d5e6; border-radius:10px; padding:0 10px; font-weight:800; color:#00519c; background:#eff5ff; font-size:16px; }
    #supportMobile{ 
      flex:0 0 auto; 
      display:inline-flex; 
      align-items:center; 
      justify-content:center; 
      height:44px; 
      padding:0 14px; 
      background:#00a758; 
      color:#fff; 
      border-radius:10px; 
      text-decoration:none; 
      font-weight:900; 
      white-space:nowrap; 
    }
    
    /* N√∫t h·ªó tr·ª£ mobile khi ƒë√£ ƒëƒÉng nh·∫≠p - gi·ªØ v·ªã tr√≠ trong TOC */
    body.logged-in #supportMobile {
      position: relative;
      right: auto;
      bottom: auto;
    }

    /* ===== CONTENT ===== */
    body{ padding-top: calc(var(--header-h) + var(--toc-h) + 8px); }
    body{ padding-bottom: calc(2.25 * var(--footer-h) + env(safe-area-inset-bottom,0px)); }

    #contentWrap{ margin-left:0; }
    body.sidebar-open #contentWrap{ margin-left:var(--sidebar-width); }
    main{ max-width:1366px; margin:0 auto; padding:14px; }

    /* ·∫®n to√†n b·ªô ph·∫ßn ngo√†i header khi ch∆∞a login */
    body.logged-out #sidebar,
    body.logged-out #contentWrap,
    body.logged-out #supportDesk { display:none !important; }
      
      /* ·∫®n dropdown TOC khi ch∆∞a login nh∆∞ng gi·ªØ n√∫t h·ªó tr·ª£ */
      body.logged-out #tocMobile .row { display:none !important; }
      body.logged-out #tocMobile { display:block !important; }
      
      /* Hi·ªÉn th·ªã n√∫t h·ªó tr·ª£ mobile khi ch∆∞a ƒëƒÉng nh·∫≠p - n·∫±m tr√™n footer */
      body.logged-out #tocMobile::after {
        content: "H·ªó tr·ª£";
        display: inline-flex;
        align-items: center;
        justify-content: center;
        height: 44px;
        padding: 0 14px;
        background: #00a758;
        color: #fff;
        border-radius: 10px;
        text-decoration: none;
        font-weight: 900;
        white-space: nowrap;
        position: fixed;
        right: 10px;
        bottom: calc(var(--footer-h) + 14px);
        z-index: 940;
      }

    .section-title{ background:#fff; padding:12px 16px; border-left:6px solid #0ea35b; border-radius:8px; font-weight:900; color:#0b3d2c; margin:6px 0 14px; }

    /* ===== INFO GRID ===== */
    .info-grid{ display:grid; grid-template-columns: repeat(auto-fit, minmax(240px,1fr)); gap:.85rem; }
    .info-item{ display:flex; flex-direction:column; gap:.3rem; background:#fff; border:1px solid #e5e7eb; border-left:4px solid #0ea35b; border-radius:.6rem; padding:.7rem .85rem; }
    .info-item .val{ font-size:1.05rem; line-height:1.3; word-break:break-word; }
    .pro-alert{ margin-top:.4rem; padding:.7rem .9rem; border:2px solid #dc2626; border-left-width:6px; border-radius:.6rem; background:#fff; color:#b91c1c; font-weight:900; font-size:1.05rem; }

    .list-dot li, .bullet-strong li{ list-style:none; padding-left:0; display:grid; grid-template-columns:minmax(170px,max-content) 1fr; column-gap:1rem; align-items:start; margin:.3rem 0; }
    .bullet-strong li{ border-left:3px solid #0ea35b; padding-left:.75rem; }
    .hl{ grid-column:2; font-weight:900; font-size:1.02rem; line-height:1.3; color:#10b981; }
    .thin{ font-weight:700; color:#0b3d2c; }
    .subsec{ margin:12px 0 10px; font-weight:900; color:#0b3d2c; padding-left:.75rem; border-left:6px solid #0ea35b; font-size:1.05rem; }
    .sub-block{ margin-bottom:8px; }
    .sub-content{ margin-left:20px; }
    .fa-hide{ display:block; }
    body.is-fa-or-sa .fa-hide{ display:none !important; }

    /* ===== MOBILE ===== */
    @media (max-width:1023px){
      .header-grid{ grid-template-columns:1fr; }
      .brand-row{ justify-content:flex-start; }
      .login-cluster{ width:100%; justify-self:stretch; grid-template-columns:1fr; }
      .logo-d{ height:44px; }
      body.sidebar-open #contentWrap{ margin-left:0 }
      body.logged-in #tocMobile{ display:block; }   /* dropdown ch·ªâ hi·ªán ·ªü mobile khi ƒë√£ login */
      .list-dot li, .bullet-strong li{
        grid-template-columns: minmax(0,1fr) auto;  /* nh√£n co gi√£n, xu·ªëng d√≤ng */
        align-items:flex-start;
      }
    }
    @media (min-width:1024px){
      body.logged-in #sidebar{ display:block; }
      body.logged-in.sidebar-open #supportDesk{ display:inline-flex; } /* n√∫t h·ªó tr·ª£ n·ªïi ch·ªâ desktop */
    }

    /* ===== FOOTER ===== */
    #pageFooter{ position:fixed; left:0; right:0; bottom:0; min-height:var(--footer-h); display:flex; flex-direction:column; align-items:center; justify-content:center; gap:6px; background:#f4f6f8; color:#0b3a2a; border-top:1px solid #e3e7eb; z-index:950; padding:8px 10px 10px; text-align:center; font-weight:800; }
    #pageFooter img{ height:22px; width:auto; display:block; }
    #contentWrap::after{ content:""; display:block; height: calc(0.75 * var(--footer-h) + 24px); }

    /* H·ªó tr·ª£ desktop - lu√¥n n·∫±m g√≥c d∆∞·ªõi ph√≠a tr√™n footer */
    #supportDesk{ 
      position:fixed; 
      right:18px; 
      bottom:calc(var(--footer-h) + 14px); 
      background:#00a758;
      color:#fff;
      padding:12px 16px;
      border-radius:28px;
      font-weight:900;
      text-decoration:none;
      box-shadow:0 4px 12px rgba(0,0,0,.18); 
      z-index:940; 
      display:inline-flex !important; 
    }

    /* Th√¥ng b√°o l·ªói d∆∞·ªõi header */
    #errorTop{ display:none; margin:0; border-top:1px solid #f5c2c7; background:#fff5f5; color:#b91c1c; font-weight:800; padding:8px 12px; }
    #errorTop.show{ display:block; }

    /* Nh√£n (label) cho m·ª•c B ƒë·ªÉ d·ªÖ xu·ªëng d√≤ng ·ªü mobile */
    .li-label{
      font-weight:700; color:#0b3d2c;
      white-space:normal; overflow-wrap:anywhere; line-height:1.3;
    }
    #sectionInfo .info-item .val { font-weight: 900; color: #10b981; }

  </style>
</head>
<body class="logged-out">
  <!-- ===== HEADER ===== -->
  <header id="pageHeader" class="app-header">
    <div class="header-grid">
      <div class="brand-row">
         &#160;&#160;<img src="/logo.webp" alt="logo" class="logo-d" />
        <div class="title-wrap">
          <div class="title-top">C·ªîNG TH√îNG TIN V√ôNG H·∫∞NG L√ÇM</div>
          <div class="title-main">H·ªÜ TH·ªêNG B√ÅO C√ÅO C√Å NH√ÇN</div>
        </div>
      </div>

      <!-- C·ª•m ƒëƒÉng nh·∫≠p / ƒëƒÉng xu·∫•t -->
      <form id="loginForm" class="login-cluster">
        <div class="input-group">
          <input class="login-only" type="text" id="msdlInput" placeholder="Nh·∫≠p MSDL" required />
          <div class="password-input-wrapper">
            <input class="login-only" type="password" id="dateInput" placeholder="Ng√†y gia nh·∫≠p" required />
            <button type="button" class="toggle-password" onclick="togglePassword()">
              <span class="eye-icon">üëÅÔ∏è</span>
            </button>
          </div>
        </div>
        <button id="loginBtn" class="login-btn login-only" type="submit">ƒêƒÉng nh·∫≠p</button>
        <button id="logoutBtn" class="login-btn logout-only" type="button">ƒêƒÉng xu·∫•t</button>
      </form>
    </div>
    <div id="errorTop"></div>
  </header>

  <!-- ===== TOC ch·ªâ d√†nh cho mobile ===== -->
  <div id="tocMobile">
      <div class="update-date-mobile" id="mobileUpdateDate" style="display: none; text-align: center; padding: 8px 0; color: #0b3d2c; font-weight: 700; font-size: 14px; border-bottom: 1px solid #e5e7eb;"></div>
    <div class="row">
      <select id="tocSelect" aria-label="Ch·ªçn m·ª•c"></select>
      <a id="supportMobile" href="http://zalo.me/0376763390" target="_blank" rel="noopener">H·ªó tr·ª£</a>
    </div>
  </div>

  <!-- ===== SIDEBAR (desktop) ===== -->
  <aside id="sidebar">
    <div class="sidebar-inner">
        <div class="menu-title" id="sidebarUpdateDate">Danh m·ª•c</div>

      <a href="#" class="menu-item active" data-target="sectionInfo">TH√îNG TIN ƒê·∫†I L√ù</a>
      <a href="#" class="menu-item" data-target="sectionA">A. T·ªîNG QUAN (MTD)</a>

      <div class="menu-group">B. HO·∫†T ƒê·ªòNG C√Å NH√ÇN</div>
      <div class="submenu">
        <a href="#" class="menu-item" data-target="sectionB" data-anchor="#b1">B.1 B√°n h√†ng</a>
        <a href="#" class="menu-item" data-target="sectionB" data-anchor="#b2">B.2 Manulife Pro</a>
        <a href="#" class="menu-item" data-target="sectionB" data-anchor="#b3">B.3 MDRT+</a>
        <a href="#" class="menu-item" data-target="sectionB" data-anchor="#b4">B.4 M-Star / Japan</a>
        <a href="#" class="menu-item" data-target="sectionB" data-anchor="#b5">B.5 Th∆∞·ªüng nƒÉm</a>
      </div>

      <div class="menu-group">C. TUY·ªÇN D·ª§NG & H·ªÜ TH·ªêNG</div>
      <div class="submenu">
        <a href="#" class="menu-item" data-target="sectionC" data-anchor="#c1">C.1 Tuy·ªÉn d·ª•ng</a>
        <a href="#" class="menu-item" data-target="sectionC" data-anchor="#c2">C.2 ThƒÉng c·∫•p</a>
        <a href="#" class="menu-item fa-hide" data-target="sectionC" data-anchor="#c3">C.3 Duy tr√¨ ch·ª©c danh</a>
        <a href="#" class="menu-item fa-hide" data-target="sectionC" data-anchor="#c4">C.4 MBA Pro</a>
        <a href="#" class="menu-item fa-hide" data-target="sectionC" data-anchor="#c5">C.5 Th∆∞·ªüng nh√≥m ∆∞u t√∫</a>
      </div>

      <!-- M·ªü tab m·ªõi -->
      <a href="https://tracuubaocao.vunghanglam.com/income/" target="_blank" rel="noopener" class="menu-item">T√çNH THU NH·∫¨P</a>
    </div>
  </aside>

  <!-- ===== CONTENT ===== -->
  <a id="supportDesk" href="http://zalo.me/0376763390" target="_blank" rel="noopener">H·ªó tr·ª£</a>

  <div id="contentWrap">
    <main>
      <section id="report"></section>
    </main>
  </div>

  <!-- ===== FOOTER ===== -->
  <footer id="pageFooter">
    <div>B·∫£n quy·ªÅn trang web thu·ªôc v·ªÅ</div>
    <img src="/logo_textr.webp" alt="Logo" />
  </footer>

  <!-- ===== LOGIC ===== -->
  <script>
    /* ===== STATE ===== */
    let dataRows = [];
    let mapping = [];
    let dataReady;
    let loggedIn = false;
    
    /* ===== PASSWORD TOGGLE ===== */
    function togglePassword() {
      const dateInput = document.getElementById('dateInput');
      const eyeIcon = document.querySelector('.eye-icon');
      
      if (dateInput.type === 'password') {
        dateInput.type = 'text';
        eyeIcon.textContent = 'üôà';
      } else {
        dateInput.type = 'password';
        eyeIcon.textContent = 'üëÅÔ∏è';
      }
    }

    /* ===== CONST ===== */
    const INCOME_URL  = 'https://tracuubaocao.vunghanglam.com/income/';

    /* ===== LOAD DATA ===== */
    async function loadData(){
      const mapUrl = encodeURI('tham chieu.json');
      const dataUrl = 'data.json';
      const [mapS, dataS] = await Promise.allSettled([
        fetch(mapUrl).then(r => r.ok ? r.json() : []),
        fetch(dataUrl).then(r => r.ok ? r.json() : [])
      ]);
      mapping = (mapS.status === 'fulfilled' && Array.isArray(mapS.value)) ? mapS.value : [];
      dataRows = (dataS.status === 'fulfilled' && Array.isArray(dataS.value)) ? dataS.value : [];
    }
    dataReady = loadData();

    /* ===== DOM ===== */
    const reportEl  = document.getElementById('report');
    const errorTop  = document.getElementById('errorTop');
    const loginForm = document.getElementById('loginForm');
    const msdlInput = document.getElementById('msdlInput');
    const dateInput = document.getElementById('dateInput');
    const loginBtn  = document.getElementById('loginBtn');
    const logoutBtn = document.getElementById('logoutBtn');

    function isMobile(){ return window.matchMedia('(max-width: 1023px)').matches; }

    /* ===== UTIL ===== */
    function showErrorTop(msg){ if(!msg){errorTop.classList.remove('show'); errorTop.textContent=''; return;} errorTop.textContent=msg; errorTop.classList.add('show'); }

    function normalizeDate(s){
      if(!s) return '';
      s = String(s).trim();
      if (/^\d{8}$/.test(s)) { const d=s.slice(0,2), m=s.slice(2,4), y=s.slice(4,8); return `${d}/${m}/${y}`; }
      if (/^\d{1,2}\/\d{1,2}\/\d{4}$/.test(s)) { const [d,m,y]=s.split('/').map(x=>parseInt(x,10)); return `${String(d).padStart(2,'0')}/${String(m).padStart(2,'0')}/${y}`; }
      if (/^\d{4}-\d{1,2}-\d{1,2}$/.test(s)) { const [y,m,d]=s.split('-').map(x=>parseInt(x,10)); return `${String(d).padStart(2,'0')}/${String(m).padStart(2,'0')}/${y}`; }
      return s;
    }
    function normalizeMSDL(s){ return String(s||'').trim().replace(/\s+/g,'').toLowerCase(); }

    function parseLocaleNumber(v){
      if (v===null||v===undefined||v==='') return NaN;
      if (typeof v==='number') return v;
      let s = String(v).trim().replace(/[^0-9,.\-]/g,'');
      if (s===''||s==='-'||s==='.'||s===',') return NaN;
      const hasDot=s.includes('.'), hasComma=s.includes(',');
      if (hasDot&&hasComma){
        if (s.lastIndexOf(',')>s.lastIndexOf('.')){ s=s.replace(/\./g,'').replace(',', '.'); }
        else { s=s.replace(/,/g,''); }
      } else if (hasComma&&!hasDot){ s=s.replace(',', '.'); }
      const n=parseFloat(s); return isNaN(n)?NaN:n;
    }
    function formatThousand(n,dec){ if (n===null||n===undefined||isNaN(n)) return ""; const fixed = Number(n).toFixed(dec); let [intPart, frac=""] = fixed.split('.'); const sign = intPart.startsWith('-')?'-':''; intPart = intPart.replace('-','').replace(/\B(?=(\d{3})+(?!\d))/g,'.'); return sign + intPart + (dec>0?','+frac:""); }
    function formatF3(val){ const n=parseLocaleNumber(val); if(isNaN(n)) return val??""; return formatThousand(n,3); }
    function formatNumber(val){ return (val ?? ""); }

    function normalizeLabel(label=""){ return String(label||"").toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/\s+/g,' ').trim(); }
    const FORCE_F3_LABELS = new Set([
      'Doanh thu FYP th·ª±c c·∫•p','T·ªïng doanh thu FYP','FYP ph√°t sinh t√≠nh th∆∞·ªüng','M·ª©c th∆∞·ªüng t·∫°m ƒë·∫°t','C·∫ßn th√™m ƒë·ªÉ ƒë·∫°t m·ª©c th∆∞·ªüng ti·∫øp theo','M·ª©c th∆∞·ªüng ti·∫øp theo','FYP c·∫ßn th√™m ƒë·ªÉ thƒÉng h·∫°ng','FYP th·ª±c ƒë·∫°t (YTD)','FYP c·∫ßn th√™m ƒë·ªÉ ƒë·∫°t ti·∫øn ƒë·ªô qu√Ω hi·ªán t·∫°i','FYP c·∫ßn th√™m ƒë·ªÉ ƒë·∫°t danh hi·ªáu MDRT+','FYP ph√°t sinh trong th·ªùi gian thi ƒëua','T·ªïng FYP c·∫ßn th√™m ƒë·ªÉ ƒë·∫°t thi ƒëua','T·ªïng FYP ph√°t sinh (YTD)','FYC Whole team L6M sau lu·∫≠t 50% c·∫ßn th√™m','fYP Whole team L6M sau lu·∫≠t 50% c·∫ßn th√™m','FYC c√° nh√¢n UM+ v√† ƒêL tr·ª±c ti·∫øp L12M sau lu·∫≠t 50%','FYC c√° nh√¢n UM+ v√† ƒêL tr·ª±c ti·∫øp L12M sau lu·∫≠t 50%','T·ªïng FYP ph√°t sinh trong th√°ng c·ªßa b·∫£n th√¢n UM+ (A)','FYP c·ªßa b·∫£n th√¢n UM+ (A) v√† nh√≥m tr·ª±c ti·∫øp sau lu·∫≠t 50%','FYP c·ªßa b·∫£n th√¢n UM+ (B) b√°o c√°o tr·ª±c ti·∫øp cho UM+ (A)','T·ªïng FYP sau lu·∫≠t 50% d√πng ƒë·ªÉ t√≠nh th∆∞·ªüng (c·∫•p UM)','T·ªïng FYP WT tr∆∞·ªõc lu·∫≠t 50% (c·∫•p SUM+)','T·ªïng FYP WT sau lu·∫≠t 50% ƒë·ªÉ t√≠nh th∆∞·ªüng (c·∫•p SUM+)','Th∆∞·ªüng d·ª± t√≠nh sau khi ƒë√£ nh√¢n h·ªá s·ªë TLDTHD'
    ].map(normalizeLabel));
    function shouldF3Label(label=""){ const norm = normalizeLabel(label); if (FORCE_F3_LABELS.has(norm)) return true; return (norm.includes('fyp') || norm.includes('fyc')); }
    function fmt(val,key="",label=""){ return shouldF3Label(label)?formatF3(val):(val??""); }
    function addPercent(val){ return (val ?? ""); }
    function exists(v){ return !(v===null||v===undefined||(typeof v==='string'&&v.trim()==='')); }
    function pick(row,keys){ for (const k of keys) if (exists(row[k])) return row[k]; return ''; }

    /* ===== B·ªî SUNG: format s·ªë nguy√™n cho NRA & b·ªçc nh√£n m·ª•c B ===== */
    function formatInt(val){
      const n = parseLocaleNumber(val);
      if (isNaN(n)) return (val ?? "");
      return String(Math.round(n));
    }
    function enhanceListLabels(){
      const sectionB = document.getElementById('sectionB');
      if(!sectionB) return;
      sectionB.querySelectorAll('.list-dot li, .bullet-strong li').forEach(li=>{
        if(li.querySelector('.li-label')) return;
        const valEl = li.querySelector('.hl'); 
        if(!valEl) return;
        const before = [];
        for (const node of Array.from(li.childNodes)){
          if(node === valEl) break;
          before.push(node);
        }
        const labelText = before.map(n=>n.textContent||'').join('').replace(/\s*:\s*$/,'');
        const span = document.createElement('span');
        span.className = 'li-label';
        span.textContent = labelText + ': ';
        before.forEach(n=>li.removeChild(n));
        li.insertBefore(span, valEl);
      });
    }
    function coerceNRAIntegers(){
      const sectionB = document.getElementById('sectionB');
      if(!sectionB) return;
      sectionB.querySelectorAll('.list-dot li, .bullet-strong li').forEach(li=>{
        const labelEl = li.querySelector('.li-label'); 
        const valEl = li.querySelector('.hl');
        if(!labelEl || !valEl) return;
        if(/nra/i.test(labelEl.textContent)){
          const n = parseLocaleNumber(valEl.textContent);
          if(!isNaN(n)){ valEl.textContent = String(Math.round(n)); }
        }
      });
    }

    /* ===== LAYOUT HELPERS ===== */
    function setLayoutVars(){
      const head=document.getElementById('pageHeader');
      const footer=document.getElementById('pageFooter');
      const toc=document.getElementById('tocMobile');
      const h = head ? Math.ceil(head.getBoundingClientRect().height) : 64;
      const f = footer ? Math.ceil(footer.getBoundingClientRect().height) : 66;
      let t = 0;
      if(toc && getComputedStyle(toc).display!=='none') t = Math.ceil(toc.getBoundingClientRect().height);
      document.documentElement.style.setProperty('--header-h', h+'px');
      document.documentElement.style.setProperty('--footer-h', f+'px');
      document.documentElement.style.setProperty('--toc-h', t+'px');
    }
    function applySidebarMode(){ if(!document.body.classList.contains('logged-in')) return; if(window.matchMedia('(min-width:1024px)').matches){ document.body.classList.add('sidebar-open'); } else { document.body.classList.remove('sidebar-open'); } }

    /* ===== SECTION RENDER ===== */
    function infoItem(label, value){ if(!exists(value)) return ''; return `<div class="info-item"><div class="label">${label}:</div><div class="val">${value}</div></div>`; }
    function renderInfoSection(row){
      const p13cn = addPercent(row["TLDTHD c√° nh√¢n"]);
      const p13nh = addPercent(row["TLDTHD to√†n nh√°nh"]);
      const p13c1 = addPercent(row["TLDTHD c·∫•p 1"]);
      const proMoc3 = row["PRO.MOC 3 THANG"];
      const hasAlert = exists(proMoc3) && String(proMoc3).trim() !== "-";
      const alertHtml = hasAlert ? `<div class="pro-alert ${isMobile() ? 'info-alert' : ''}">C·∫£nh b√°o: <span class="pro-name" style="font-weight:900;">Danh hi·ªáu Manulife Pro</span> ‚Äì ${proMoc3}</div>` : "";
      
      // Ki·ªÉm tra ch·ª©c danh c√≥ ph·∫£i FA ho·∫∑c SA kh√¥ng
      const chucDanh = String(row["Ch·ª©c danh"] || "").toUpperCase();
      const isFAorSA = chucDanh.includes("FA") || chucDanh.includes("SA") || chucDanh === "FA" || chucDanh === "SA";
      
      // Debug log
      console.log('renderInfoSection - Ch·ª©c danh:', row["Ch·ª©c danh"]);
      console.log('renderInfoSection - isFAorSA:', isFAorSA);
      
      const firstBlock = infoItem("B√°o c√°o d√†nh cho", (row["TEN DAI LY"] || row["AGEN NAME"]));
      const restBlocks = `
        ${infoItem("KV | MS", row["KV|MS"])}
        ${infoItem("Ng√†y gia nh·∫≠p", row["JOIN DATE"])}
        ${infoItem("Th√°ng l√†m vi·ªác", row["WORK MNTHS"])}
        ${infoItem("Ch·ª©c danh", row["Ch·ª©c danh"])}
        ${infoItem("Ng√†y hi·ªáu l·ª±c Ch·ª©c danh", row["Ng√†y hi·ªáu l·ª±c Ch·ª©c danh"])}
        ${infoItem("Nh√≥m ƒë·∫°i l√Ω", row["Nh√≥m ƒê·∫°i l√Ω"])}
        ${infoItem("Manulife Pro (ch√≠nh th·ª©c)", row["PRO.DH CHINH THUC"])}
        ${infoItem("Ch√≠nh th·ª©c t·ª´", row["PRO.BAT DAU"])}
        ${infoItem("Manulife Pro (t·∫°m t√≠nh)", row["PRO.DH TAM TINH CAO  NHAT"])}
        ${infoItem("P13 C√° nh√¢n", p13cn)}
        <div class="info-item fa-hide">
          <div class="label">P13 To√†n nh√°nh</div>
          <div class="val">${p13nh}</div>
        </div>
        <div class="info-item fa-hide">
          <div class="label">P13 c·∫•p 1</div>
          <div class="val">${p13c1}</div>
        </div>
      
      `;
      const gridInner = isMobile() ? `${alertHtml}${firstBlock}${restBlocks}` : `${firstBlock}${restBlocks}`;
      const alertAfter = (!isMobile() && hasAlert) ? alertHtml : "";
      return `
        <div id="sectionInfo" class="section">
          <div class="section-title">Th√¥ng tin ƒë·∫°i l√Ω</div>
          <div class="info-grid">${gridInner}</div>
          ${alertAfter}
        </div>
      `;
    }

    function renderReport(row){
      // Ki·ªÉm tra ch·ª©c danh c√≥ ph·∫£i FA ho·∫∑c SA kh√¥ng
      const chucDanh = String(row["Ch·ª©c danh"] || "").toUpperCase();
      const isFAorSA = chucDanh.includes("FA") || chucDanh.includes("SA") || chucDanh === "FA" || chucDanh === "SA";
      
      // Debug log
      console.log('renderReport - Ch·ª©c danh:', row["Ch·ª©c danh"]);
      console.log('renderReport - isFAorSA:', isFAorSA);
      
      const Info = renderInfoSection(row);
      const A = `
        <div id="sectionA" class="section hide">
          <div class="section-title">A. B√ÅO C√ÅO T·ªîNG QUAN ‚Äì (Month to date)</div>
          <ul class="mb-4 list-dot bullet-strong lvl-2">
            <li><span class="thin">S·ªë h·ª£p ƒë·ªìng th·ª±c c·∫•p:</span> <span class="hl">${formatNumber(row["MTD.CC CAP"])}</span></li>
            <li><span class="thin">Doanh thu FYP th·ª±c c·∫•p:</span> <span class="hl">${fmt(row["MTD.FYP CAP"], "MTD.FYP CAP", "Doanh thu FYP th·ª±c c·∫•p")}</span></li>
            <li><span class="thin">S·ªë l∆∞·ª£ng ƒê·∫°i l√Ω m·ªõi tuy·ªÉn d·ª•ng:</span> <span class="hl">${formatNumber(row["RECRUIT T"])}</span></li>
          </ul>
        </div>`;

      const B = `
        <div id="sectionB" class="section hide">
          <div class="section-title">B. B√ÅO C√ÅO CHI TI·∫æT HO·∫†T ƒê·ªòNG C√Å NH√ÇN</div>

          <div id="b1" class="sub-block">
            <div class="subsec lvl-1">1. Ho·∫°t ƒë·ªông b√°n h√†ng</div>
            <div class="sub-content">
              <div class="subsec lvl-2"><strong>N·ªôp m·ªõi trong th√°ng</strong></div>
            <ul class="mb-2 list-dot bullet-strong lvl-3">
                <li><span class="thin">T·ªïng s·ªë h·ª£p ƒë·ªìng:</span> <span class="hl">${formatNumber(row["MTD.CC NOP"])}</span></li>
                <li><span class="thin">T·ªïng doanh thu FYP:</span> <span class="hl">${fmt(row["MTD.FYP NOP"], "MTD.FYP NOP", "T·ªïng doanh thu FYP")}</span></li>
            </ul>
              <div class="subsec lvl-2"><strong>Th·ª±c c·∫•p trong th√°ng</strong></div>
            <ul class="mb-2 list-dot bullet-strong lvl-3">
                <li><span class="thin">T·ªïng s·ªë h·ª£p ƒë·ªìng:</span> <span class="hl">${formatNumber(row["MTD.CC CAP"])}</span></li>
                <li><span class="thin">T·ªïng doanh thu FYP:</span> <span class="hl">${fmt(row["MTD.FYP CAP"], "MTD.FYP CAP", "T·ªïng doanh thu FYP")}</span></li>
            </ul>
            </div>
          </div>

          <div id="b2" class="sub-block hide">
            <div class="subsec lvl-1">2. Danh hi·ªáu Manulife Pro</div>
            <div class="sub-content">
              <div class="thin mb-1 lvl-2"><strong>Danh hi·ªáu ch√≠nh th·ª©c hi·ªán t·∫°i:</strong> <span class="hl">${formatNumber(row["PRO.DH CHINH THUC"])}</span></div>
            <ul class="mb-2 list-dot bullet-strong lvl-3">
                <li><span class="thin">Th√°ng b·∫Øt ƒë·∫ßu:</span> <span class="hl">${formatNumber(row["PRO.BAT DAU"])}</span></li>
                <li><span class="thin">Th√°ng k·∫øt th√∫c:</span> <span class="hl">${formatNumber(row["PRO.KET THUC"])}</span></li>
            </ul>
              <div class="thin mb-1 lvl-2"><strong>Th∆∞·ªüng nƒÉng su·∫•t xu·∫•t s·∫Øc th√°ng hi·ªán t·∫°i:</strong></div>
              <ul class="mb-2 list-dot bullet-strong lvl-3">
                <li><span class="thin">Danh hi·ªáu d√πng ƒë·ªÉ x√©t th∆∞·ªüng:</span> <span class="hl">${formatNumber(row["PRO.DH XET THUONG"])}</span></li>
                <li><span class="thin">FYP ph√°t sinh t√≠nh th∆∞·ªüng:</span> <span class="hl">${fmt(row["PRO.FYP HIEN TAI"], "PRO.FYP HIEN TAI", "FYP ph√°t sinh t√≠nh th∆∞·ªüng")}</span></li>
                <li><span class="thin">M·ª©c th∆∞·ªüng t·∫°m ƒë·∫°t:</span> <span class="hl">${fmt(row["PRO.THUONG TAM DAT"], "PRO.THUONG TAM DAT", "M·ª©c th∆∞·ªüng t·∫°m ƒë·∫°t")}</span></li>
                <li><span class="thin">C·∫ßn th√™m ƒë·ªÉ ƒë·∫°t m·ª©c th∆∞·ªüng ti·∫øp theo:</span> <span class="hl">${fmt(row["PRO.FYP CAN TANG THUONG"], "PRO.FYP CAN TANG THUONG", "C·∫ßn th√™m ƒë·ªÉ ƒë·∫°t m·ª©c th∆∞·ªüng ti·∫øp theo")}</span></li>
                <li><span class="thin">M·ª©c th∆∞·ªüng ti·∫øp theo:</span> <span class="hl">${fmt(row["PRO.THUONG TIEP THEO"], "PRO.THUONG TIEP THEO", "M·ª©c th∆∞·ªüng ti·∫øp theo")}</span></li>
            </ul>
              <div class="thin mb-1 lvl-2"><strong>Theo d√µi thƒÉng h·∫°ng danh hi·ªáu</strong></div>
              <ul class="mb-2 list-dot bullet-strong lvl-3">
                <li><span class="thin">Ti·∫øn ƒë·ªô thƒÉng h·∫°ng danh hi·ªáu:</span> <span class="hl">${addPercent(row["PRO % THANG HANG"])}</span></li>
                <li><span class="thin">K·∫øt qu·∫£ t·∫°i th√°ng T-2:</span> <span class="hl">${formatNumber(row["PRO.DH TAM TINH T-2"])}</span></li>
                <li><span class="thin">K·∫øt qu·∫£ t·∫°i th√°ng T-1:</span> <span class="hl">${formatNumber(row["PRO.DH TAM TINH T-1"])}</span></li>
                <li><span class="thin">FYP c·∫ßn th√™m ƒë·ªÉ thƒÉng h·∫°ng:</span> <span class="hl">${fmt(row["PRO.UP FYP CAN THEM"], "PRO.UP FYP CAN THEM", "FYP c·∫ßn th√™m ƒë·ªÉ thƒÉng h·∫°ng")}</span></li>
                <li><span class="thin">CC c·∫ßn th√™m ƒë·ªÉ ƒë·ªÉ thƒÉng h·∫°ng:</span> <span class="hl">${formatNumber(row["PRO.UP CC CAN THEM"])}</span></li>
                <li><span class="thin">S·ªë th√°ng c√≥ ho·∫°t ƒë·ªông c·∫ßn th√™m:</span> <span class="hl">${formatNumber(row["PRO.UP THANG CAN THEM"])}</span></li>
                <li><span class="thin">T·ª∑ l·ªá P13 c·∫ßn th√™m ƒë·ªÉ ƒë·∫°t danh hi·ªáu:</span> <span class="hl">${addPercent(row["PRO.UP P13 CAN THEM"])}</span></li>
            </ul>
              <div class="thin mb-1 lvl-2"><strong>Theo d√µi duy tr√¨ danh hi·ªáu</strong></div>
              <ul class="mb-2 list-dot bullet-strong lvl-3">
                <li><span class="thin">K·∫øt qu·∫£ x√©t duy tr√¨ danh hi·ªáu:</span> <span class="hl">${formatNumber(row["PRO.KQ DUY TRI"])}</span></li>
                <li><span class="thin">T·∫°m t√≠nh theo k·∫øt qu·∫£ t·∫°i th√°ng T-2:</span> <span class="hl">${formatNumber(row["PRO.DH TAM TINH T-2"])}</span></li>
                <li><span class="thin">T·∫°m t√≠nh theo k·∫øt qu·∫£ t·∫°i th√°ng T-1:</span> <span class="hl">${formatNumber(row["PRO.DH TAM TINH T-1"])}</span></li>
                <li><span class="thin">Danh hi·ªáu t·∫°m t√≠nh cao nh·∫•t:</span> <span class="hl">${formatNumber(row["PRO.DH TAM TINH CAO NHAT"])}</span></li>
                <li><span class="thin">Ti·∫øn ƒë·ªô duy tr√¨ danh hi·ªáu:</span> <span class="hl">${addPercent(row["PRO % MOC"])}</span></li>
                <li><span class="thin">Giai ƒëo·∫°n ƒë√°nh gi√°:</span> <span class="hl">${formatNumber(row["PRO.GD MOC"])}</span></li>
                <li><span class="thin">FYP ƒë√£ ƒë·∫°t so v·ªõi y√™u c·∫ßu:</span> <span class="hl">${row["PRO.MOC FYP"]}</span></li>
                <li><span class="thin">S·ªë th√°ng c√≥ ho·∫°t ƒë·ªông so v·ªõi y√™u c·∫ßu:</span> <span class="hl">${formatNumber(row["PRO.MOC THANG Hƒê"])}</span></li>
                <li><span class="thin">C·∫£nh b√°o 3 th√°ng cu·ªëi k·ª≥ x√©t:</span> <span class="hl">${formatNumber(row["PRO.MOC 3 THANG"])}</span></li>
            </ul>
            </div>
          </div>

          <div id="b3" class="sub-block hide">
            <div class="subsec lvl-1">3. Danh hi·ªáu MDRT+</div>
            <div class="sub-content">
              <div class="lvl-2"><strong>Y√™u c·∫ßu FYP ti·∫øn ƒë·ªô qu√Ω hi·ªán t·∫°i:</strong> <span class="hl">${fmt(row["MDRT.FYP Y/C QUY HT"], "MDRT.FYP Y/C QUY HT", "FYP ti·∫øn ƒë·ªô qu√Ω hi·ªán t·∫°i")}</span></div>
              <div class="lvl-2"><strong>Ti·∫øn ƒë·ªô qu√Ω hi·ªán t·∫°i ƒë√£ ƒë·∫°t:</strong> <span class="hl">${addPercent(row["MDRT.TIEN DO QUY"])}</span></div>
              <ul class="mb-2 list-dot bullet-strong lvl-3">
                <li><span class="thin">FYP th·ª±c ƒë·∫°t (YTD):</span> <span class="hl">${fmt(row["MDRT.FYP CAP"], "MDRT.FYP CAP", "FYP th·ª±c ƒë·∫°t (YTD)")}</span></li>
                <li><span class="thin">FYP c·∫ßn th√™m ƒë·ªÉ ƒë·∫°t ti·∫øn ƒë·ªô qu√Ω hi·ªán t·∫°i:</span> <span class="hl">${fmt(row["MDRT.FYP CAN DAT TD QUY"], "MDRT.FYP CAN DAT TD QUY", "FYP c·∫ßn th√™m ƒë·ªÉ ƒë·∫°t ti·∫øn ƒë·ªô qu√Ω hi·ªán t·∫°i")}</span></li>
                <li><span class="thin">FYP c·∫ßn th√™m ƒë·ªÉ ƒë·∫°t danh hi·ªáu MDRT+:</span> <span class="hl">${fmt(row["MDRT.FYP CAN DAT DH"], "MDRT.FYP CAN DAT DH", "FYP c·∫ßn th√™m ƒë·ªÉ ƒë·∫°t danh hi·ªáu MDRT+")}</span></li>
                <li><span class="thin">Danh hi·ªáu ƒëang trong ti·∫øn ƒë·ªô:</span> <span class="hl">${formatNumber(row["MDRT.DH TIEP THEO"])}</span></li>
            </ul>
            </div>
          </div>

          <div id="b4" class="sub-block hide">
            <div class="subsec lvl-1">4. H√†nh tr√¨nh M-Star, X·ª© s·ªü hoa anh ƒë√†o</div>
            <div class="sub-content">
              <ul class="mb-2 list-dot bullet-strong lvl-3">
                <li><span class="thin">FYP ph√°t sinh trong th·ªùi gian thi ƒëua:</span> <span class="hl">${fmt(row["JPAN.FYP THI DUA"], "JPAN.FYP THI DUA", "FYP ph√°t sinh trong th·ªùi gian thi ƒëua")}</span></li>
                <li><span class="thin">T·ªïng FYP c·∫ßn th√™m ƒë·ªÉ ƒë·∫°t thi ƒëua:</span> <span class="hl">${fmt(row["JPAN.FYP CAN DAT"], "JPAN.FYP CAN DAT", "T·ªïng FYP c·∫ßn th√™m ƒë·ªÉ ƒë·∫°t thi ƒëua")}</span></li>
                <li><span class="thin">T·ª∑ l·ªá P13 hi·ªán t·∫°i:</span> <span class="hl">${addPercent(row["JPAN.P13"])}</span></li>
                <li><span class="thin">S·ªë l∆∞·ª£ng v√© ƒë·∫°t t·∫°m t√≠nh:</span> <span class="hl">${formatNumber(row["JPAN.ƒê·∫°t v√© (t·∫°m t√≠nh)"])}</span></li>
            </ul>
            </div>
          </div>

          <div id="b5" class="sub-block hide">
            <div class="subsec lvl-1">5. Kho·∫£n th∆∞·ªüng kinh doanh xu·∫•t s·∫Øc h√†ng nƒÉm</div>
            <div class="sub-content">
              <ul class="mb-2 list-dot bullet-strong lvl-3">
                <li><span class="thin">T·ªïng s·ªë CC th·ª±c c·∫•p (YTD):</span> <span class="hl">${formatNumber(row["FC.FC CC YTD"])}</span></li>
                <li><span class="thin">T·ªïng FYP ph√°t sinh (YTD):</span> <span class="hl">${fmt(row["FC.FC FYP YTD"], "FC.FC FYP YTD", "T·ªïng FYP ph√°t sinh (YTD)")}</span></li>
            </ul>
            </div>
          </div>
        </div>`;

      const C = `
        <div id="sectionC" class="section hide">
          <div class="section-title">C. B√ÅO C√ÅO CHI TI·∫æT HO·∫†T ƒê·ªòNG TUY·ªÇN D·ª§NG V√Ä H·ªÜ TH·ªêNG</div>

          <div id="c1" class="sub-block">
            <div class="subsec lvl-1">1. Ho·∫°t ƒë·ªông tuy·ªÉn d·ª•ng</div>
            <div class="sub-content">
              <ul class="mb-2 list-dot bullet-strong lvl-3">
                <li><span class="thin">S·ªë l∆∞·ª£ng tuy·ªÉn d·ª•ng tr·ª±c ti·∫øp th√°ng hi·ªán t·∫°i:</span> <span class="hl">${formatNumber(row["RECRUIT T"])}</span></li>
                <li><span class="thin">S·ªë l∆∞·ª£ng tuy·ªÉn d·ª•ng tr·ª±c ti·∫øp active M0:</span> <span class="hl">${formatNumber(row["RECRUIT ACT T"])}</span></li>
            </ul>
            </div>
          </div>

          <div id="c2" class="sub-block hide">
            <div class="subsec lvl-1">2. Theo d√µi thƒÉng c·∫•p</div>
            <div class="sub-content">
              <ul class="mb-2 list-dot bullet-strong lvl-3">
                <li><span class="thin">Ti·∫øn ƒë·ªô thƒÉng l√™n UM (ƒë·ªëi v·ªõi FA):</span> <span class="hl">${addPercent(row["UP % FA TO UM"])}</span></li>
                <li><span class="thin">V·ªã tr√≠ thƒÉng c·∫•p:</span> <span class="hl">${formatNumber(row["UP.TC LEN"])}</span></li>
                <li><span class="thin">K·∫øt qu·∫£ ƒë√°nh gi√°:</span> <span class="hl">${formatNumber(row["UP.KQ DG"])}</span></li>
                <li><span class="thin">Ti·ªÅm nƒÉng thƒÉng c·∫•p:</span> <span class="hl">${formatNumber(row["UP.TIEM NANG TC UM"])}</span></li>
                <li><span class="thin">Theo d√µi c√°c kh√≥a ƒë√†o t·∫°o b·∫Øt bu·ªôc (Y/N):</span></li>
                <li style="margin-left: 20px;">
                SBW: <span class="hl">${formatNumber(row["UP.SBW"])}</span> &nbsp; 
                MS: <span class="hl">${formatNumber(row["UP.MS"])}</span> &nbsp;
                LS: <span class="hl">${formatNumber(row["UP.LS"])}</span> &nbsp;
                COACHING: <span class="hl">${formatNumber(row["UP.COACHING"])}</span>
              </li>
                <li><span class="thin">S·ªë l∆∞·ª£ng NRA v·ªõi 1CC & 4tr FYC c·∫ßn th√™m:</span> <span class="hl">${formatInt(row["UP.CAN TD ACT 4TR FYC L3M"])}</span></li>
                <li><span class="thin">2A S·ªë l∆∞·ª£ng ƒë·∫°i l√Ω c√≤n l√†m vi·ªác Whole team c·∫ßn th√™m:</span> <span class="hl">${formatNumber(row["UP.CAN CA WT"])}</span></li>
                <li><span class="thin">2B S·ªë l∆∞·ª£ng ƒë·∫°i l√Ω c√≤n l√†m vi·ªác v√† c√≥ ‚â• 15tr FYC L3M c·∫ßn th√™m:</span> <span class="hl">${formatNumber(row["UP.CAN CA 15TR L3M"])}</span></li>
                <li><span class="thin">S·ªë l∆∞·ª£ng UM+ b√°o c√°o tr·ª±c ti·∫øp c·∫ßn th√™m:</span> <span class="hl">${formatNumber(row["UP.CAN UM+TT"])}</span></li>
                <li><span class="thin">Ngu·ªìn s·∫£n xu·∫•t c·∫ßn th√™m:</span> <span class="hl">${formatNumber(row["UP.CAN NGUON SX"])}</span></li>
                <li><span class="thin">FYC Whole team L6M sau lu·∫≠t 50% c·∫ßn th√™m:</span> <span class="hl">${fmt(row["UP.CAN FYC WT L6M"], "UP.CAN FYC WT L6M", "FYC Whole team L6M sau lu·∫≠t 50% c·∫ßn th√™m")}</span></li>
            </ul>
            </div>
          </div>

          <div id="c3" class="sub-block hide fa-hide">
            <div class="subsec lvl-1">3. Theo d√µi duy tr√¨ ch·ª©c danh</div>
            <div class="sub-content">
              <div class="thin lvl-2"><strong>ƒê√°nh gi√° t·ª´</strong> <span class="hl">${formatNumber(row["MOC.FROM"])}</span> <strong>ƒë·∫øn</strong> <span class="hl">${formatNumber(row["MOC.TO"])}</span> <strong>c·ªßa k·ª≥ ƒë√°nh gi√° ng√†y</strong> <span class="hl">${formatNumber(row["MOC.IN"])}</span></div>
              <ul class="mb-2 list-dot bullet-strong lvl-3">
                <li><span class="thin">Ch·ª©c danh hi·ªán t·∫°i:</span> <span class="hl">${formatNumber(row["MOC.RANK"])}</span></li>
                <li><span class="thin">Th√°ng t·∫°i ch·ª©c:</span> <span class="hl">${formatNumber(row["MOC.TAI VI"])}</span></li>
                <li><span class="thin">K·∫øt qu·∫£ ƒë√°nh gi√° t·∫°m t√≠nh (Y/N):</span> <span class="hl">${formatNumber(row["MOC.KQ TAM TINH"])}</span></li>
                <li><span class="thin">Theo d√µi c√°c kh√≥a ƒë√†o t·∫°o b·∫Øt bu·ªôc (Y/N):</span></li>
                <li style="margin-left: 20px;">
                MS: <span class="hl">${formatNumber(row["UP.MS"])}</span> &nbsp;
                LS: <span class="hl">${formatNumber(row["UP.LS"])}</span> &nbsp;
                COACHING: <span class="hl">${formatNumber(row["UP.COACHING"])}</span>
              </li>
                <li><span class="thin">S·ªë l∆∞·ª£ng NRA v·ªõi 1CC & 4tr FYC c·∫ßn th√™m:</span> <span class="hl">${formatInt(row["MOC.CAN TD ACT 4TR L6M"])}</span></li>
                <li><span class="thin">S·ªë l∆∞·ª£ng UM+ b√°o c√°o tr·ª±c ti·∫øp c·∫ßn th√™m:</span> <span class="hl">${formatNumber(row["MOC.CAN UM+ TT"])}</span></li>
                <li><span class="thin">FYC Whole team L6M sau lu·∫≠t 50% c·∫ßn th√™m:</span> <span class="hl">${fmt(row["MOC.CAN FYC WT L6M"], "MOC.CAN FYC WT L6M", "FYP Whole team L6M sau lu·∫≠t 50% c·∫ßn th√™m")}</span></li>
                <li><span class="thin">T·ª∑ l·ªá duy tr√¨ P13 c·∫ßn th√™m:</span> <span class="hl">${addPercent(row["MOC.CAN P13 WT"])}</span></li>
            </ul>
            </div>
          </div>

          <div id="c4" class="sub-block hide fa-hide">
            <div class="subsec lvl-1">4. Danh hi·ªáu MBA Pro</div>
            <div class="sub-content">
              <div class="thin mb-1 lvl-2"><strong>Danh hi·ªáu ch√≠nh th·ª©c hi·ªán t·∫°i:</strong> <span class="hl">${formatNumber(row["MBA.DH CT HIEN TAI"])}</span></div>
              <div class="thin mb-1 lvl-2"><strong>Theo d√µi thƒÉng h·∫°ng:</strong></div>
              <ul class="mb-2 list-dot bullet-strong lvl-3">
                <li><span class="thin">Ti·ªÅm nƒÉng thƒÉng h·∫°ng (FYC ‚â• 80% y√™u c·∫ßu h·∫°n ti·∫øp theo):</span> <span class="hl">${fmt(row["MBA.TIEM NANG 80%FYC"], "MBA.TIEM NANG 80%FYC", "FYC c√° nh√¢n UM+ v√† ƒêL tr·ª±c ti·∫øp L12M sau lu·∫≠t 50%")}</span></li>
                <li><span class="thin">S·ªë l∆∞·ª£ng ƒë·∫°i l√Ω ƒë·∫°t chu·∫©n trong qu√Ω:</span> <span class="hl">${formatNumber(row["MBA.TH DL DAT CHUAN TRONG QUY"])}</span></li>
                <li><span class="thin">S·ªë l∆∞·ª£ng ƒë·∫°i l√Ω ƒë·∫°t chu·∫©n trong 2 qu√Ω:</span> <span class="hl">${formatNumber(row["MBA.TH DL DAT CHUAN 2 QUY"])}</span></li>
                <li><span class="thin">FYC c√° nh√¢n UM+ v√† ƒêL tr·ª±c ti·∫øp L12M sau lu·∫≠t 50%:</span> <span class="hl">${fmt(row["MBA.TH FYC TO TT SAU 50"], "MBA.TH FYC TO TT SAU 50", "FYC c√° nh√¢n UM+ v√† ƒêL tr·ª±c ti·∫øp L12M sau lu·∫≠t 50%")}</span></li>
                <li><span class="thin">S·ªë UM+ m·ªõi thƒÉng c·∫•p L12M:</span> <span class="hl">${formatNumber(row["MBA.TH UM+ MOI L12M"])}</span></li>
                <li><span class="thin">P13 c·∫•p b√°o c√°o tr·ª±c ti·∫øp:</span> <span class="hl">${addPercent(row["MBA.TH P13 BCTT"])}</span></li>
                <li><span class="thin">Danh hi·ªáu MBA Pro t·∫°m t√≠nh theo k·∫øt qu·∫£ x√©t thƒÉng h·∫°ng:</span> <span class="hl">${formatNumber(row["MBA.TH DH TAM TINH QUY SAU"])}</span></li>
            </ul>
              <div class="thin mb-1 lvl-2"><strong>Theo d√µi duy tr√¨ h·∫°ng:</strong></div>
              <ul class="mb-2 list-dot bullet-strong lvl-3">
                <li><span class="thin">K·∫øt qu·∫£ x√©t duy tr√¨ t·∫°m t√≠nh:</span> <span class="hl">${formatNumber(row["MBA.KQ DT DH HTAI"])}</span></li>
                <li><span class="thin">S·ªë qu√Ω li√™n t·ª•c gi·ªØ danh hi·ªáu MBA Pro hi·ªán t·∫°i:</span> <span class="hl">${formatNumber(row["MBA.DT SO QUY LIEN TUC"])}</span></li>
                <li><span class="thin">S·ªë l∆∞·ª£ng Manulife Pro c√≥ s·∫£n xu·∫•t trong qu√Ω:</span> <span class="hl">${formatNumber(row["MBA.SO MANPRO ACT TRONG QUY"])}</span></li>
                <li><span class="thin">FYC c√° nh√¢n UM+ v√† ƒêL tr·ª±c ti·∫øp L12M sau lu·∫≠t 50%:</span> <span class="hl">${fmt(row["MBA.TH FYC TO TT SAU 50"], "MBA.TH FYC TO TT SAU 50", "FYC c√° nh√¢n UM+ v√† ƒêL tr·ª±c ti·∫øp L12M sau lu·∫≠t 50%")}</span></li>
                <li><span class="thin">S·ªë UM+ m·ªõi thƒÉng c·∫•p L12M:</span> <span class="hl">${formatNumber(row["MBA.TH UM+ MOI L12M"])}</span></li>
            </ul>
              <div class="thin mb-1 lvl-2"><strong>Danh hi·ªáu t·∫°m t√≠nh qu√Ω sau (sau thƒÉng h·∫°ng & duy tr√¨):</strong> <span class="hl">${formatNumber(row["MBA.DH TAM TINH QUY SAU"])}</span></div>
            </div>
          </div>

          <div id="c5" class="sub-block hide fa-hide">
            <div class="subsec lvl-1">5. Th∆∞·ªüng nƒÉng su·∫•t nh√≥m ∆∞u t√∫ h√†ng th√°ng</div>
            <div class="sub-content">
              <ul class="mb-2 list-dot bullet-strong lvl-3">
                <li><span class="thin">T·ªïng CC ph√°t sinh trong th√°ng c·ªßa b·∫£n th√¢n UM+ (A):</span> <span class="hl">${formatNumber(row["OTEAM.CC UM+"])}</span></li>
                <li><span class="thin">T·ªïng FYP ph√°t sinh trong th√°ng c·ªßa b·∫£n th√¢n UM+ (A):</span> <span class="hl">${fmt(row["OTEAM.FYP UM+"], "OTEAM.FYP UM+", "T·ªïng FYP ph√°t sinh trong th√°ng c·ªßa b·∫£n th√¢n UM+ (A)")}</span></li>
                <li><span class="thin">S·ªë NRA c√≥ ‚â•1CC v√† 15tr FYP L3M c·ªßa b·∫£n th√¢n UM+(A):</span> <span class="hl">${formatInt(row["OTEAM.TDTT ACT"])}</span></li>
                <li><span class="thin">FYP c·ªßa b·∫£n th√¢n UM+ (A) v√† nh√≥m tr·ª±c ti·∫øp sau lu·∫≠t 50%:</span> <span class="hl">${fmt(row["OTEAM.TONG FYP TT"], "OTEAM.TONG FYP TT", "FYP c·ªßa b·∫£n th√¢n UM+ (A) v√† nh√≥m tr·ª±c ti·∫øp sau lu·∫≠t 50%")}</span></li>
                <li><span class="thin">FYP c·ªßa b·∫£n th√¢n UM+ (B) b√°o c√°o tr·ª±c ti·∫øp cho UM+ (A):</span> <span class="hl">${fmt(row["OTEAM.FYP UM+ MOI"], "OTEAM.FYP UM+ MOI", "FYP c·ªßa b·∫£n th√¢n UM+ (B) b√°o c√°o tr·ª±c ti·∫øp cho UM+ (A)")}</span></li>
                <li><span class="thin">T·ªïng FYP sau lu·∫≠t 50% d√πng ƒë·ªÉ t√≠nh th∆∞·ªüng (c·∫•p UM):</span> <span class="hl">${fmt(row["OTEAM.TONG FYP SAU LUAT XET THUONG"], "OTEAM.TONG FYP SAU LUAT XET THUONG", "T·ªïng FYP sau lu·∫≠t 50% d√πng ƒë·ªÉ t√≠nh th∆∞·ªüng (c·∫•p UM)")}</span></li>
                <li><span class="thin">T·ªïng FYP WT tr∆∞·ªõc lu·∫≠t 50% (c·∫•p SUM+):</span> <span class="hl">${fmt(row["OTEAM.FYP WT TRUOC LUAT"], "OTEAM.FYP WT TRUOC LUAT", "T·ªïng FYP WT tr∆∞·ªõc lu·∫≠t 50% (c·∫•p SUM+)")}</span></li>
                <li><span class="thin">T·ªïng FYP WT sau lu·∫≠t 50% ƒë·ªÉ t√≠nh th∆∞·ªüng (c·∫•p SUM+):(2):</span> <span class="hl">${fmt(row["OTEAM.FYP WT SAU LUAT"], "OTEAM.FYP WT SAU LUAT", "T·ªïng FYP WT sau lu·∫≠t 50% ƒë·ªÉ t√≠nh th∆∞·ªüng (c·∫•p SUM+)")}</span></li>
                <li><span class="thin">Y/c v·ªÅ t·ªïng FYP:</span> <span class="hl">${fmt(row["OTEAM.Y/C TONG FYP"], "OTEAM.Y/C TONG FYP", "Y/c v·ªÅ t·ªïng FYP")}</span></li>
                <li><span class="thin">Y/c v·ªÅ b√°n c√° nh√¢n:</span> <span class="hl">${formatNumber(row["OTEAM.Y/C SX CA NHAN"])}</span></li>
                <li><span class="thin">Y/c v·ªÅ tuy·ªÉn c√≥ active:</span> <span class="hl">${formatNumber(row["OTEAM.Y/C TDTT ACT"])}</span></li>
                <li><span class="thin">K·∫øt qu·∫£ ƒë·∫°t th∆∞·ªüng thi ƒëua (Y/N):</span> <span class="hl">${formatNumber(row["OTEAM.DAT THUONG"])}</span></li>
                <li><span class="thin">T·ª∑ l·ªá P13:</span> <span class="hl">${addPercent(row["OTEAM.P13"])}</span></li>
                <li><span class="thin">H·ªá s·ªë nh√¢n TLDTHD:</span> <span class="hl">${formatNumber(row["OTEAM.HE SO THUONG"])}</span></li>
                <li><span class="thin">Th∆∞·ªüng d·ª± t√≠nh sau khi ƒë√£ nh√¢n h·ªá s·ªë TLDTHD:</span> <span class="hl">${fmt(row["OTEAM.TIEN THUONG"], "OTEAM.TIEN THUONG", "Th∆∞·ªüng d·ª± t√≠nh sau khi ƒë√£ nh√¢n h·ªá s·ªë TLDTHD")}</span></li>
            </ul>
            </div>
          </div>
        </div>`;

      reportEl.innerHTML = Info + A + B + C;

      enhanceListLabels();
      coerceNRAIntegers();
    }

    /* ===== NAV / TOC ===== */
    function buildMobileTOC(){
      const sel=document.getElementById('tocSelect'); if(!sel) return; sel.innerHTML='';
      const addOpt=(val,text)=>{ const op=document.createElement('option'); op.value=val; op.textContent=text; sel.appendChild(op); };
      
      // Ki·ªÉm tra ch·ª©c danh c√≥ ph·∫£i FA ho·∫∑c SA kh√¥ng
      const chucDanhEl = document.querySelector('#sectionInfo .info-item .val');
      const chucDanh = chucDanhEl ? String(chucDanhEl.textContent || "").toUpperCase() : "";
      const isFAorSA = chucDanh.includes("FA") || chucDanh.includes("SA") || chucDanh === "FA" || chucDanh === "SA";
      
      addOpt('sectionInfo','Th√¥ng tin ƒë·∫°i l√Ω');
      addOpt('sectionA','A. T·ªïng quan (MTD)');
      addOpt('sectionB#b1','B.1 B√°n h√†ng');
      addOpt('sectionB#b2','B.2 Manulife Pro');
      addOpt('sectionB#b3','B.3 MDRT+');
      addOpt('sectionB#b4','B.4 M-Star / Japan');
      addOpt('sectionB#b5','B.5 Th∆∞·ªüng nƒÉm');
      addOpt('sectionC#c1','C.1 Tuy·ªÉn d·ª•ng');
      addOpt('sectionC#c2','C.2 ThƒÉng c·∫•p');
      if (!isFAorSA) {
      addOpt('sectionC#c3','C.3 Duy tr√¨ ch·ª©c danh');
      addOpt('sectionC#c4','C.4 MBA Pro');
      addOpt('sectionC#c5','C.5 Th∆∞·ªüng nh√≥m ∆∞u t√∫');
      }
      addOpt('openIncome','T√≠nh thu nh·∫≠p (m·ªü tab)');
      sel.addEventListener('change',()=>{ const v=sel.value; if(!v) return; if(v==='openIncome'){ window.open(INCOME_URL,'_blank'); sel.value=''; return; } showSection(v); });
    }

    function bindSidebar(){
      document.querySelectorAll('#sidebar .menu-item').forEach(a=>{
        a.addEventListener('click',e=>{
          const hasData=a.hasAttribute('data-target');
          if(hasData){
            e.preventDefault();
            const base=a.getAttribute('data-target')||'';
            const anchor=a.getAttribute('data-anchor')||'';
            const val=anchor?`${base}${anchor}`:base;
            showSection(val);
          }
          // link ngo√†i (T√çNH THU NH·∫¨P) s·∫Ω ƒë·ªÉ nguy√™n target _blank
        });
      });
    }

    function showSection(value){
      // value d·∫°ng 'sectionB#b2' ho·∫∑c 'sectionA'
      const [sectionId, anchorRaw] = value.split('#');
      const anchor = anchorRaw ? `#${anchorRaw}`.replace('##','#') : '';

      // ·∫®n t·∫•t c·∫£ section
      document.querySelectorAll('#report .section').forEach(sec=>sec.classList.add('hide'));
      const section = document.getElementById(sectionId); if(!section) return;
      section.classList.remove('hide');

      // ·∫®n/hi·ªán c√°c sub-block theo anchor
      section.querySelectorAll('.sub-block').forEach(sb=>sb.classList.remove('hide'));
      if(anchor){
        section.querySelectorAll('.sub-block').forEach(sb=>sb.classList.add('hide'));
        const sub = section.querySelector(anchor);
        if(sub) sub.classList.remove('hide');
      }

      // Active menu b√™n tr√°i
      document.querySelectorAll('#sidebar .menu-item').forEach(el=>el.classList.remove('active'));
      if(!anchor){
        const top=document.querySelector(`#sidebar .menu-item[data-target="${sectionId}"]`);
        if(top) top.classList.add('active');
      } else {
        const sublink=document.querySelector(`#sidebar .menu-item[data-target="${sectionId}"][data-anchor="${anchor}"]`);
        if(sublink) sublink.classList.add('active');
      }

      // ƒê·ªìng b·ªô dropdown mobile (n·∫øu ƒëang hi·ªán)
      const sel=document.getElementById('tocSelect'); 
      if(sel && getComputedStyle(document.getElementById('tocMobile')).display!=='none'){
        sel.value = anchor ? `${sectionId}${anchor}` : sectionId;
      }

      // Scroll t·ªõi ƒë·∫ßu section (b√™n d∆∞·ªõi header + TOC)
      setLayoutVars();
      const headH = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--header-h'))||64;
      const tocH  = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--toc-h'))||0;
      const offset = headH + tocH + 6;
      const y = section.getBoundingClientRect().top + window.scrollY - offset;
      window.scrollTo({ top: Math.max(0,y), behavior:'smooth' });
    }

    /* ===== LOGIN ===== */
    loginBtn.disabled = true; loginBtn.textContent = 'ƒêang t·∫£i d·ªØ li·ªáu...';
    dataReady.finally(()=>{ loginBtn.disabled=false; loginBtn.textContent='ƒêƒÉng nh·∫≠p'; });

    loginForm.addEventListener('submit', async (e)=>{
      e.preventDefault(); showErrorTop(''); await dataReady;
      if (!Array.isArray(dataRows) || dataRows.length===0){ showErrorTop('Kh√¥ng t·∫£i ƒë∆∞·ª£c d·ªØ li·ªáu. H√£y ki·ªÉm tra data.json.'); return; }

      const msdlNorm = normalizeMSDL(msdlInput.value);
      const dateNorm = normalizeDate(dateInput.value);
      const msdlCols = ["MSDL","AGEN CODE","AGENT CODE","Agent Code","M√£ S·ªë ƒê·∫°i L√Ω","M√É S·ªê ƒê·∫†I L√ù"];
      const joinCols = ["JOIN DATE","Join Date","NG√ÄY GIA NH·∫¨P","Ng√†y gia nh·∫≠p"];

      const row = dataRows.find(r => normalizeMSDL(pick(r,msdlCols))===msdlNorm && normalizeDate(pick(r,joinCols))===dateNorm);
      if (!row){ showErrorTop('Kh√¥ng t√¨m th·∫•y ƒë·∫°i l√Ω ph√π h·ª£p v·ªõi th√¥ng tin b·∫°n nh·∫≠p!'); return; }

      // Render & b·∫≠t giao di·ªán
      renderReport(row);
      document.body.classList.remove('logged-out');
      document.body.classList.add('logged-in');
      
      // Ki·ªÉm tra v√† th√™m class is-fa n·∫øu ch·ª©c danh l√† FA ho·∫∑c SA
      const chucDanh = String(row["Ch·ª©c danh"] || "").toUpperCase();
      const isFAorSA = chucDanh.includes("FA") || chucDanh.includes("SA") || chucDanh === "FA" || chucDanh === "SA";
      
      // Debug log
      console.log('Login - Ch·ª©c danh:', row["Ch·ª©c danh"]);
      console.log('Login - isFAorSA:', isFAorSA);
      console.log('Login - Body classes before:', document.body.className);
      
      if (isFAorSA) {
        document.body.classList.add('is-fa-or-sa');
      } else {
        document.body.classList.remove('is-fa-or-sa');
      }
      
      console.log('Login - Body classes after:', document.body.className);
      
      applySidebarMode();
      buildMobileTOC();
      showSection('sectionInfo');     // m·∫∑c ƒë·ªãnh v√†o m·ª•c Th√¥ng tin ƒë·∫°i l√Ω
      setLayoutVars();
      
      // C·∫≠p nh·∫≠t ng√†y c·∫≠p nh·∫≠t trong sidebar
      const sidebarUpdateDate = document.getElementById('sidebarUpdateDate');
      if (sidebarUpdateDate && row["NGAY CHOT DATA"]) {
        sidebarUpdateDate.textContent = `C·∫≠p nh·∫≠t: ${row["NGAY CHOT DATA"]}`;
      }
      
      // C·∫≠p nh·∫≠t ng√†y c·∫≠p nh·∫≠t trong mobile TOC
      const mobileUpdateDate = document.getElementById('mobileUpdateDate');
      if (mobileUpdateDate && row["NGAY CHOT DATA"]) {
        mobileUpdateDate.textContent = `C·∫≠p nh·∫≠t: ${row["NGAY CHOT DATA"]}`;
        mobileUpdateDate.style.display = 'block';
      }

      // Reset input
      msdlInput.value=''; dateInput.value=''; msdlInput.blur(); dateInput.blur();
    });

    logoutBtn.addEventListener('click', ()=>{ location.reload(); });

    /* ===== INIT ===== */
    function init(){ setLayoutVars(); applySidebarMode(); bindSidebar(); window.addEventListener('resize', ()=>{ setLayoutVars(); applySidebarMode(); }); }
    window.addEventListener('load', init);
  </script>
</body>
</html>
